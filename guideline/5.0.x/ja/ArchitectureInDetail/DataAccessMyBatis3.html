<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>5.2. データベースアクセス（MyBatis3編） &mdash; TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.1.0-SNAPSHOT documentation</title>
    
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '5.1.0-SNAPSHOT',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.1.0-SNAPSHOT documentation" href="../index.html" />
    <link rel="up" title="5. TERASOLUNA Server Framework for Java (5.x)の機能詳細" href="index.html" />
    <link rel="next" title="5.3. データベースアクセス（JPA編）" href="DataAccessJpa.html" />
    <link rel="prev" title="5.1. データベースアクセス（共通編）" href="DataAccessCommon.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="DataAccessJpa.html" title="5.3. データベースアクセス（JPA編）"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="DataAccessCommon.html" title="5.1. データベースアクセス（共通編）"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.1.0-SNAPSHOT documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">5. TERASOLUNA Server Framework for Java (5.x)の機能詳細</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">5.2. データベースアクセス（MyBatis3編）</a><ul>
<li><a class="reference internal" href="#overview">5.2.1. Overview</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3overviewaboutmybatis3">5.2.1.1. MyBatis3について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatis3">5.2.1.1.1. MyBatis3のコンポーネント構成について</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mybatis3spring">5.2.1.2. MyBatis3とSpringの連携について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatisspring">5.2.1.2.1. MyBatis-Springのコンポーネント構成について</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">5.2.2. How to use</a><ul>
<li><a class="reference internal" href="#pom-xml">5.2.2.1. pom.xmlの設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingscooperatewithmybatis3andspring">5.2.2.2. MyBatis3とSpringを連携するための設定</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsdatasource">5.2.2.2.1. データソースの設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingstransactionmanager">5.2.2.2.2. トランザクション管理の設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsmybatis-spring">5.2.2.2.3. MyBatis-Springの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsmybatis3">5.2.2.3. MyBatis3の設定</a><ul>
<li><a class="reference internal" href="#sql">5.2.2.3.1. SQL実行モードの設定</a></li>
<li><a class="reference internal" href="#typealias">5.2.2.3.2. TypeAliasの設定</a></li>
<li><a class="reference internal" href="#nulljdbc">5.2.2.3.3. NULL値とJDBC型のマッピング設定</a></li>
<li><a class="reference internal" href="#typehandler">5.2.2.3.4. TypeHandlerの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtodababaseaccess">5.2.2.4. データベースアクセス処理の実装</a><ul>
<li><a class="reference internal" href="#repository">5.2.2.4.1. Repositoryインタフェースの作成</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtodababaseaccesscreatemappingfile">5.2.2.4.2. マッピングファイルの作成</a></li>
<li><a class="reference internal" href="#crud">5.2.2.4.3. CRUD処理の実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#javabean">5.2.2.5. 検索結果とJavaBeanのマッピング方法</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseresultmappingbyauto">5.2.2.5.1. 検索結果の自動マッピング</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseresultmappingbymanual">5.2.2.5.2. 検索結果の手動マッピング</a></li>
</ul>
</li>
<li><a class="reference internal" href="#entity">5.2.2.6. Entityの検索処理</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefindone">5.2.2.6.1. 単一キーのEntityの取得</a></li>
<li><a class="reference internal" href="#id26">5.2.2.6.2. 複合キーのEntityの取得</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefindmultiple">5.2.2.6.3. Entityの検索</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecount">5.2.2.6.4. Entityの件数の取得</a></li>
<li><a class="reference internal" href="#entity-mybatis3">5.2.2.6.5. Entityのページネーション検索(MyBatis3標準方式)</a></li>
<li><a class="reference internal" href="#entity-sql">5.2.2.6.6. Entityのページネーション検索(SQL絞り込み方式)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecreate">5.2.2.7. Entityの登録処理</a><ul>
<li><a class="reference internal" href="#entity1">5.2.2.7.1. Entityの1件登録</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousegenid">5.2.2.7.2. キーの生成</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecreatemultiple">5.2.2.7.3. Entityの一括登録</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdate">5.2.2.8. Entityの更新処理</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdateone">5.2.2.8.1. Entityの1件更新</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdatemultiple">5.2.2.8.2. Entityの一括更新</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedelete">5.2.2.9. Entityの削除処理</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedeleteone">5.2.2.9.1. Entityの1件削除</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedeletemultiple">5.2.2.9.2. Entityの一括削除</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedynamicsql">5.2.2.10. 動的SQLの実装</a><ul>
<li><a class="reference internal" href="#if">5.2.2.10.1. if要素の実装</a></li>
<li><a class="reference internal" href="#choose">5.2.2.10.2. choose要素の実装</a></li>
<li><a class="reference internal" href="#where">5.2.2.10.3. where要素の実装</a></li>
<li><a class="reference internal" href="#set">5.2.2.10.4. set要素の実装例</a></li>
<li><a class="reference internal" href="#foreach">5.2.2.10.5. foreach要素の実装例</a></li>
<li><a class="reference internal" href="#bind">5.2.2.10.6. bind要素の実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#like">5.2.2.11. LIKE検索時のエスケープ</a></li>
<li><a class="reference internal" href="#sql-injection">5.2.2.12. SQL Injection対策</a><ul>
<li><a class="reference internal" href="#id44">5.2.2.12.1. バインド変数を使って埋め込む方法</a></li>
<li><a class="reference internal" href="#id45">5.2.2.12.2. 置換変数を使って埋め込む方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">5.2.3. How to extend</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendsqlshare">5.2.3.1. SQL文の共有</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendtypehandler">5.2.3.2. TypeHandlerの実装</a><ul>
<li><a class="reference internal" href="#blobtypehandler">5.2.3.2.1. BLOB用のTypeHandlerの実装</a></li>
<li><a class="reference internal" href="#clobtypehandler">5.2.3.2.2. CLOB用のTypeHandlerの実装</a></li>
<li><a class="reference internal" href="#joda-timetypehandler">5.2.3.2.3. Joda-Time用のTypeHandlerの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resulthandler">5.2.3.3. ResultHandlerの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortype">5.2.3.4. SQL実行モードの利用</a><ul>
<li><a class="reference internal" href="#preparedstatement">5.2.3.4.1. PreparedStatement再利用モードの利用</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatch">5.2.3.4.2. バッチモードの利用</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchindividualsetting">5.2.3.4.2.1. 個別にバッチモードのRepositoryを作成するための設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchbulksetting">5.2.3.4.2.2. 一括でバッチモードのRepositoryを作成するための設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchusage">5.2.3.4.2.3. バッチモードのRepositoryの使用例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotes">5.2.3.4.3. バッチモードのRepository利用時の注意点</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesupdateresult">5.2.3.4.3.1. 更新結果の判定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesduplicate">5.2.3.4.3.2. 一意制約違反の検知方法</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesmethodcallorder">5.2.3.4.3.3. Repositoryのメソッドの呼び出し順番</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendstoredprocedure">5.2.3.5. ストアドプロシージャの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">5.2.4. Appendix</a><ul>
<li><a class="reference internal" href="#mapper">5.2.4.1. Mapperインタフェースの仕組みについて</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixsettingstypealias">5.2.4.2. TypeAliasの設定</a><ul>
<li><a class="reference internal" href="#id60">5.2.4.2.1. TypeAliasをクラス単位に設定</a></li>
<li><a class="reference internal" href="#id61">5.2.4.2.2. デフォルトで付与されるエイリアス名の上書き</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixswitchingsqlbydatabase">5.2.4.3. データベースによるSQL切替について</a></li>
<li><a class="reference internal" href="#entity1sql">5.2.4.4. 関連Entityを１回のSQLで取得する方法について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncetable">5.2.4.4.1. テーブルレイアウトとデータ</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatonceentity">5.2.4.4.2. Entityのクラス図</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncerepository">5.2.4.4.3. Repositoryインタフェースの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncesql">5.2.4.4.4. SQLの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncemapping">5.2.4.4.5. マッピングの実装</a><ul>
<li><a class="reference internal" href="#order">5.2.4.4.5.1. Orderオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#orderstatus">5.2.4.4.5.2. OrderStatusオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#orderitem">5.2.4.4.5.3. OrderItemオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#item">5.2.4.4.5.4. Itemオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#category">5.2.4.4.5.5. Categoryオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#ordercoupon">5.2.4.4.5.6. OrderCouponオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#coupon">5.2.4.4.5.7. Couponオブジェクトへのマッピングの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatonceobject">5.2.4.4.5.8. マッピング後のオブジェクト図</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#entitysql">5.2.4.5. 関連EntityをネストしたSQLを使用して取得する方法について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3appendixnestedselectmapping">5.2.4.5.1. 関連EntityをネストしたSQLを使用して取得する実装例</a></li>
<li><a class="reference internal" href="#entitylazy-load">5.2.4.5.2. 関連EntityをLazy Loadするための設定</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3appendixnestedselectlazysettinglibrary">5.2.4.5.2.1. バイトコード操作ライブラリの追加</a></li>
<li><a class="reference internal" href="#lazy-loadmybatis">5.2.4.5.2.2. Lazy Loadを使用するためのMyBatisの設定</a></li>
<li><a class="reference internal" href="#lazy-load">5.2.4.5.2.3. Lazy Loadの実行タイミングを制御するための設定</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="DataAccessCommon.html"
                        title="previous chapter">5.1. データベースアクセス（共通編）</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="DataAccessJpa.html"
                        title="next chapter">5.3. データベースアクセス（JPA編）</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/ArchitectureInDetail/DataAccessMyBatis3.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="mybatis3">
<h1>5.2. データベースアクセス（MyBatis3編）<a class="headerlink" href="#mybatis3" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id73">Overview</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3overviewaboutmybatis3" id="id74">MyBatis3について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatis3" id="id75">MyBatis3のコンポーネント構成について</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mybatis3spring" id="id76">MyBatis3とSpringの連携について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatisspring" id="id77">MyBatis-Springのコンポーネント構成について</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id78">How to use</a><ul>
<li><a class="reference internal" href="#pom-xml" id="id79">pom.xmlの設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingscooperatewithmybatis3andspring" id="id80">MyBatis3とSpringを連携するための設定</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsdatasource" id="id81">データソースの設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingstransactionmanager" id="id82">トランザクション管理の設定</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsmybatis-spring" id="id83">MyBatis-Springの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsmybatis3" id="id84">MyBatis3の設定</a><ul>
<li><a class="reference internal" href="#sql" id="id85">SQL実行モードの設定</a></li>
<li><a class="reference internal" href="#typealias" id="id86">TypeAliasの設定</a></li>
<li><a class="reference internal" href="#nulljdbc" id="id87">NULL値とJDBC型のマッピング設定</a></li>
<li><a class="reference internal" href="#typehandler" id="id88">TypeHandlerの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtodababaseaccess" id="id89">データベースアクセス処理の実装</a><ul>
<li><a class="reference internal" href="#repository" id="id90">Repositoryインタフェースの作成</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtodababaseaccesscreatemappingfile" id="id91">マッピングファイルの作成</a></li>
<li><a class="reference internal" href="#crud" id="id92">CRUD処理の実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#javabean" id="id93">検索結果とJavaBeanのマッピング方法</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseresultmappingbyauto" id="id94">検索結果の自動マッピング</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseresultmappingbymanual" id="id95">検索結果の手動マッピング</a></li>
</ul>
</li>
<li><a class="reference internal" href="#entity" id="id96">Entityの検索処理</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefindone" id="id97">単一キーのEntityの取得</a></li>
<li><a class="reference internal" href="#id26" id="id98">複合キーのEntityの取得</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefindmultiple" id="id99">Entityの検索</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecount" id="id100">Entityの件数の取得</a></li>
<li><a class="reference internal" href="#entity-mybatis3" id="id101">Entityのページネーション検索(MyBatis3標準方式)</a></li>
<li><a class="reference internal" href="#entity-sql" id="id102">Entityのページネーション検索(SQL絞り込み方式)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecreate" id="id103">Entityの登録処理</a><ul>
<li><a class="reference internal" href="#entity1" id="id104">Entityの1件登録</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousegenid" id="id105">キーの生成</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecreatemultiple" id="id106">Entityの一括登録</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdate" id="id107">Entityの更新処理</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdateone" id="id108">Entityの1件更新</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdatemultiple" id="id109">Entityの一括更新</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedelete" id="id110">Entityの削除処理</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedeleteone" id="id111">Entityの1件削除</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedeletemultiple" id="id112">Entityの一括削除</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedynamicsql" id="id113">動的SQLの実装</a><ul>
<li><a class="reference internal" href="#if" id="id114">if要素の実装</a></li>
<li><a class="reference internal" href="#choose" id="id115">choose要素の実装</a></li>
<li><a class="reference internal" href="#where" id="id116">where要素の実装</a></li>
<li><a class="reference internal" href="#set" id="id117">set要素の実装例</a></li>
<li><a class="reference internal" href="#foreach" id="id118">foreach要素の実装例</a></li>
<li><a class="reference internal" href="#bind" id="id119">bind要素の実装例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#like" id="id120">LIKE検索時のエスケープ</a></li>
<li><a class="reference internal" href="#sql-injection" id="id121">SQL Injection対策</a><ul>
<li><a class="reference internal" href="#id44" id="id122">バインド変数を使って埋め込む方法</a></li>
<li><a class="reference internal" href="#id45" id="id123">置換変数を使って埋め込む方法</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id124">How to extend</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendsqlshare" id="id125">SQL文の共有</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendtypehandler" id="id126">TypeHandlerの実装</a><ul>
<li><a class="reference internal" href="#blobtypehandler" id="id127">BLOB用のTypeHandlerの実装</a></li>
<li><a class="reference internal" href="#clobtypehandler" id="id128">CLOB用のTypeHandlerの実装</a></li>
<li><a class="reference internal" href="#joda-timetypehandler" id="id129">Joda-Time用のTypeHandlerの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resulthandler" id="id130">ResultHandlerの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortype" id="id131">SQL実行モードの利用</a><ul>
<li><a class="reference internal" href="#preparedstatement" id="id132">PreparedStatement再利用モードの利用</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatch" id="id133">バッチモードの利用</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotes" id="id134">バッチモードのRepository利用時の注意点</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendstoredprocedure" id="id135">ストアドプロシージャの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id136">Appendix</a><ul>
<li><a class="reference internal" href="#mapper" id="id137">Mapperインタフェースの仕組みについて</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixsettingstypealias" id="id138">TypeAliasの設定</a><ul>
<li><a class="reference internal" href="#id60" id="id139">TypeAliasをクラス単位に設定</a></li>
<li><a class="reference internal" href="#id61" id="id140">デフォルトで付与されるエイリアス名の上書き</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixswitchingsqlbydatabase" id="id141">データベースによるSQL切替について</a></li>
<li><a class="reference internal" href="#entity1sql" id="id142">関連Entityを１回のSQLで取得する方法について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncetable" id="id143">テーブルレイアウトとデータ</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatonceentity" id="id144">Entityのクラス図</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncerepository" id="id145">Repositoryインタフェースの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncesql" id="id146">SQLの実装</a></li>
<li><a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncemapping" id="id147">マッピングの実装</a></li>
</ul>
</li>
<li><a class="reference internal" href="#entitysql" id="id148">関連EntityをネストしたSQLを使用して取得する方法について</a><ul>
<li><a class="reference internal" href="#dataaccessmybatis3appendixnestedselectmapping" id="id149">関連EntityをネストしたSQLを使用して取得する実装例</a></li>
<li><a class="reference internal" href="#entitylazy-load" id="id150">関連EntityをLazy Loadするための設定</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<span id="dataaccessmybatis3overview"></span><h2><a class="toc-backref" href="#id73">5.2.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本節では、<a class="reference external" href="http://mybatis.org">MyBatis3</a>を使用してデータベースにアクセスする方法について説明する。</p>
<p>本ガイドラインでは、MyBatis3のMapperインタフェースをRepositoryインタフェースとして使用することを前提としている。
Repositoryインタフェースについては、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#repository-label"><em>Repositoryの実装</em></a>」を参照されたい。</p>
<div class="line-block">
<div class="line">Overviewでは、MyBatis3とMyBatis-Springを使用してデータベースアクセスする際のアーキテクチャについて説明を行う。</div>
<div class="line">実際の使用方法については、「<a class="reference internal" href="#dataaccessmybatis3howtouse"><em>How to use</em></a>」を参照されたい。</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/DataAccessMyBatis3Scope.png"><img alt="Scope of description" src="../_images/DataAccessMyBatis3Scope.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - Scope of description</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3overviewaboutmybatis3">
<span id="id3"></span><h3><a class="toc-backref" href="#id74">5.2.1.1. MyBatis3について</a><a class="headerlink" href="#dataaccessmybatis3overviewaboutmybatis3" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">MyBatis3は、O/R Mapperの一つだが、データベースで管理されているレコードとオブジェクトをマッピングするという考え方ではなく、
SQLとオブジェクトをマッピングするという考え方で開発されたO/R Mapperである。</div>
<div class="line">そのため、正規化されていないデータベースへアクセスする場合や、発行するSQLをO/R Mapperに任せずに、
アプリケーション側で完全に制御したい場合に有効なO/R Mapperである。</div>
</div>
<p>本ガイドラインでは、MyBatis3から追加されたMapperインタフェースを使用して、EntityのCRUD操作を行う。
Mapperインタフェースの詳細については、「<a class="reference internal" href="#dataaccessmybatis3appendixaboutmappermechanism"><em>Mapperインタフェースの仕組みについて</em></a>」を参照されたい。</p>
<p>本ガイドラインでは、MyBatis3の全ての機能の使用方法について説明を行うわけではないため、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/">MyBatis 3 REFERENCE DOCUMENTATION</a> 」も合わせて参照して頂きたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3overviewaboutcomponentconstitutionofmybatis3">
<span id="id4"></span><h4><a class="toc-backref" href="#id75">5.2.1.1.1. MyBatis3のコンポーネント構成について</a><a class="headerlink" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatis3" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">MyBatis3の主要なコンポーネント(設定ファイル)について説明する。</div>
<div class="line">MyBatis3では、設定ファイルの定義に基づき、以下のコンポーネントが互いに連携する事によって、SQLの実行及びO/Rマッピングを実現している。</div>
</div>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">コンポーネント/設定ファイル</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>MyBatis設定ファイル</td>
<td><p class="first">MyBatis3の動作設定を記載するXMLファイル。</p>
<p class="last">データベースの接続先、マッピングファイルのパス、MyBatisの動作設定などを記載するファイルである。
Springと連携して使用する場合は、データベースの接続先やマッピングファイルのパスの設定を本設定ファイルに指定する必要がないため、
MyBatis3のデフォルトの動作を変更又は拡張する際に、設定を行う事になる。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">org.apache.ibatis.session.</span></tt>
<tt class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></tt></td>
<td><p class="first">MyBatis設定ファイルを読込み、<tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> を生成するためのコンポーネント。</p>
<p class="last">Springと連携して使用する場合は、アプリケーションのクラスから本コンポーネントを直接扱うことはない。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">org.apache.ibatis.session.</span></tt>
<tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt></td>
<td><p class="first"><tt class="docutils literal"><span class="pre">SqlSession</span></tt> を生成するためのコンポーネント。</p>
<p class="last">Springと連携して使用する場合は、アプリケーションのクラスから本コンポーネントを直接扱うことはない。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">org.apache.ibatis.session.</span></tt>
<tt class="docutils literal"><span class="pre">SqlSession</span></tt></td>
<td><p class="first">SQLの発行やトランザクション制御のAPIを提供するコンポーネント。</p>
<p>MyBatis3を使ってデータベースにアクセスする際に、もっとも重要な役割を果たすコンポーネントである。</p>
<p class="last">Springと連携して使用する場合は、アプリケーションのクラスから本コンポーネントを直接扱うことは、基本的にはない。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>Mapperインタフェース</td>
<td><p class="first">マッピングファイルに定義したSQLをタイプセーフに呼び出すためのインタフェース。</p>
<p class="last">Mapperインターフェースに対する実装クラスは、MyBatis3が自動で生成するため、開発者はインターフェースのみ作成すればよい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>マッピングファイル</td>
<td>SQLとO/Rマッピングの設定を記載するXMLファイル。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">以下に、MyBatis3の主要コンポーネントが、どのような流れでデータベースにアクセスしているのかを説明する。</div>
<div class="line">データベースにアクセスするための処理は、大きく２つにわける事ができる。</div>
</div>
<ul class="simple">
<li>アプリケーションの起動時に行う処理。下記(1)～(3)の処理が、これに該当する。</li>
<li>クライアントからのリクエスト毎に行う処理。下記(4)～(10)の処理が、これに該当する。</li>
</ul>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/DataAccessMyBatis3RelationshipOfComponents.png"><img alt="Relationship of MyBatis3 components" src="../_images/DataAccessMyBatis3RelationshipOfComponents.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - Relationship of MyBatis3 components</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">アプリケーションの起動時に行う処理は、以下の流れで実行する。</div>
<div class="line">Springと連携時の流れについては、「<a class="reference internal" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatisspring"><em>MyBatis-Springのコンポーネント構成について</em></a>」を参照されたい。</div>
</div>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>アプリケーションは、<tt class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></tt> に対して <tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> の構築を依頼する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></tt> は、 <tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> を生成するためにMyBatis設定ファイルを読込む。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></tt> は、MyBatis設定ファイルの定義に基づき <tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> を生成する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">クライアントからのリクエスト毎に行う処理は、以下の流れで実行する。</div>
<div class="line">Springと連携時の流れについては、「<a class="reference internal" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatisspring"><em>MyBatis-Springのコンポーネント構成について</em></a>」を参照されたい。</div>
</div>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>クライアントは、アプリケーションに対して処理を依頼する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>アプリケーションは、 <tt class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></tt> によって構築された <tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> から <tt class="docutils literal"><span class="pre">SqlSession</span></tt> を取得する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> は、<tt class="docutils literal"><span class="pre">SqlSession</span></tt> を生成しアプリケーションに返却する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>アプリケーションは、 <tt class="docutils literal"><span class="pre">SqlSession</span></tt> からMapperインタフェースの実装オブジェクトを取得する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td><p class="first">アプリケーションは、Mapperインタフェースのメソッドを呼び出す。</p>
<p class="last">Mapperインタフェースの仕組みについては、「<a class="reference internal" href="#dataaccessmybatis3appendixaboutmappermechanism"><em>Mapperインタフェースの仕組みについて</em></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td>Mapperインタフェースの実装オブジェクトは、 <tt class="docutils literal"><span class="pre">SqlSession</span></tt> のメソッドを呼び出して、SQLの実行を依頼する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="10">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">SqlSession</span></tt> は、マッピングファイルから実行するSQLを取得し、SQLを実行する。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>トランザクション制御について</strong></p>
<p>上記フローには記載していないが、トランザクションのコミット及びロールバックは、
アプリケーションのコードから<tt class="docutils literal"><span class="pre">SqlSession</span></tt> のAPIを直接呼び出して行う。</p>
<p class="last">ただし、Springと連携する場合は、Springのトランザクション管理機能がコミット及びロールバックを行うため、
アプリケーションのクラスから<tt class="docutils literal"><span class="pre">SqlSession</span></tt> のトランザクションを制御するためのAPIを直接呼び出すことはない。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="mybatis3spring">
<span id="dataaccessmybatis3overviewaboutmybatisspring"></span><h3><a class="toc-backref" href="#id76">5.2.1.2. MyBatis3とSpringの連携について</a><a class="headerlink" href="#mybatis3spring" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">MyBatis3とSpringを連携させるライブラリとして、MyBatisから<a class="reference external" href="http://mybatis.github.io/spring/">MyBatis-Spring</a> というライブラリが提供されている。</div>
<div class="line">このライブラリを使用することで、MyBatis3のコンポーネントをSpringのDIコンテナ上で管理する事ができる。</div>
</div>
<p>MyBatis-Springを使用すると、</p>
<ul class="simple">
<li>MyBatis3のSQLの実行をSpringが管理しているトランザクション内で行う事ができるため、MyBatis3のAPIに依存したトランザクション制御を行う必要がない。</li>
<li>MyBatis3の例外は、Springが用意している汎用的な例外(<tt class="docutils literal"><span class="pre">org.springframework.dao.DataAccessException</span></tt> )へ変換されるため、MyBatis3のAPIに依存しない例外処理を実装する事ができる。</li>
<li>MyBatis3を使用するための初期化処理は、すべてMyBatis-SpringのAPIが行ってくれるため、基本的にはMyBatis3のAPIを直接使用する必要がない。</li>
<li>スレッドセーフなMapperオブジェクトの生成が行えるため、シングルトンのServiceクラスにMapperオブジェクトを注入する事ができる。</li>
</ul>
<p>等のメリットがある。
本ガイドラインでは、MyBatis-Springを使用することを前提とする。</p>
<p>本ガイドラインでは、MyBatis-Springの全ての機能の使用方法について説明を行うわけではないため、
「<a class="reference external" href="http://mybatis.github.io/spring/">Mybatis-Spring REFERENCE DOCUMENTATION</a> 」も合わせて参照して頂きたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3overviewaboutcomponentconstitutionofmybatisspring">
<span id="id5"></span><h4><a class="toc-backref" href="#id77">5.2.1.2.1. MyBatis-Springのコンポーネント構成について</a><a class="headerlink" href="#dataaccessmybatis3overviewaboutcomponentconstitutionofmybatisspring" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">MyBatis-Springの主要なコンポーネントについて説明する。</div>
<div class="line">MyBatis-Springでは、以下のコンポーネントが連携する事によって、MyBatis3とSpringの連携を実現している。</div>
</div>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">コンポーネント/設定ファイル</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">org.mybatis.spring.</span></tt>
<tt class="docutils literal"><span class="pre">SqlSessionFactoryBean</span></tt></td>
<td><p class="first"><tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> を構築し、SpringのDIコンテナ上にオブジェクトを格納するためのコンポーネント。</p>
<p class="last">MyBatis3標準では、MyBatis設定ファイルに定義されている情報を基に<tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> を構築するが、
<tt class="docutils literal"><span class="pre">SqlSessionFactoryBean</span></tt> を使用すると、MyBatis設定ファイルがなくても<tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> を構築することができる。
もちろん、併用することも可能である。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">org.mybatis.spring.mapper.</span></tt>
<tt class="docutils literal"><span class="pre">MapperFactoryBean</span></tt></td>
<td><p class="first">シングルトンのMapperオブジェクトを構築し、SpringのDIコンテナ上にオブジェクトを格納するためのコンポーネント。</p>
<p class="last">MyBatis3標準の仕組みで生成されるMapperオブジェクトはスレッドセーフではないため、
スレッド毎にインスタンスを割り当てる必要があった。
MyBatis-Springのコンポーネントで作成されたMapperオブジェクトは、
スレッドセーフなMapperオブジェクトを生成する事ができるため、ServiceなどのシングルトンのコンポーネントにDIすることが可能となる。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">org.mybatis.spring.</span></tt>
<tt class="docutils literal"><span class="pre">SqlSessionTemplate</span></tt></td>
<td><p class="first"><tt class="docutils literal"><span class="pre">SqlSession</span></tt> インターフェースを実装したシングルトン版の<tt class="docutils literal"><span class="pre">SqlSession</span></tt> コンポーネント。</p>
<p>MyBatis3標準の仕組みで生成される<tt class="docutils literal"><span class="pre">SqlSession</span></tt> オブジェクトはスレッドセーフではないため、
スレッド毎にインスタンスを割り当てる必要があった。
MyBatis-Springのコンポーネントで作成された<tt class="docutils literal"><span class="pre">SqlSession</span></tt> オブジェクトは、
スレッドセーフな<tt class="docutils literal"><span class="pre">SqlSession</span></tt> オブジェクトが生成されるため、ServiceなどのシングルトンのコンポーネントにDIすることが可能になる。</p>
<p class="last">ただし、本ガイドラインでは、<tt class="docutils literal"><span class="pre">SqlSession</span></tt> を直接扱う事は想定していない。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に、MyBatis-Springの主要コンポーネントが、どのような流れでデータベースにアクセスしているのかを説明する。
データベースにアクセスするための処理は、大きく２つにわける事ができる。</p>
<ul class="simple">
<li>アプリケーションの起動時に行う処理。下記(1)～(4)の処理が、これに該当する。</li>
<li>クライアントからのリクエスト毎に行う処理。下記(5)～(11)の処理が、これに該当する。</li>
</ul>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/DataAccessMyBatisSpringRelationshipOfComponents.png"><img alt="Relationship of MyBatis-Spring components" src="../_images/DataAccessMyBatisSpringRelationshipOfComponents.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - Relationship of MyBatis-Spring components</strong></p>
</div>
</div></blockquote>
<p>アプリケーションの起動時に行う処理は、以下の流れで実行される。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">SqlSessionFactoryBean</span></tt> は、<tt class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></tt> に対して <tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> の構築を依頼する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></tt> は、 <tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> を生成するためにMyBatis設定ファイルを読込む。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">SqlSessionFactoryBuilder</span></tt> は、MyBatis設定ファイルの定義に基づき <tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> を生成する。</p>
<p class="last">生成された<tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> は、SpringのDIコンテナによって管理される。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">MapperFactoryBean</span></tt> は、スレッドセーフな<tt class="docutils literal"><span class="pre">SqlSession</span></tt> (<tt class="docutils literal"><span class="pre">SqlSessionTemplate</span></tt> )と、
スレッドセーフなMapperオブジェクト(MapperインタフェースのProxyオブジェクト)を生成する。</p>
<p class="last">生成されたMapperオブジェクトは、SpringのDIコンテナによって管理され、ServiceクラスなどにDIされる。
Mapperオブジェクトは、スレッドセーフな<tt class="docutils literal"><span class="pre">SqlSession</span></tt> (<tt class="docutils literal"><span class="pre">SqlSessionTemplate</span></tt> )を利用することで、スレッドセーフな実装を提供している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>クライアントからのリクエスト毎に行う処理は、以下の流れで実行される。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>クライアントは、アプリケーションに対して処理を依頼する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><p class="first">アプリケーション(Service)は、 DIコンテナによって注入されたMapperオブジェクト(Mapperインターフェースを実装したProxyオブジェクト)のメソッドを呼び出す。</p>
<p class="last">Mapperインタフェースの仕組みについては、 「<a class="reference internal" href="#dataaccessmybatis3appendixaboutmappermechanism"><em>Mapperインタフェースの仕組みについて</em></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>Mapperオブジェクトは、呼び出されたメソッドに対応する<tt class="docutils literal"><span class="pre">SqlSession</span></tt> (<tt class="docutils literal"><span class="pre">SqlSessionTemplate</span></tt> )のメソッドを呼び出す。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">SqlSession</span></tt> (<tt class="docutils literal"><span class="pre">SqlSessionTemplate</span></tt> )は、Proxy化されたスレッドセーフな<tt class="docutils literal"><span class="pre">SqlSession</span></tt> のメソッドを呼び出す。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td><p class="first">Proxy化されたスレッドセーフな<tt class="docutils literal"><span class="pre">SqlSession</span></tt> は、トランザクションに割り当てられているMyBatis3標準の<tt class="docutils literal"><span class="pre">SqlSession</span></tt> を使用する。</p>
<p class="last">トランザクションに割り当てられている<tt class="docutils literal"><span class="pre">SqlSession</span></tt> が存在しない場合は、MyBatis3標準の<tt class="docutils literal"><span class="pre">SqlSession</span></tt> を取得するために、
<tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> のメソッドを呼び出す。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="10">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> は、MyBatis3標準の<tt class="docutils literal"><span class="pre">SqlSession</span></tt> を返却する。</p>
<p class="last">返却されたMyBatis3標準の<tt class="docutils literal"><span class="pre">SqlSession</span></tt> はトランザクションに割り当てられるため、同一トランザクション内であれば、新たに生成されることはなく、
同じ<tt class="docutils literal"><span class="pre">SqlSession</span></tt> が使用される仕組みになっている。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="11">
<li></li>
</ol>
</td>
<td>MyBatis3標準の<tt class="docutils literal"><span class="pre">SqlSession</span></tt> は、マッピングファイルから実行するSQLを取得し、SQLを実行する。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>トランザクション制御について</strong></p>
<p>上記フローには記載していないが、トランザクションのコミット及びロールバックは、Springのトランザクション管理機能が行う。</p>
<p class="last">Springのトランザクション管理機能を使用したトランザクション管理方法については、
「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#service-transaction-management"><em>トランザクション管理について</em></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<span id="dataaccessmybatis3howtouse"></span><h2><a class="toc-backref" href="#id78">5.2.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>ここからは、実際にMyBatis3を使用して、データベースにアクセスするための設定及び実装方法について、説明する。</p>
<p>以降の説明は、大きく以下に分類する事ができる。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">分類</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>アプリケーション全体の設定</td>
<td><p class="first">MyBatis3をアプリケーションで使用するための設定方法や、
MyBatis3の動作を変更するための設定方法について記載している。</p>
<p>ここに記載している内容は、<strong>プロジェクト立ち上げ時にアプリケーションアーキテクトが設定を行う時に必要となる。</strong>そのため、基本的にはアプリケーション開発者が個々に意識する必要はない部分である。</p>
<p>以下のセクションが、この分類に該当する。</p>
<ul class="simple">
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingspomxml"><em>pom.xmlの設定</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingscooperatewithmybatis3andspring"><em>MyBatis3とSpringを連携するための設定</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesettingsmybatis3"><em>MyBatis3の設定</em></a></li>
</ul>
<p class="last"><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、
上記で説明している設定の多くが既に設定済みの状態となっているため、アプリケーションアーキテクトは、
プロジェクト特性を判断し、必要に応じて設定の追加及び変更を行うことになる。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>データアクセス処理の実装方法</td>
<td><p class="first">MyBatis3を使った基本的なデータアクセス処理の実装方法について記載している。</p>
<p>ここに記載している内容は、<strong>アプリケーション開発者が実装時に必要となる。</strong></p>
<p>以下のセクションが、この分類に該当する。</p>
<ul class="last simple">
<li><a class="reference internal" href="#dataaccessmybatis3howtodababaseaccess"><em>データベースアクセス処理の実装</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseresultsetmapping"><em>検索結果とJavaBeanのマッピング方法</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefind"><em>Entityの検索処理</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecreate"><em>Entityの登録処理</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdate"><em>Entityの更新処理</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedelete"><em>Entityの削除処理</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedynamicsql"><em>動的SQLの実装</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouselikeescape"><em>LIKE検索時のエスケープ</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesqlinjectioncountermeasure"><em>SQL Injection対策</em></a></li>
</ul>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="pom-xml">
<span id="dataaccessmybatis3howtousesettingspomxml"></span><h3><a class="toc-backref" href="#id79">5.2.2.1. pom.xmlの設定</a><a class="headerlink" href="#pom-xml" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">インフラストラクチャ層にMyBatis3を使用する場合は、<tt class="file docutils literal"><span class="pre">pom.xml</span></tt>にterasoluna-gfw-mybatis3への依存関係を追加する。</div>
<div class="line">マルチプロジェクト構成の場合は、domainプロジェクトの<tt class="file docutils literal"><span class="pre">pom.xml</span></tt>(<tt class="file docutils literal"><span class="pre">projectName-domain/pom.xml</span></tt>)に追加する。</div>
</div>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、terasoluna-gfw-mybatis3への依存関係は、設定済の状態である。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0</span>
<span class="s">        http://maven.apache.org/maven-v4_0_0.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>projectName-domain<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.example<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>mybatis3-example-app<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;relativePath&gt;</span>../pom.xml<span class="nt">&lt;/relativePath&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>

        <span class="c">&lt;!-- omitted --&gt;</span>

<span class="hll">        <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;dependency&gt;</span>
</span><span class="hll">            <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll">            <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-mybatis3<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/dependency&gt;</span>
</span>
        <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;/dependencies&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>terasoluna-gfw-mybatis3をdependenciesに追加する。
terasoluna-gfw-mybatis3には、MyBatis3及びMyBatis-Springへの依存関係が定義されている。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>terasoluna-gfw-parentをParentプロジェクトとして使用しない場合の設定方法について</strong></p>
<p>親プロジェクトとしてterasoluna-gfw-parentプロジェクトを指定していない場合は、バージョンの指定も個別に必要となる。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.terasoluna.gfw<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>terasoluna-gfw-mybatis3<span class="nt">&lt;/artifactId&gt;</span>
<span class="hll">    <span class="nt">&lt;version&gt;</span>5.0.0.RELEASE<span class="nt">&lt;/version&gt;</span>
</span><span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">上記例では5.0.0.RELEASEを指定しているが、実際に指定するバージョンは、プロジェクトで利用するバージョンを指定すること。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousesettingscooperatewithmybatis3andspring">
<span id="id8"></span><h3><a class="toc-backref" href="#id80">5.2.2.2. MyBatis3とSpringを連携するための設定</a><a class="headerlink" href="#dataaccessmybatis3howtousesettingscooperatewithmybatis3andspring" title="Permalink to this headline">¶</a></h3>
<div class="section" id="dataaccessmybatis3howtousesettingsdatasource">
<span id="id9"></span><h4><a class="toc-backref" href="#id81">5.2.2.2.1. データソースの設定</a><a class="headerlink" href="#dataaccessmybatis3howtousesettingsdatasource" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3とSpringを連携する場合、データソースはSpringのDIコンテナで管理しているデータソースを使用する必要がある。</p>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、Apache Commons DBCPのデータソースが設定済の状態であるため、
プロジェクトの要件に合わせて設定を変更すること。</p>
<p>データソースの設定方法については、共通編の「<a class="reference internal" href="DataAccessCommon.html#data-access-common-howtouse-datasource"><em>データソースの設定</em></a> 」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousesettingstransactionmanager">
<span id="id11"></span><h4><a class="toc-backref" href="#id82">5.2.2.2.2. トランザクション管理の設定</a><a class="headerlink" href="#dataaccessmybatis3howtousesettingstransactionmanager" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">MyBatis3とSpringを連携する場合、
トランザクション管理はSpringのDIコンテナで管理している<tt class="docutils literal"><span class="pre">PlatformTransactionManager</span></tt> を使用する必要がある。</div>
</div>
<p>ローカルトランザクションを使用する場合は、JDBCのAPIを呼び出してトランザクション制御を行う<tt class="docutils literal"><span class="pre">DataSourceTransactionManager</span></tt> を使用する。</p>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、<tt class="docutils literal"><span class="pre">DataSourceTransactionManager</span></tt> が設定済みの状態である。</p>
<p>設定例は以下の通り。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-env/src/main/resources/META-INF/spring/projectName-env.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:jee=</span><span class="s">&quot;http://www.springframework.org/schema/jee&quot;</span>
    <span class="na">xmlns:jdbc=</span><span class="s">&quot;http://www.springframework.org/schema/jdbc&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/jdbc</span>
<span class="s">        http://www.springframework.org/schema/jdbc/spring-jdbc.xsd</span>
<span class="s">        http://www.springframework.org/schema/jee</span>
<span class="s">        http://www.springframework.org/schema/jee/spring-jee.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans</span>
<span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span>
</span><span class="hll">        <span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/bean&gt;</span>
</span>
    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">PlatformTransactionManager</span></tt> として、<tt class="docutils literal"><span class="pre">org.springframework.jdbc.datasource.DataSourceTransactionManager</span></tt> を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">dataSource</span></tt> プロパティに、設定済みのデータソースのbeanを指定する。</p>
<p class="last">トランザクション内でSQLを実行する際は、ここで指定したデータソースからコネクションが取得される。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>PlatformTransactionManagerのbean IDについて</strong></p>
<p>id属性には、<tt class="docutils literal"><span class="pre">transactionManager</span></tt> を指定することを推奨する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">transactionManager</span></tt> 以外の値を指定すると、
<tt class="docutils literal"><span class="pre">&lt;tx:annotation-driven&gt;</span></tt> タグのtransaction-manager属性に同じ値を設定する必要がある。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>アプリケーションサーバから提供されているトランザクションマネージャを使用する場合は、JTAのAPIを呼び出してトランザクション制御を行う
<tt class="docutils literal"><span class="pre">org.springframework.transaction.jta.JtaTransactionManager</span></tt> を使用する。</p>
<p>設定例は以下の通り。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-env/src/main/resources/META-INF/spring/projectName-env.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:jee=</span><span class="s">&quot;http://www.springframework.org/schema/jee&quot;</span>
    <span class="na">xmlns:jdbc=</span><span class="s">&quot;http://www.springframework.org/schema/jdbc&quot;</span>
<span class="hll">    <span class="na">xmlns:tx=</span><span class="s">&quot;http://www.springframework.org/schema/tx&quot;</span>
</span>    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/jdbc</span>
<span class="s">        http://www.springframework.org/schema/jdbc/spring-jdbc.xsd</span>
<span class="s">        http://www.springframework.org/schema/jee</span>
<span class="s">        http://www.springframework.org/schema/jee/spring-jee.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans</span>
<span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="hll"><span class="s">        http://www.springframework.org/schema/tx</span>
</span><span class="hll"><span class="s">        http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span><span class="nt">&gt;</span>
</span>
    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;tx:jta-transaction-manager</span> <span class="nt">/&gt;</span>
</span>
    <span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">&lt;tx:jta-transaction-manager</span> <span class="pre">/&gt;</span></tt> を指定すると、
アプリケーションサーバに対して最適な <tt class="docutils literal"><span class="pre">JtaTransactionManager</span></tt> がbean定義される。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousesettingsmybatis-spring">
<span id="id13"></span><h4><a class="toc-backref" href="#id83">5.2.2.2.3. MyBatis-Springの設定</a><a class="headerlink" href="#dataaccessmybatis3howtousesettingsmybatis-spring" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3とSpringを連携する場合、MyBatis-Springのコンポーネントを使用して、</p>
<ul class="simple">
<li>MyBatis3とSpringを連携するために必要となる処理がカスタマイズされた<tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt>の生成</li>
<li>スレッドセーフなMapperオブジェクト(MapperインタフェースのProxyオブジェクト)の生成</li>
</ul>
<p>を行う必要がある。</p>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、MyBatis3とSpringを連携するための設定は、
設定済みの状態である。</p>
<p>設定例は以下の通り。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-infra.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="hll">    <span class="na">xmlns:mybatis=</span><span class="s">&quot;http://mybatis.org/schema/mybatis-spring&quot;</span>
</span>    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="hll"><span class="s">        http://mybatis.org/schema/mybatis-spring</span>
</span><span class="hll"><span class="s">        http://mybatis.org/schema/mybatis-spring.xsd&quot;</span><span class="nt">&gt;</span>
</span>
    <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">&quot;classpath:/META-INF/spring/projectName-env.xml&quot;</span> <span class="nt">/&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span>
</span><span class="hll">        <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocation&quot;</span>
</span><span class="hll">            <span class="na">value=</span><span class="s">&quot;classpath:/META-INF/mybatis/mybatis-config.xml&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/bean&gt;</span>
</span>
<span class="hll">    <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;mybatis:scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.domain.repository&quot;</span> <span class="nt">/&gt;</span>
</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> を生成するためのコンポーネントとして、<tt class="docutils literal"><span class="pre">SqlSessionFactoryBean</span></tt> をbean定義する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">dataSource</span></tt> プロパティに、設定済みのデータソースのbeanを指定する。</p>
<p class="last">MyBatis3の処理の中でSQLを発行する際は、ここで指定したデータソースからコネクションが取得される。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">configLocation</span></tt> プロパティに、MyBatis設定ファイルのパスを指定する。</p>
<p class="last">ここで指定したファイルが<tt class="docutils literal"><span class="pre">SqlSessionFactory</span></tt> を生成する時に読み込まれる。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">Mapperインタフェースをスキャンするために<tt class="docutils literal"><span class="pre">&lt;mybatis:scan&gt;</span></tt> を定義し、<tt class="docutils literal"><span class="pre">base-package</span></tt> 属性には、
Mapperインタフェースが格納されている基底パッケージを指定する。</p>
<p>指定されたパッケージ配下に格納されている Mapperインタフェースがスキャンされ、
スレッドセーフなMapperオブジェクト(MapperインタフェースのProxyオブジェクト)が自動的に生成される。</p>
<p class="last"><strong>【指定するパッケージは、各プロジェクトで決められたパッケージにすること】</strong></p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>MyBatis3の設定方法について</strong></p>
<p class="last"><tt class="docutils literal"><span class="pre">SqlSessionFactoryBean</span></tt> を使用する場合、MyBatis3の設定は、
MyBatis設定ファイルではなくbeanのプロパティに直接指定することもできるが、
本ガイドラインでは、MyBatis3自体の設定はMyBatis標準の設定ファイルに指定する方法を推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousesettingsmybatis3">
<span id="id15"></span><h3><a class="toc-backref" href="#id84">5.2.2.3. MyBatis3の設定</a><a class="headerlink" href="#dataaccessmybatis3howtousesettingsmybatis3" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">MyBatis3では、MyBatis3の動作をカスタマイズするための仕組みが用意されている。</div>
<div class="line">MyBatis3の動作をカスタマイズする場合は、MyBatis設定ファイルに設定値を追加する事で実現可能である。</div>
</div>
<div class="line-block">
<div class="line">ここでは、アプリケーションの特性に依存しない設定項目についてのみ、説明を行う。</div>
<div class="line">その他の設定項目に関しては、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/configuration.html">MyBatis 3 REFERENCE DOCUMENTATION(Configuration XML)</a> 」を参照し、
アプリケーションの特性にあった設定を行うこと。</div>
<div class="line">基本的にはデフォルト値のままでも問題ないが、アプリケーションの特性を考慮し、必要に応じて設定を変更すること。</div>
</div>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>MyBatis設定ファイルの格納場所について</strong></p>
<p>本ガイドラインでは、MyBatis設定ファイルは、
<tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></tt>に格納することを推奨している。</p>
<p class="last"><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、上記ファイルは格納済みの状態である。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="sql">
<span id="dataaccessmybatis3howtousesettingsexecutortype"></span><h4><a class="toc-backref" href="#id85">5.2.2.3.1. SQL実行モードの設定</a><a class="headerlink" href="#sql" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3では、SQLを実行するモードとして以下の3種類を用意している。</p>
<div class="line-block">
<div class="line">どのモードを使用するかは、各モードの特性と制約、及び性能要件を考慮して決定して頂きたい。</div>
<div class="line">実行モードの設定方法などについては、「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortype"><em>SQL実行モードの利用</em></a>」を参照されたい。</div>
</div>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">モード</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>SIMPLE</td>
<td><p class="first">SQL実行毎に新しい<tt class="docutils literal"><span class="pre">java.sql.PreparedStatement</span></tt>を作成する。</p>
<p class="last">MyBatisのデフォルトの動作であり、<a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> も<tt class="docutils literal"><span class="pre">SIMPLE</span></tt>モードとなっている。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>REUSE</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">PreparedStatement</span></tt>をキャッシュし再利用する。</p>
<p>同一トランザクション内で同じSQLを複数回実行する場合は、
<tt class="docutils literal"><span class="pre">REUSE</span></tt>モードで実行すると、<tt class="docutils literal"><span class="pre">SIMPLE</span></tt>モードと比較して性能向上が期待できる。</p>
<p class="last">これは、SQLを解析して<tt class="docutils literal"><span class="pre">PreparedStatement</span></tt>を生成する処理の実行回数を減らす事ができるためである。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>BATCH</td>
<td><p class="first">更新系のSQLをバッチ実行する。(<tt class="docutils literal"><span class="pre">java.sql.Statement#executeBatch()</span></tt>を使ってSQLを実行する)。</p>
<p>同一トランザクション内で更新系のSQLを連続して大量に実行する場合は、<tt class="docutils literal"><span class="pre">BATCH</span></tt>モードで実行すると、
<tt class="docutils literal"><span class="pre">SIMPLE</span></tt>モードや<tt class="docutils literal"><span class="pre">REUSE</span></tt>モードと比較して性能向上が期待できる。</p>
<p>これは、</p>
<ul class="simple">
<li>SQLを解析して<tt class="docutils literal"><span class="pre">PreparedStatement</span></tt>を生成する処理の実行回数</li>
<li>サーバと通信する回数</li>
</ul>
<p>を減らす事ができるためである。</p>
<p class="last">ただし、<tt class="docutils literal"><span class="pre">BATCH</span></tt>モードを使用する場合は、MyBatisの動きが<tt class="docutils literal"><span class="pre">SIMPLE</span></tt>モードや<tt class="docutils literal"><span class="pre">SIMPLE</span></tt>モードと異なる部分がある。
具体的な違いと注意点については、「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotes"><em>バッチモードのRepository利用時の注意点</em></a>」を参照されたい。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="typealias">
<span id="dataaccessmybatis3howtousesettingstypealias"></span><h4><a class="toc-backref" href="#id86">5.2.2.3.2. TypeAliasの設定</a><a class="headerlink" href="#typealias" title="Permalink to this headline">¶</a></h4>
<p>TypeAliasを使用すると、マッピングファイルで指定するJavaクラスに対して、エイリアス名(短縮名)を割り当てる事ができる。</p>
<p>TypeAliasを使用しない場合、マッピングファイルで指定する<tt class="docutils literal"><span class="pre">type</span></tt> 属性、<tt class="docutils literal"><span class="pre">parameterType</span></tt> 属性、<tt class="docutils literal"><span class="pre">resultType</span></tt> 属性などには、
Javaクラスの完全修飾クラス名(FQCN)を指定する必要があるため、マッピングファイルの記述効率の低下、記述ミスの増加などが懸念される。</p>
<p>本ガイドラインでは、記述効率の向上、記述ミスの削減、マッピングファイルの可読性向上などを目的として、TypeAliasを使用することを推奨する。</p>
<p><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-multi-blank#multi-blank-project-with-mybatis3">MyBatis3用のブランクプロジェクト</a> からプロジェクトを生成した場合は、
Entityを格納するパッケージ(<tt class="docutils literal"><span class="pre">${projectPackage}.domain.model</span></tt>)配下に格納されるクラスがTypeAliasの対象となっている。
必要に応じて、設定を追加されたい。</p>
<p>TypeAliasの設定方法は以下の通り。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration</span>
<span class="cp">  PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
<span class="cp">  &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;typeAliases&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&quot;com.example.domain.model&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;/typeAliases&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">package</span></tt> 要素の<tt class="docutils literal"><span class="pre">name</span></tt> 属性に、エイリアスを設定するクラスが格納されているパッケージ名を指定する。</p>
<p>指定したパッケージ配下に格納されているクラスは、パッケージの部分が除去された部分が、エイリアス名となる。
上記例だと、<tt class="docutils literal"><span class="pre">com.example.domain.model.Account</span></tt> クラスのエイリアス名は、<tt class="docutils literal"><span class="pre">Account</span></tt> となる。</p>
<p class="last"><strong>【指定するパッケージは、各プロジェクトで決められたパッケージにすること】</strong></p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>クラス単位にType Aliasを設定する方法について</strong></p>
<p class="last">Type Aliasの設定には、クラス単位に設定する方法やエイリアス名を明示的に指定する方法が用意されている。
詳細は、Appendixの「<a class="reference internal" href="#dataaccessmybatis3appendixsettingstypealias"><em>TypeAliasの設定</em></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>TypeAliasを使用した際の、マッピングファイルの記述例は以下の通り。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>

<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.account.AccountRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;accountResultMap&quot;</span>
<span class="hll">        <span class="na">type=</span><span class="s">&quot;Account&quot;</span><span class="nt">&gt;</span>
</span>        <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span>
<span class="hll">        <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span>
</span>        <span class="na">resultMap=</span><span class="s">&quot;accountResultMap&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findByCriteria&quot;</span>
<span class="hll">        <span class="na">parameterType=</span><span class="s">&quot;AccountSearchCriteria&quot;</span>
</span>        <span class="na">resultMap=</span><span class="s">&quot;accountResultMap&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>MyBatis3標準のエイリアス名について</strong></p>
<p>プリミティブ型やプリミティブラッパ型などの一般的なJavaクラスについては、予めエイリアス名が設定されている。</p>
<p class="last">予め設定されるエイリアス名については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/configuration.html#typeAliases">MyBatis 3 REFERENCE DOCUMENTATION(Configuration XML-typeAliases-)</a> 」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="nulljdbc">
<span id="dataaccessmybatis3howtousesettingsmappingnullandjdbctype"></span><h4><a class="toc-backref" href="#id87">5.2.2.3.3. NULL値とJDBC型のマッピング設定</a><a class="headerlink" href="#nulljdbc" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">使用しているデータベース(JDBCドライバ)によっては、カラム値をnullに設定する際に、エラーが発生する場合がある。</div>
<div class="line">この事象は、JDBCドライバが<tt class="docutils literal"><span class="pre">null</span></tt>値の設定と認識できるJDBC型を指定する事で、解決する事ができる。</div>
</div>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">null</span></tt>値を設定した際に、以下の様なスタックトレースを伴うエラーが発生した場合は、<tt class="docutils literal"><span class="pre">null</span></tt>値とJDBC型のマッピングが必要となる。</div>
<div class="line">MyBatis3のデフォルトでは、<tt class="docutils literal"><span class="pre">OTHER</span></tt>と呼ばれる汎用的なJDBC型が指定されるが、<tt class="docutils literal"><span class="pre">OTHER</span></tt>だとエラーとなるJDBCドライバもある。</div>
</div>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span class="hll"><span class="n">java</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">SQLException</span><span class="p">:</span> <span class="n">Invalid</span> <span class="n">column</span> <span class="n">type</span><span class="p">:</span> 1111
</span>    <span class="n">at</span> <span class="n">oracle</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">OracleStatement</span><span class="p">.</span><span class="n">getInternalType</span><span class="p">(</span><span class="n">OracleStatement</span><span class="p">.</span><span class="n">java</span><span class="p">:</span>3916<span class="p">)</span> <span class="o">~</span><span class="p">[</span><span class="n">ojdbc6</span><span class="o">-</span>11<span class="p">.</span>2<span class="p">.</span>0<span class="p">.</span>2<span class="p">.</span>0<span class="p">.</span><span class="n">jar</span><span class="p">:</span>11<span class="p">.</span>2<span class="p">.</span>0<span class="p">.</span>2<span class="p">.</span>0<span class="p">]</span>
    <span class="n">at</span> <span class="n">oracle</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">OraclePreparedStatement</span><span class="p">.</span><span class="n">setNullCritical</span><span class="p">(</span><span class="n">OraclePreparedStatement</span><span class="p">.</span><span class="n">java</span><span class="p">:</span>4541<span class="p">)</span> <span class="o">~</span><span class="p">[</span><span class="n">ojdbc6</span><span class="o">-</span>11<span class="p">.</span>2<span class="p">.</span>0<span class="p">.</span>2<span class="p">.</span>0<span class="p">.</span><span class="n">jar</span><span class="p">:</span>11<span class="p">.</span>2<span class="p">.</span>0<span class="p">.</span>2<span class="p">.</span>0<span class="p">]</span>
    <span class="n">at</span> <span class="n">oracle</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">OraclePreparedStatement</span><span class="p">.</span><span class="n">setNull</span><span class="p">(</span><span class="n">OraclePreparedStatement</span><span class="p">.</span><span class="n">java</span><span class="p">:</span>4523<span class="p">)</span> <span class="o">~</span><span class="p">[</span><span class="n">ojdbc6</span><span class="o">-</span>11<span class="p">.</span>2<span class="p">.</span>0<span class="p">.</span>2<span class="p">.</span>0<span class="p">.</span><span class="n">jar</span><span class="p">:</span>11<span class="p">.</span>2<span class="p">.</span>0<span class="p">.</span>2<span class="p">.</span>0<span class="p">]</span>
    <span class="p">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Oracle使用時の動作について</strong></p>
<p>データベースにOracleを使用する場合は、デフォルトの設定のままだとエラーが発生する事が確認されている。
バージョンによって動作がかわる可能性はあるが、Oracleを使う場合は、設定の変更が必要になる可能性がある事を記載しておく。</p>
<p class="last">エラーが発生する事が確認されているバージョンは、Oracle 11g R1で、JDBC型の<tt class="docutils literal"><span class="pre">NULL</span></tt> 型をマッピングするように設定を変更することで、
エラーを解決する事できる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に、MyBatis3のデフォルトの動作を変更する方法を示す。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org/DTD Config 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>

    <span class="nt">&lt;settings&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;jdbcTypeForNull&quot;</span> <span class="na">value=</span><span class="s">&quot;NULL&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">jdbcTypeForNullに、JDBC型を指定する。</p>
<p class="last">上記例では、<tt class="docutils literal"><span class="pre">null</span></tt>値のJDBC型として<tt class="docutils literal"><span class="pre">NULL</span></tt>型を指定している。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>項目単位で解決する方法について</strong></p>
<p>別の解決方法として、<tt class="docutils literal"><span class="pre">null</span></tt>値が設定される可能性があるプロパティのインラインパラメータに、
Java型に対応する適切なJDBC型を個別に指定する方法もある。</p>
<p class="last">ただし、インラインパラメータで個別に指定した場合、マッピングファイルの記述量及び指定ミスが発生する可能性が増えることが予想されるため、
本ガイドラインとしては、全体の設定でエラーを解決することを推奨している。
全体の設定を変更してもエラーが解決しない場合は、エラーが発生するプロパティについてのみ、個別に設定を行えばよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="typehandler">
<span id="dataaccessmybatis3howtousesettingstypehandler"></span><h4><a class="toc-backref" href="#id88">5.2.2.3.4. TypeHandlerの設定</a><a class="headerlink" href="#typehandler" title="Permalink to this headline">¶</a></h4>
<p>TypeHandlerは、JavaクラスとJDBC型をマッピングする時に使用される。</p>
<p>具体的には、</p>
<ul class="simple">
<li>SQLを発行する際に、Javaクラスのオブジェクトを<tt class="docutils literal"><span class="pre">java.sql.PreparedStatement</span></tt> のバインドパラメータとして設定する</li>
<li>SQLの発行結果として取得した<tt class="docutils literal"><span class="pre">java.sql.ResultSet</span></tt> から値を取得する</li>
</ul>
<p>際に、使用される。</p>
<p>プリミティブ型やプリミティブラッパ型などの一般的なJavaクラスについては、MyBatis3からTypeHandlerが提供されており、
特別な設定を行う必要はない。</p>
<blockquote>
<div><div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">MyBatis3から提供されているTypeHandlerについては、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/configuration.html#typeHandlers">MyBatis 3 REFERENCE DOCUMENTATION(Configuration XML-typeHandlers-)</a> 」を参照されたい。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>Enum型のマッピングについて</strong></p>
<p>MyBatis3のデフォルトの動作では、Enum型はEnumの定数名(文字列)とマッピングされる。</p>
<p>下記のようなEnum型の場合は、
<tt class="docutils literal"><span class="pre">&quot;WAITING_FOR_ACTIVE&quot;</span></tt> , <tt class="docutils literal"><span class="pre">&quot;ACTIVE&quot;</span></tt> , <tt class="docutils literal"><span class="pre">&quot;EXPIRED&quot;</span></tt> , <tt class="docutils literal"><span class="pre">&quot;LOCKED&quot;</span></tt> という文字列とマッピングされてテーブルに格納される。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">model</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">enum</span> <span class="n">AccountStatus</span> <span class="o">{</span>
    <span class="n">WAITING_FOR_ACTIVE</span><span class="o">,</span> <span class="n">ACTIVE</span><span class="o">,</span> <span class="n">EXPIRED</span><span class="o">,</span> <span class="n">LOCKED</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">MyBatisでは、Enum型を数値(定数の定義順)とマッピングする事もできる。数値とマッピングする方法については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/configuration.html#Handling_Enums">MyBatis 3 REFERENCE DOCUMENTATION(Configuration XML-Handling Enums-)</a> 」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>TypeHandlerの作成が必要になるケースは、MyBatis3でサポートしていないJavaクラスとJDBC型をマッピングする場合である。</p>
<p>具体的には、</p>
<ul class="simple">
<li>容量の大きいファイルデータ(バイナリデータ)を<tt class="docutils literal"><span class="pre">java.io.InputStream</span></tt> 型で保持し、JDBC型の<tt class="docutils literal"><span class="pre">BLOB</span></tt> 型にマッピングする</li>
<li>容量の大きいテキストデータを<tt class="docutils literal"><span class="pre">java.io.Reader</span></tt> 型として保持し、JDBC型の<tt class="docutils literal"><span class="pre">CLOB</span></tt> 型にマッピングする</li>
<li>本ガイドラインで利用を推奨している「<a class="reference internal" href="Utilities/JodaTime.html"><em>日付操作(Joda Time)</em></a>」の<tt class="docutils literal"><span class="pre">org.joda.time.DateTime</span></tt> 型と、JDBC型の<tt class="docutils literal"><span class="pre">TIMESTAMP</span></tt> 型をマッピングする</li>
<li>etc ...</li>
</ul>
<p>場合に、TypeHandlerの作成が必要となる。</p>
<p>上記にあげた3つのTypeHandlerの作成例については、
「<a class="reference internal" href="#dataaccessmybatis3howtoextendtypehandler"><em>TypeHandlerの実装</em></a>」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ここでは、作成したTypeHandlerをMyBatisに適用する方法について説明を行う。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org/DTD Config 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>

    <span class="nt">&lt;typeHandlers&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&quot;com.example.infra.mybatis.typehandler&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/typeHandlers&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">MyBatis設定ファイルにTypeHandlerの設定を行う。</p>
<p class="last"><tt class="docutils literal"><span class="pre">package</span></tt>要素のname 属性に、作成したTypeHandlerが格納されているパッケージ名を指定する。
指定したパッケージ配下に格納されているTypeHandlerが、MyBatisによって自動検出される。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、指定したパッケージ配下に格納されているTypeHandlerをMyBatisによって自動検出させているが、
クラス単位に設定する事もできる。</p>
<p>クラス単位にTypeHandlerを設定する場合は、<tt class="docutils literal"><span class="pre">typeHandler</span></tt>要素を使用する。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;typeHandlers&gt;</span>
<span class="hll">    <span class="nt">&lt;typeHandler</span> <span class="na">handler=</span><span class="s">&quot;xxx.yyy.zzz.CustomTypeHandler&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&quot;com.example.infra.mybatis.typehandler&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/typeHandlers&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>更に、TypeHandlerの中でDIコンテナで管理されているbeanを使用したい場合は、
bean定義ファイル内でTypeHandlerを指定すればよい。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-infra.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:tx=</span><span class="s">&quot;http://www.springframework.org/schema/tx&quot;</span> <span class="na">xmlns:mybatis=</span><span class="s">&quot;http://mybatis.org/schema/mybatis-spring&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">    http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">    http://www.springframework.org/schema/tx</span>
<span class="s">    http://www.springframework.org/schema/tx/spring-tx.xsd</span>
<span class="s">    http://mybatis.org/schema/mybatis-spring</span>
<span class="s">    http://mybatis.org/schema/mybatis-spring.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;oracleDataSource&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocation&quot;</span>
            <span class="na">value=</span><span class="s">&quot;classpath:/META-INF/mybatis/mybatis-config.xml&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;typeHandlers&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">            <span class="nt">&lt;list&gt;</span>
</span><span class="hll">                <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;xxx.yyy.zzz.CustomTypeHandler&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">            <span class="nt">&lt;/list&gt;</span>
</span><span class="hll">        <span class="nt">&lt;/property&gt;</span>
</span>    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>TypeHandlerを適用するJavaクラスとJDBC型のマッピングの指定は、</p>
<ul class="simple">
<li>MyBatis設定ファイル内の<tt class="docutils literal"><span class="pre">typeHandler</span></tt>要素の属性値として指定</li>
<li><tt class="docutils literal"><span class="pre">&#64;org.apache.ibatis.type.MappedTypes</span></tt>アノテーションと<tt class="docutils literal"><span class="pre">&#64;org.apache.ibatis.type.MappedJdbcTypes</span></tt>アノテーションに指定</li>
<li>MyBatis3から提供されているTypeHandlerの基底クラス(<tt class="docutils literal"><span class="pre">org.apache.ibatis.type.BaseTypeHandler</span></tt>)を継承することで指定</li>
</ul>
<p>する方法がある。</p>
<p class="last">詳しくは、「<a class="reference external" href="http://mybatis.github.io/mybatis-3/configuration.html#typeHandlers">MyBatis 3 REFERENCE DOCUMENTATION(Configuration XML-typeHandlers-)</a> 」を参照されたい。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記の設定例は、いずれもアプリケーション全体に適用するための設定方法であったが、
フィールド毎に個別のTypeHandlerを指定する事も可能である。
これは、アプリケーション全体に適用しているTypeHandlerを上書きする際に使用する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.image.ImageRepository&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;resultMapImage&quot;</span> <span class="na">type=</span><span class="s">&quot;Image&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;imageData&quot;</span> <span class="na">column=</span><span class="s">&quot;image_data&quot;</span> <span class="na">typeHandler=</span><span class="s">&quot;XxxBlobInputStreamTypeHandler&quot;</span> <span class="nt">/&gt;</span>
</span>        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;createdAt&quot;</span> <span class="na">column=</span><span class="s">&quot;created_at&quot;</span>  <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;resultMapImage&quot;</span><span class="nt">&gt;</span>
        SELECT
            id
            ,image_data
            ,created_at
        FROM
            t_image
        WHERE
            id = #{id}
    <span class="nt">&lt;/select&gt;</span>
    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Image&quot;</span><span class="nt">&gt;</span>
        INSERT INTO
            t_image
        (
            id
            ,image_data
            ,created_at
        )
        VALUES
        (
            #{id}
<span class="hll">            /* (3) */
</span><span class="hll">            ,#{imageData,typeHandler=XxxBlobInputStreamTypeHandler}
</span>            ,#{createdAt}
        )
    <span class="nt">&lt;/insert&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)から値を取得する際は、
<tt class="docutils literal"><span class="pre">id</span></tt>又は<tt class="docutils literal"><span class="pre">result</span></tt>要素の<tt class="docutils literal"><span class="pre">typeHandler</span></tt>属性に適用するTypeHandlerを指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">PreparedStatement</span></tt>に値を設定する際は、
インラインパラメータの<tt class="docutils literal"><span class="pre">typeHandler</span></tt>属性に適用するTypeHandlerを指定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last">TypeHandlerをフィールド毎に個別に指定する場合は、TypeHandlerのクラスにTypeAliasを設けることを推奨する。
TypeAliasの設定方法については、「<a class="reference internal" href="#dataaccessmybatis3howtousesettingstypealias"><em>TypeAliasの設定</em></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtodababaseaccess">
<span id="id20"></span><h3><a class="toc-backref" href="#id89">5.2.2.4. データベースアクセス処理の実装</a><a class="headerlink" href="#dataaccessmybatis3howtodababaseaccess" title="Permalink to this headline">¶</a></h3>
<p>MyBatis3の機能を使用してデータベースにアクセスするための、具体的な実装方法について説明する。</p>
<div class="section" id="repository">
<span id="dataaccessmybatis3howtodababaseaccesscreaterepository"></span><h4><a class="toc-backref" href="#id90">5.2.2.4.1. Repositoryインタフェースの作成</a><a class="headerlink" href="#repository" title="Permalink to this headline">¶</a></h4>
<p>Entity毎にRepositoryインタフェースを作成する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">JavaのインタフェースとしてRepositoryインタフェースを作成する。</p>
<p class="last">上記例では、<tt class="docutils literal"><span class="pre">Todo</span></tt>というEntityに対するRepositoryインタエースを作成している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtodababaseaccesscreatemappingfile">
<span id="id21"></span><h4><a class="toc-backref" href="#id91">5.2.2.4.2. マッピングファイルの作成</a><a class="headerlink" href="#dataaccessmybatis3howtodababaseaccesscreatemappingfile" title="Permalink to this headline">¶</a></h4>
<p>Repositoryインタフェース毎にマッピングファイルを作成する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="c">&lt;!-- (1)  --&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">mapper</span></tt>要素の<tt class="docutils literal"><span class="pre">namespace</span></tt>属性に、Repositoryインタフェースの完全修飾クラス名(FQCN)を指定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>マッピングファイルの格納先について</strong></p>
<p>マッピングファイルの格納先は、</p>
<ul class="simple">
<li>MyBatis3が自動的にマッピングファイルを読み込むために定めたルールに則ったディレクトリ</li>
<li>任意のディレクトリ</li>
</ul>
<p>のどちらかを選択することができる。</p>
<p><strong>本ガイドラインでは、MyBatis3が定めたルールに則ったディレクトリに格納し、マッピングファイルを自動的に読み込む仕組みを利用することを推奨する。</strong></p>
<p>マッピングファイルを自動的に読み込ませるためには、
Repositoryインタフェースのパッケージ階層と同じ階層で、マッピングファイルをクラスパス上に格納する必要がある。</p>
<p class="last">具体的には、
<tt class="docutils literal"><span class="pre">com.example.domain.repository.todo.TodoRepository</span></tt>というRepositoryインターフェースに対するマッピングファイル(<tt class="file docutils literal"><span class="pre">TodoRepository.xml</span></tt>)は、
<tt class="docutils literal"><span class="pre">projectName-domain/src/main/resources/com/example/domain/repository/todo</span></tt>ディレクトリに格納すればいよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="crud">
<span id="dataaccessmybatis3howtodababaseaccesscrud"></span><h4><a class="toc-backref" href="#id92">5.2.2.4.3. CRUD処理の実装</a><a class="headerlink" href="#crud" title="Permalink to this headline">¶</a></h4>
<p>ここからは、基本的なCRUD処理の実装方法と、SQL実装時の考慮点について説明を行う。</p>
<p>基本的なCRUD処理として、以下の処理の実装方法について説明を行う。</p>
<ul class="simple">
<li><a class="reference internal" href="#dataaccessmybatis3howtouseresultsetmapping"><em>検索結果とJavaBeanのマッピング方法</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousefind"><em>Entityの検索処理</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousecreate"><em>Entityの登録処理</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtouseupdate"><em>Entityの更新処理</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedelete"><em>Entityの削除処理</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousedynamicsql"><em>動的SQLの実装</em></a></li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>MyBatis3を使用してCRUD処理を実装する際は、
検索したEntityがローカルキャッシュと呼ばれる領域にキャッシュされる仕組みになっている点を意識しておく必要がある。</p>
<p>MyBatis3が提供するローカルキャッシュのデフォルトの動作は以下の通りである。</p>
<ul class="simple">
<li>ローカルキャッシュは、トランザクション単位で管理する。</li>
<li>Entityのキャッシュは、「ステートメントID + 組み立てられたSQLのパターン + 組み立てられたSQにバインドするパラメータ値 + ページ位置(取得範囲)」毎に行う。</li>
</ul>
<p>つまり、同一トランザクション内の処理において、
MyBatisが提供している検索APIを全て同じパラメータで呼び出すと、
2回目以降はSQLを発行せずに、キャッシュされているEntityのインスタンスが返却される。</p>
<p class="last">ここでは、 <strong>MyBatisのAPIが返却するEntityとローカルキャッシュで管理しているEntityが同じインスタンス</strong> という点を意識しておいてほしい。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">ローカルキャッシュは、ステートメント単位で管理するように変更する事もできる。
ローカルキャッシュをステートメント単位で管理する場合、MyBatisは毎回SQLを実行して最新のEntityを取得する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>SQL実装時の考慮点として、以下の点について説明を行う。</p>
<ul class="simple">
<li><a class="reference internal" href="#dataaccessmybatis3howtouselikeescape"><em>LIKE検索時のエスケープ</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtousesqlinjectioncountermeasure"><em>SQL Injection対策</em></a></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>具体的な実装方法の説明を行う前に、以降の説明で登場するコンポーネントについて、簡単に説明しておく。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="28%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">コンポーネント</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>Entity</td>
<td><p class="first">アプリケーションで扱う業務データを保持するJavaBeanクラス。</p>
<p class="last">Entityの詳細については、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#domainlayer-entity"><em>Entityの実装</em></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>Repositoryインタフェース</td>
<td><p class="first">EntityのCRUD操作を行うためのメソッドを定義するインタフェース。</p>
<p class="last">Repositoryの詳細については、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#repository-label"><em>Repositoryの実装</em></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>Serviceクラス</td>
<td><p class="first">業務ロジックを実行するためのクラス。</p>
<p class="last">Serviceの詳細については、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#service-label"><em>Serviceの実装</em></a>」を参照されたい。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">本ガイドラインでは、アーキテクチャ上の用語を統一するために、
MyBatis3のMapperインタフェースの事をRepositoryインタフェースと呼んでいる。</p>
</div>
</div></blockquote>
<p>以降の説明では、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#domainlayer-entity"><em>Entityの実装</em></a>」「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#repository-label"><em>Repositoryの実装</em></a>」「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#service-label"><em>Serviceの実装</em></a>」を読んでいる前提で説明を行う。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="javabean">
<span id="dataaccessmybatis3howtouseresultsetmapping"></span><h3><a class="toc-backref" href="#id93">5.2.2.5. 検索結果とJavaBeanのマッピング方法</a><a class="headerlink" href="#javabean" title="Permalink to this headline">¶</a></h3>
<p>Entityの検索処理の説明を行う前に、検索結果とJavaBeanのマッピング方法について説明を行う。</p>
<p>MyBatis3では、検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)をJavaBean(Entity)にマッピングする方法として、
自動マッピング と手動マッピングの2つの方法が用意されている。
それぞれ特徴があるので、<strong>プロジェクトの特性やアプリケーションで実行するSQLの特性などを考慮して、使用するマッピング方法を決めて頂きたい。</strong></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>使用するマッピング方法について</strong></p>
<p>本ガイドラインでは、</p>
<ul class="simple">
<li>シンプルなマッピング(単一オブジェクトへのマッピング)の場合は自動マッピングを使用し、高度なマッピング(関連オブジェクトへのマッピング)が必要な場合は手動マッピングを使用する。</li>
<li>一律手動マッピングを使用する</li>
</ul>
<p>の、２つの案を提示する。これは、上記2案のどちらかを選択する事を強制するものではなく、あくまで選択肢のひとつと考えて頂きたい。</p>
<p class="last"><strong>アーキテクトは、自動マッピングと手動マッピングを使うケースの判断基準をプログラマに対して明確に示すことで、
アプリケーション全体として統一されたマッピング方法が使用されるように心がけてほしい。</strong></p>
</div>
</div></blockquote>
<p>以下に、自動マッピングと手動マッピングに対して、それぞれの特徴と使用例を説明する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3howtouseresultmappingbyauto">
<span id="id22"></span><h4><a class="toc-backref" href="#id94">5.2.2.5.1. 検索結果の自動マッピング</a><a class="headerlink" href="#dataaccessmybatis3howtouseresultmappingbyauto" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3では、検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)のカラムとJavaBeanのプロパティをマッピングする方法として、
カラム名とプロパティ名を一致させることで、自動的に解決する仕組みを提供している。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>自動マッピングの特徴について</strong></p>
<p>自動マッピングを使用すると、マッピングファイルには実行するSQLのみ記述すればよいため、
マッピングファイルの記述量を減らすことができる点が特徴である。</p>
<p>記述量が減ることで、単純ミスの削減や、カラム名やプロパティ名変更時の修正箇所の削減といった効果も期待できる。</p>
<p class="last">ただし、自動マッピングが行えるのは、単一オブジェクトに対するマッピングのみである。
ネストした関連オブジェクトに対してマッピングを行いたい場合は、手動マッピングを使用する必要がある。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>カラム名について</strong></p>
<p class="last">ここで言うカラム名とは、テーブルの物理的なカラム名ではなく、
SQLを発行して取得した検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)がもつカラム名の事である。
そのため、AS句を使うことで、物理的なカラム名とJavaBeanのプロパティ名を一致させることは、
比較的容易に行うことができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に、自動マッピングを使用して検索結果をJavaBeanにマッピングする実装例を示す。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/com/example/domain/repository/todo/TodoRepository.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        SELECT
<span class="hll">            todo_id AS &quot;todoId&quot;, /* (1) */
</span>            todo_title AS &quot;todoTitle&quot;,
<span class="hll">            finished, /* (2) */
</span>            created_at AS &quot;createdAt&quot;,
            version
        FROM
            t_todo
        WHERE
            todo_id = #{todoId}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>テーブルの物理カラム名とJavaBeanのプロパティ名が異なる場合は、AS句を使用して一致させることで、自動マッピング対象にすることができる。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>テーブルの物理カラム名とJavaBeanのプロパティ名が一致している場合は、AS句を指定する必要はない。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>JavaBean</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">model</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">todoTitle</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createdAt</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="n">version</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">todoId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoId</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">todoId</span> <span class="o">=</span> <span class="n">todoId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTodoTitle</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">todoTitle</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTodoTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">todoTitle</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">todoTitle</span> <span class="o">=</span> <span class="n">todoTitle</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFinished</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">finished</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFinished</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">finished</span> <span class="o">=</span> <span class="n">finished</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getCreatedAt</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createdAt</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreatedAt</span><span class="o">(</span><span class="n">Date</span> <span class="n">createdAt</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getVersion</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">version</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setVersion</span><span class="o">(</span><span class="kt">long</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">version</span> <span class="o">=</span> <span class="n">version</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>アンダースコア区切りのカラム名とキャメルケース形式のプロパティ名のマッピング方法について</strong></p>
<p class="last">上記例では、アンダースコア区切りのカラム名とキャメルケース形式のプロパティ名の違いをAS句を使って吸収しているが、
アンダースコア区切りのカラム名とキャメルケース形式のプロパティ名の違いを吸収するだけならば、
MyBatis3の設定を変更する事で実現可能である。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>テーブルの物理カラム名をアンダースコア区切りにしている場合は、
MyBatis設定ファイル(<tt class="file docutils literal"><span class="pre">mybatis-config.xml</span></tt>)に以下の設定を追加することで、
キャメルケースのJavaBeanのプロパティに自動マッピングする事ができる。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration</span>
<span class="cp">  PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
<span class="cp">  &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>

    <span class="nt">&lt;settings&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;mapUnderscoreToCamelCase&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;/settings&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">mapUnderscoreToCamelCase</span></tt> を<cite>true</cite>にする設定を追加する。</p>
<p class="last">設定を<cite>true</cite>にすると、アンダースコア区切りのカラム名がキャメルケース形式に自動変換される。
具体例としては、カラム名が<tt class="docutils literal"><span class="pre">&quot;todo_id&quot;</span></tt>の場合、<tt class="docutils literal"><span class="pre">&quot;todoId&quot;</span></tt>に変換されてマッピングが行われる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/com/example/domain/repository/todo/TodoRepository.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        SELECT
<span class="hll">            todo_id, /* (4) */
</span><span class="hll">            todo_title,
</span><span class="hll">            finished,
</span><span class="hll">            created_at,
</span><span class="hll">            version
</span>        FROM
            t_todo
        WHERE
            todo_id = #{todoId}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>アンダースコア区切りのカラム名とキャメルケース形式のプロパティ名の違いを吸収するために、AS句の指定が不要になるため、よりシンプルなSQLとなる。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtouseresultmappingbymanual">
<span id="id23"></span><h4><a class="toc-backref" href="#id95">5.2.2.5.2. 検索結果の手動マッピング</a><a class="headerlink" href="#dataaccessmybatis3howtouseresultmappingbymanual" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3では、検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)のカラムとJavaBeanのプロパティの対応付けを、
マッピングファイルに定義する事で、手動で解決する仕組みを用意している。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>手動マッピングの特徴について</strong></p>
<p>手動マッピングを使用すると、検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)のカラムとJavaBeanのプロパティの対応付けを、
マッピングファイルに１項目ずつ定義することになる。
そのため、マッピングの柔軟性が非常に高く、より複雑なマッピングを実現する事ができる点が特徴である。</p>
<p>手動マッピングは、</p>
<blockquote>
<div><ul class="simple">
<li>アプリケーションが扱うデータモデル(JavaBean)と物理テーブルのレイアウトが一致しない</li>
<li>JavaBeanがネスト構造になっている(別のJavaBeanをネストしている)</li>
</ul>
</div></blockquote>
<p>といったケースにおいて、検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)のカラムとJavaBeanのプロパティをマッピングする際に力を発揮するマッピング方法である。</p>
<p class="last">また、自動マッピングに比べて効率的にマッピングを行う事ができる。
処理の効率性を優先するアプリケーションの場合は、自動マッピングの代わりに手動マッピングを使用した方がよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">以下に、手動マッピングを使用して検索結果をJavaBeanにマッピングする実装例を示す。</div>
<div class="line">ここでは、手動マッピングの使用方法を示す事が目的なので、自動マッピングでもマッピング可能なもっともシンプルなパターンを例に、説明を行う。</div>
</div>
<p>実践的なマッピングの実装例については、</p>
<ul class="simple">
<li>「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#Advanced_Result_Maps">MyBatis 3 REFERENCE DOCUMENTATION(Mapper XML Files-Advanced Result Maps-)</a> 」</li>
<li>「<a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatonce"><em>関連Entityを１回のSQLで取得する方法について</em></a>」</li>
<li>「<a class="reference internal" href="#dataaccessmybatis3appendixnestedselect"><em>関連EntityをネストしたSQLを使用して取得する方法について</em></a>」</li>
</ul>
<p>を参照されたい。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/com/example/domain/repository/todo/TodoRepository.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;todoResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">column=</span><span class="s">&quot;todo_id&quot;</span> <span class="na">property=</span><span class="s">&quot;todoId&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;todo_title&quot;</span> <span class="na">property=</span><span class="s">&quot;todoTitle&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;finished&quot;</span> <span class="na">property=</span><span class="s">&quot;finished&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;created_at&quot;</span> <span class="na">property=</span><span class="s">&quot;createdAt&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;version&quot;</span> <span class="na">property=</span><span class="s">&quot;version&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;/resultMap&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;todoResultMap&quot;</span><span class="nt">&gt;</span>
</span>        SELECT
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        FROM
            t_todo
        WHERE
            todo_id = #{todoId}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&lt;resultMap&gt;</span></tt>要素に、検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)とJavaBeanのマッピング定義を行う。</p>
<p><tt class="docutils literal"><span class="pre">id</span></tt>属性にマッピングを識別するためのIDを、<tt class="docutils literal"><span class="pre">type</span></tt>属性にマッピングするJavaBeanのクラス名(又はエイリアス名)を指定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">&lt;resultMap&gt;</span></tt>要素の詳細は、「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#resultMap">MyBatis 3 REFERENCE DOCUMENTATION(Mapper XML Files-resultMap-)</a> 」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)のID(PK)のカラムとJavaBeanのプロパティのマッピングを行う。</p>
<p>ID(PK)のマッピングは、<tt class="docutils literal"><span class="pre">&lt;id&gt;</span></tt>要素を使って指定する。
<tt class="docutils literal"><span class="pre">column</span></tt>属性には検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)のカラム名、<tt class="docutils literal"><span class="pre">property</span></tt>属性にはJavaBeanのプロパティ名を指定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">&lt;id&gt;</span></tt>要素の詳細は、「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#id__result">MyBatis 3 REFERENCE DOCUMENTATION(Mapper XML Files-id &amp; result-)</a> 」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)のID(PK)以外のカラムとJavaBeanのプロパティのマッピングを行う。</p>
<p>ID(PK)以外のマッピングは、<tt class="docutils literal"><span class="pre">&lt;result&gt;</span></tt>要素を使って指定する。
<tt class="docutils literal"><span class="pre">column</span></tt>属性には検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)のカラム名、<tt class="docutils literal"><span class="pre">property</span></tt>属性にはJavaBeanのプロパティ名を指定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">&lt;result&gt;</span></tt>要素の詳細は、「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#id__result">MyBatis 3 REFERENCE DOCUMENTATION(Mapper XML Files-id &amp; result-)</a> 」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">&lt;select&gt;</span></tt>要素の<tt class="docutils literal"><span class="pre">resultMap</span></tt>属性に、適用するマッピング定義のIDを指定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>id要素とresult要素の使い分けについて</strong></p>
<p><tt class="docutils literal"><span class="pre">&lt;id&gt;</span></tt>要素と<tt class="docutils literal"><span class="pre">&lt;result&gt;</span></tt>要素は、
どちらも検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)のカラムとJavaBeanのプロパティをマッピングするための要素であるが、
ID(PK)カラムに対してマッピングは、<tt class="docutils literal"><span class="pre">&lt;id&gt;</span></tt>要素を使うことを推奨する。</p>
<p class="last">理由は、ID(PK)カラムに対して<tt class="docutils literal"><span class="pre">&lt;id&gt;</span></tt>要素を使用してマッピングを行うと、MyBatis3が提供しているオブジェクトのキャッシュ制御の処理や、
関連オブジェクトへのマッピングの処理のパフォーマンスを、全体的に向上させることが出来るためである。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="entity">
<span id="dataaccessmybatis3howtousefind"></span><h3><a class="toc-backref" href="#id96">5.2.2.6. Entityの検索処理</a><a class="headerlink" href="#entity" title="Permalink to this headline">¶</a></h3>
<p>Entityの検索処理の実装方法について、目的別に説明を行う。</p>
<p>Entityの検索処理の実装方法の説明を読む前に、「<a class="reference internal" href="#dataaccessmybatis3howtouseresultsetmapping"><em>検索結果とJavaBeanのマッピング方法</em></a>」を一読して頂きたい。</p>
<p>以降の説明では、アンダースコア区切りのカラム名をキャメルケース形式のプロパティ名に自動でマッピングする設定を有効にした場合の実装例となる。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration</span>
<span class="cp">  PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
<span class="cp">  &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>

    <span class="nt">&lt;settings&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;mapUnderscoreToCamelCase&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3howtousefindone">
<span id="id25"></span><h4><a class="toc-backref" href="#id97">5.2.2.6.1. 単一キーのEntityの取得</a><a class="headerlink" href="#dataaccessmybatis3howtousefindone" title="Permalink to this headline">¶</a></h4>
<p>PKが単一カラムで構成されるテーブルより、PKを指定してEntityを1件取得する際の実装例を以下に示す。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="n">Todo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、引数に指定された<tt class="docutils literal"><span class="pre">todoId</span></tt>(PK)に一致するTodoオブジェクトを1件取得するためのメソッドとして、
<tt class="docutils literal"><span class="pre">findOne</span></tt>メソッドを定義している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        /* (3) */
        SELECT
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        FROM
            t_todo
        /* (4) */
        WHERE
            todo_id = #{todoId}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">select</span></tt>要素の中に、検索結果が0～1件となるSQLを実装する。</p>
<p>上記例では、ID(PK)が一致するレコードを取得するSQLを実装している。</p>
<p class="last"><tt class="docutils literal"><span class="pre">select</span></tt>要素の詳細については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#select">MyBatis3 REFERENCE DOCUMENTATION (Mapper XML Files-select-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>id</td>
<td>Repositoryインタフェースに定義したメソッドのメソッド名を指定する。</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>parameterType</td>
<td>パラメータ完全修飾クラス名(又はエイリアス名)を指定する。</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>resultType</td>
<td><p class="first">検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)をマッピングするJavaBeanの完全修飾クラス名(又はエイリアス名)を指定する。</p>
<p class="last">手動マッピングを使用する場合は、<tt class="docutils literal"><span class="pre">resultType</span></tt>属性の代わりに<tt class="docutils literal"><span class="pre">resultMap</span></tt>属性を使用して、
適用するマッピング定義を指定する。
手動マッピングについては、「<a class="reference internal" href="#dataaccessmybatis3howtouseresultmappingbymanual"><em>検索結果の手動マッピング</em></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first">取得対象のカラムを指定する。</p>
<p class="last">上記例では、検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)をJavaBeanへマッピングする方法として、自動マッピングを使用している。
自動マッピングについては、「<a class="reference internal" href="#dataaccessmybatis3howtouseresultmappingbyauto"><em>検索結果の自動マッピング</em></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first">WHERE句に検索条件を指定する。</p>
<p>検索条件にバインドする値は、<tt class="docutils literal"><span class="pre">#{variableName}</span></tt>形式のバインド変数として指定する。上記例では、
<tt class="docutils literal"><span class="pre">#{todoId}</span></tt>がバインド変数となる。</p>
<p class="last">Repositoryインタフェースの引数の型が<tt class="docutils literal"><span class="pre">String</span></tt>のような単純型の場合は、
バインド変数名は任意の名前でよいが、引数の型がJavaBeanの場合は、
バインド変数名にはJavaBeanのプロパティ名を指定する必要がある。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>単純型のバインド変数名について</strong></p>
<p class="last"><tt class="docutils literal"><span class="pre">String</span></tt>のような単純型の場合は、バインド変数名に制約はないが、メソッドの引数名と同じ値にしておくことを推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>ServiceクラスにRepositoryをDIし、Repositoryインターフェースのメソッドを呼び出す。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.repository.todo.TodoRepository</span><span class="o">;</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="c1">// (5)</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="o">;</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">getTodo</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// (6)</span>
        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">todo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// (7)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ResourceNotFoundException</span><span class="o">(</span><span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span>
                    <span class="s">&quot;e.ex.td.5001&quot;</span><span class="o">,</span> <span class="n">todoId</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>ServiceクラスにRepositoryインターフェースをDIする。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>Repositoryインターフェースのメソッドを呼び出し、Entityを1件取得する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><p class="first">検索結果が0件の場合は<tt class="docutils literal"><span class="pre">null</span></tt>が返却されるため、
必要に応じてEntityが取得できなかった時の処理を実装する。</p>
<p class="last">上記例では、Entityが取得できなかった場合は、リソース未検出エラーを発生させている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id26">
<h4><a class="toc-backref" href="#id98">5.2.2.6.2. 複合キーのEntityの取得</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">PKが複数カラムで構成されるテーブルより、PKを指定してEntityを1件取得する際の実装例を以下に示す。</div>
<div class="line">基本的な構成は、PKが単一カラムで構成される場合と同じであるが、Repositoryインタフェースのメソッド引数の指定方法が異なる。</div>
</div>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">order</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.OrderHistory</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderHistoryRepository</span> <span class="o">{</span>

   <span class="c1">// (1)</span>
   <span class="n">OrderHistory</span> <span class="nf">findOne</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;orderId&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">orderId</span><span class="o">,</span>
           <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;historyId&quot;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">historyId</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">PKを構成するカラムに対応する引数を、メソッドに定義する。</p>
<p class="last">上記例では、受注の変更履歴を管理するテーブルのPKとして、<tt class="docutils literal"><span class="pre">orderId</span></tt>と<tt class="docutils literal"><span class="pre">historyId</span></tt>を引数に定義している。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>メソッド引数を複数指定する場合のバインド変数名について</strong></p>
<p>Repositoryインタフェースのメソッド引数を複数指定する場合は、引数に<tt class="docutils literal"><span class="pre">&#64;org.apache.ibatis.annotations.Param</span></tt>アノテーションを指定することを推奨する。
<tt class="docutils literal"><span class="pre">&#64;Param</span></tt>アノテーションの<tt class="docutils literal"><span class="pre">value</span></tt>属性には、マッピングファイルから値を参照する際に指定する「バインド変数名」を指定する。</p>
<p>上記例だと、マッピングファイルから<tt class="docutils literal"><span class="pre">#{orderId}</span></tt>及び<tt class="docutils literal"><span class="pre">#{historyId}</span></tt>と指定することで、引数に指定された値をSQLにバインドする事ができる。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.order.OrderHistoryRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">resultType=</span><span class="s">&quot;OrderHistory&quot;</span><span class="nt">&gt;</span>
        SELECT
            order_id,
            history_id,
            order_name,
            operation_type,
            created_at&quot;
        FROM
            t_order_history
        WHERE
            order_id = #{orderId}
        AND
            history_id = #{historyId}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p><tt class="docutils literal"><span class="pre">&#64;Param</span></tt>アノテーションの指定は必須ではないが、
指定しないと以下に示すような機械的なバインド変数名を指定する必要がある。
<tt class="docutils literal"><span class="pre">&#64;Param</span></tt>アノテーションの指定しない場合のバインド変数名は、「&#8221;param&#8221; + 引数の宣言位置(1から開始)」という名前になるため、
ソースコードのメンテナンス性及び可読性を損なう要因となる。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- omitted --&gt;</span>

WHERE
    order_id = #{param1}
AND
    history_id = #{param2}

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousefindmultiple">
<span id="id27"></span><h4><a class="toc-backref" href="#id99">5.2.2.6.3. Entityの検索</a><a class="headerlink" href="#dataaccessmybatis3howtousefindmultiple" title="Permalink to this headline">¶</a></h4>
<p>検索結果が0～N件となるSQLを発行し、Entityを複数件取得する際の実装例を以下に示す。</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">検索結果が大量のデータになる可能性がある場合は、「<a class="reference internal" href="#dataaccessmybatis3howtoextendresulthandler"><em>ResultHandlerの実装</em></a>」の利用を検討すること。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Entityを複数件取得するためのメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">findAllByCriteria</span><span class="o">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、検索条件を保持するJavaBean(<tt class="docutils literal"><span class="pre">TodoCriteria</span></tt>)に一致するTodoオブジェクトをリスト形式で複数件取得するためのメソッドとして、
<tt class="docutils literal"><span class="pre">findAllByCriteria</span></tt>メソッドを定義している。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、メソッドの返り値を<tt class="docutils literal"><span class="pre">java.util.List</span></tt>を指定しているが、
検索結果を<tt class="docutils literal"><span class="pre">java.util.Map</span></tt>として受け取る事も出来る。</p>
<p><tt class="docutils literal"><span class="pre">Map</span></tt>で受け取る場合は、</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">Map</span></tt>の<tt class="docutils literal"><span class="pre">key</span></tt>にはPKの値</li>
<li><tt class="docutils literal"><span class="pre">Map</span></tt>の<tt class="docutils literal"><span class="pre">value</span></tt>ははEntityオブジェクト</li>
</ul>
<p>を格納する事になる。</p>
<p>検索結果を<tt class="docutils literal"><span class="pre">Map</span></tt>で受け取る場合、<tt class="docutils literal"><span class="pre">java.util.HashMap</span></tt>のインスタンスが返却されるため、
<tt class="docutils literal"><span class="pre">Map</span></tt>の並び順は保証されないという点に注意すること。</p>
<p>以下に、実装例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.MapKey</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="nd">@MapKey</span><span class="o">(</span><span class="s">&quot;todoId&quot;</span><span class="o">)</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Todo</span><span class="o">&gt;</span> <span class="n">findAllByCriteria</span><span class="o">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">検索結果を<tt class="docutils literal"><span class="pre">Map</span></tt>で受け取る場合は、<tt class="docutils literal"><span class="pre">&#64;org.apache.ibatis.annotations.MapKey</span></tt>アノテーションをメソッドに指定する。
アノテーションの<tt class="docutils literal"><span class="pre">value</span></tt>属性には、<tt class="docutils literal"><span class="pre">Map</span></tt>の<tt class="docutils literal"><span class="pre">key</span></tt>として扱うプロパティ名を指定する。
上記例では、TodoオブジェクトのPK(<tt class="docutils literal"><span class="pre">todoId</span></tt>)を指定している。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>検索条件を保持するJavaBeanを作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoCriteria</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">title</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createdAt</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTitle</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">title</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTitle</span><span class="o">(</span><span class="n">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getCreatedAt</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createdAt</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreatedAt</span><span class="o">(</span><span class="n">Date</span> <span class="n">createdAt</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>検索条件を保持するためのJavaBeanの作成について</strong></p>
<p>検索条件を保持するためのJavaBeanの作成は必須ではないが、格納されている値の役割が明確になるため、
JavaBeanを作成することを推奨する。ただし、JavaBeanを作成しない方法で実装してもよい。</p>
<p><strong>アーキテクトは、JavaBeanを作成するケースと作成しないケースの判断基準をプログラマに対して明確に示すことで、
アプリケーション全体として統一された作りになるようにすること。</strong></p>
<p>JavaBeanを作成しない場合の実装例を以下に示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">findAllByCriteria</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;title&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">title</span><span class="o">,</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;createdAt&quot;</span><span class="o">)</span> <span class="n">Date</span> <span class="n">createdAt</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<p class="last">JavaBeanを作成しない場合は、検索条件を1項目ずつ引数に宣言し、
<tt class="docutils literal"><span class="pre">&#64;Param</span></tt>アノテーションの<tt class="docutils literal"><span class="pre">value</span></tt>属性に「バインド変数名」を指定する。
上記のようなメソッドを定義することで、複数の検索条件をSQLに引き渡すことができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            todo_id,</span>
<span class="cp">            todo_title,</span>
<span class="cp">            finished,</span>
<span class="cp">            created_at,</span>
<span class="cp">            version</span>
<span class="cp">        FROM</span>
<span class="cp">            t_todo</span>
<span class="cp">        WHERE</span>
<span class="cp">            todo_title LIKE #{title} || &#39;%&#39; ESCAPE &#39;~&#39;</span>
<span class="cp">        AND</span>
<span class="cp">            created_at &lt; #{createdAt}</span>
<span class="cp">        /* (3) */</span>
<span class="cp">        ORDER BY</span>
<span class="cp">            todo_id</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">select</span></tt>要素の中に、検索結果が0～N件となるSQLを実装する。</p>
<p class="last">上記例では、<tt class="docutils literal"><span class="pre">todo_title</span></tt>と<tt class="docutils literal"><span class="pre">created_at</span></tt>が指定した条件に一致するTodoレコードを取得する実装している。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">ソート条件を指定する。</p>
<p class="last">複数件のレコードを取得する場合は、ソート条件を指定する。
特に画面に表示するレコードを取得するSQLでは、ソート条件の指定は必須である。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>CDATAセクションの活用方法について</strong></p>
<p>SQL内にXMLのエスケープが必要な文字(<tt class="docutils literal"><span class="pre">&quot;&lt;&quot;</span></tt>や<tt class="docutils literal"><span class="pre">&quot;&gt;&quot;</span></tt>など)を指定する場合は、
CDATAセクションを使用すると、SQLの可読性を保つことができる。
CDATAセクションを使用しない場合は、<tt class="docutils literal"><span class="pre">&quot;&amp;lt;&quot;</span></tt>や<tt class="docutils literal"><span class="pre">&quot;&amp;gt;&quot;</span></tt>といったエンティティ参照文字を指定する必要があり、
SQLの可読性を損なう要因となる。</p>
<p class="last">上記例では、<tt class="docutils literal"><span class="pre">created_at</span></tt>に対する条件として<tt class="docutils literal"><span class="pre">&quot;&lt;&quot;</span></tt>を使用しているため、CDATAセクションを指定している。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousecount">
<span id="id28"></span><h4><a class="toc-backref" href="#id100">5.2.2.6.4. Entityの件数の取得</a><a class="headerlink" href="#dataaccessmybatis3howtousecount" title="Permalink to this headline">¶</a></h4>
<p>検索条件に一致するEntityの件数を取得する際の実装例を以下に示す。</p>
<ul class="simple">
<li>検索条件に一致するEntityの件数を取得するためのメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">long</span> <span class="nf">countByFinished</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">finished</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">件数を取得ためのメソッドの返り値は、数値型(<tt class="docutils literal"><span class="pre">int</span></tt>や<tt class="docutils literal"><span class="pre">long</span></tt>など)を指定する。</p>
<p class="last">上記例では、<tt class="docutils literal"><span class="pre">long</span></tt>を指定している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByFinished&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;_boolean&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_long&quot;</span><span class="nt">&gt;</span>
        SELECT
            COUNT(*)
        FROM
            t_todo
        WHERE
            finished = #{finished}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">件数を取得するSQLを実行する。</p>
<p><tt class="docutils literal"><span class="pre">resultType</span></tt>属性には、返り値の型を指定する。</p>
<p class="last">上記例では、プリミティブ型の<tt class="docutils literal"><span class="pre">long</span></tt>を指定するためのエイリアス名を指定している。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>プリミティブ型のエイリアス名について</strong></p>
<p class="last">プリミティブ型のエイリアス名は、先頭に<tt class="docutils literal"><span class="pre">&quot;_&quot;</span></tt>(アンダースコア)を指定する必要がある。
<tt class="docutils literal"><span class="pre">&quot;_&quot;</span></tt>(アンダースコア)を指定しない場合は、プリミティブのラッパ型(<tt class="docutils literal"><span class="pre">java.lang.Long</span></tt>など)として扱われる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="entity-mybatis3">
<span id="dataaccessmybatis3howtousefindpageusingmybatisfunction"></span><h4><a class="toc-backref" href="#id101">5.2.2.6.5. Entityのページネーション検索(MyBatis3標準方式)</a><a class="headerlink" href="#entity-mybatis3" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3の取得範囲指定機能を使用してEntityを検索する際の実装例を以下に示す。</p>
<p>MyBatisでは取得範囲を指定するクラスとして<tt class="docutils literal"><span class="pre">org.apache.ibatis.session.RowBounds</span></tt>クラスを用意されており、
SQLに取得範囲の条件を記述する必要がない。</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>検索条件に一致するデータ件数が多くなる場合の注意点について</strong></p>
<p>MyBatis3標準の方式は、検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)のカーソルを移動することで、取得範囲外のデータをスキップする方式である。
そのため、検索条件に一致するデータ件数に比例して、メモリ枯渇やカーソル移動処理の性能劣化が発生する可能性が高くなる。</p>
<p>カーソルの移動処理は、JDBCの結果セット型に応じて以下の２種類がサポートされており、デフォルトの動作は、
JDBCドライバのデフォルトの結果セット型に依存する。</p>
<ul class="simple">
<li>結果セット型が<tt class="docutils literal"><span class="pre">FORWARD_ONLY</span></tt>の場合は、<tt class="docutils literal"><span class="pre">ResultSet#next()</span></tt>を繰返し呼び出して取得範囲外のデータをスキップする。</li>
<li>結果セット型が<tt class="docutils literal"><span class="pre">SCROLL_SENSITIVE</span></tt>又は<tt class="docutils literal"><span class="pre">SCROLL_INSENSITIVE</span></tt>の場合は、<tt class="docutils literal"><span class="pre">ResultSet#absolute(int)</span></tt>を呼び出して取得範囲外のデータをスキップする。</li>
</ul>
<p><tt class="docutils literal"><span class="pre">ResultSet#absolute(int)</span></tt>を使用することで、性能劣化を最小限に抑える事ができる可能性はあるが、
JDBCドライバの実装次第であり、内部で<tt class="docutils literal"><span class="pre">ResultSet#next()</span></tt>と同等の処理が行われている場合は、
メモリ枯渇や性能劣化が発生する可能性を抑える事はできない。</p>
<p class="last"><strong>検索条件に一致するデータ件数が多くなる可能性がある場合は、MyBatis3標準方式のページネーション検索ではなく、
SQL絞り込み方式の採用を検討した方がよい。</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Entityのページネーション検索を行うためのメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">ackage</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.ibatis.session.RowBounds</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">long</span> <span class="nf">countByCriteria</span><span class="o">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="o">);</span>

    <span class="c1">// (2)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">findPageByCriteria</span><span class="o">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="o">,</span>
        <span class="n">RowBounds</span> <span class="n">rowBounds</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>検索条件に一致するEntityの総件数を取得するメソッドを定義する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">検索条件に一致するEntityの中から、取得範囲のEntityを抽出メソッドを定義する。</p>
<p class="last">定義したメソッドの引数として、取得範囲の情報(offsetとlimit)を保持する<tt class="docutils literal"><span class="pre">RowBounds</span></tt>を指定する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">マッピングファイルにSQLを定義する。</p>
<p>検索結果から該当範囲のレコードを抽出する処理は、MyBatis3が行うため、SQLで取得範囲のレコードを絞り込む必要がない。</p>
</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_long&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            COUNT(*)</span>
<span class="cp">        FROM</span>
<span class="cp">            t_todo</span>
<span class="cp">        WHERE</span>
<span class="cp">            todo_title LIKE #{title} || &#39;%&#39; ESCAPE &#39;~&#39;</span>
<span class="cp">        AND</span>
<span class="cp">            created_at &lt; #{createdAt}</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            todo_id,</span>
<span class="cp">            todo_title,</span>
<span class="cp">            finished,</span>
<span class="cp">            created_at,</span>
<span class="cp">            version</span>
<span class="cp">        FROM</span>
<span class="cp">            t_todo</span>
<span class="cp">        WHERE</span>
<span class="cp">            todo_title LIKE #{title} || &#39;%&#39; ESCAPE &#39;~&#39;</span>
<span class="cp">        AND</span>
<span class="cp">            created_at &lt; #{createdAt}</span>
<span class="cp">        ORDER BY</span>
<span class="cp">            todo_id</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>WHERE句の共通化について</strong></p>
<p>ページネーション検索を実現する場合、「検索条件に一致するEntityの総件数を取得するSQL」と
「 検索条件に一致するEntityのリストを取得するSQL」で指定するWHERE句は、
MyBatis3のinclude機能を使って共通化することを推奨する。</p>
<p>上記SQLのWHERE句を共通化した場合、以下のような定義となる。
詳細は、「<a class="reference internal" href="#dataaccessmybatis3howtoextendsqlshare"><em>SQL文の共有</em></a>」を参照されたい。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span class="hll"><span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">&gt;</span>
</span>    <span class="cp">&lt;![CDATA[</span>
<span class="cp">    WHERE</span>
<span class="cp">        todo_title LIKE #{title} || &#39;%&#39; ESCAPE &#39;~&#39;</span>
<span class="cp">    AND</span>
<span class="cp">        created_at &lt; #{createdAt}</span>
<span class="cp">    ]]&gt;</span>
<span class="nt">&lt;/sql&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_long&quot;</span><span class="nt">&gt;</span>
    SELECT
        COUNT(*)
    FROM
        t_todo
<span class="hll">    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">/&gt;</span>
</span><span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
<span class="hll">    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">/&gt;</span>
</span>    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>結果セット型を明示的に指定する方法について</strong></p>
<p>結果セット型を明示的に指定する場合は、<tt class="docutils literal"><span class="pre">resultType</span></tt>属性に結果セット型を指定する。
JDBCドライバのデフォルトの結果セット型が、<tt class="docutils literal"><span class="pre">FORWARD_ONLY</span></tt>の場合は、<tt class="docutils literal"><span class="pre">SCROLL_INSENSITIVE</span></tt>を指定することを推奨する。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span>
<span class="hll">    <span class="na">resultSetType=</span><span class="s">&quot;SCROLL_INSENSITIVE&quot;</span><span class="nt">&gt;</span>
</span>    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Serviceクラスにページネーション検索処理を実装する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="c1">// omitted</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">searchTodos</span><span class="o">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// (3)</span>
        <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">countByCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">total</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// (4)</span>
            <span class="n">RowBounds</span> <span class="n">rowBounds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RowBounds</span><span class="o">(</span><span class="n">pageable</span><span class="o">.</span><span class="na">getOffset</span><span class="o">(),</span>
                <span class="n">pageable</span><span class="o">.</span><span class="na">getPageSize</span><span class="o">());</span>
            <span class="c1">// (5)</span>
            <span class="n">todos</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findPageByCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">,</span> <span class="n">rowBounds</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// (6)</span>
            <span class="n">todos</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// (7)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;&gt;(</span><span class="n">todos</span><span class="o">,</span> <span class="n">pageable</span><span class="o">,</span> <span class="n">total</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>まず、検索条件に一致するEntityの総件数を取得する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">検索条件に一致するEntityが存在する場合は、ページネーション検索の取得範囲を指定する<tt class="docutils literal"><span class="pre">RowBounds</span></tt>オブジェクトを生成する。</p>
<p><tt class="docutils literal"><span class="pre">RowBounds</span></tt>の第1引数(<tt class="docutils literal"><span class="pre">offset</span></tt>)には「スキップ件数」、
第２引数(<tt class="docutils literal"><span class="pre">limit</span></tt>)には「最大取得件数」を指定する。
引数に指定する値、Spring Data Commonsから提供されている<tt class="docutils literal"><span class="pre">Pageable</span></tt>オブジェクトの
<tt class="docutils literal"><span class="pre">getOffset</span></tt>メソッドと<tt class="docutils literal"><span class="pre">getPageSize</span></tt>メソッドを呼び出して取得した値を指定すればよい。</p>
<p>具体的には、</p>
<ul class="simple">
<li>offsetに<tt class="docutils literal"><span class="pre">0</span></tt>、limitに<tt class="docutils literal"><span class="pre">20</span></tt>を指定した場合、1～20件目</li>
<li>offsetに<tt class="docutils literal"><span class="pre">20</span></tt>、limitに<tt class="docutils literal"><span class="pre">20</span></tt>を指定した場合、21～40件目</li>
</ul>
<p class="last">が取得範囲となる。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>Repositoryのメソッドを呼び出し、検索条件に一致した取得範囲のEntityを取得する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>検索条件に一致するEntityが存在しない場合は、空のリストを検索結果に設定する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>ページ情報(<tt class="docutils literal"><span class="pre">org.springframework.data.domain.PageImpl</span></tt>)を作成し返却する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="entity-sql">
<span id="dataaccessmybatis3howtousefindpageusingsqlfilter"></span><h4><a class="toc-backref" href="#id102">5.2.2.6.6. Entityのページネーション検索(SQL絞り込み方式)</a><a class="headerlink" href="#entity-sql" title="Permalink to this headline">¶</a></h4>
<p>データベースから提供されている範囲検索の仕組みを使用してEntityを検索する際の実装例を以下に示す。</p>
<p>SQL絞り込み方式は、データベースから提供されている範囲検索の仕組みを使用するため、
MyBatis3標準方式に比べて効率的に取得範囲のEntityを取得することができる。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>検索条件に一致するデータ件数が大量にある場合は、SQL絞り込み方式を採用する事を推奨する。</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Entityのページネーション検索を行うためのメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Pageable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">long</span> <span class="nf">countByCriteria</span><span class="o">(</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;criteria&quot;</span><span class="o">)</span> <span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="o">);</span>

    <span class="c1">// (2)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">findPageByCriteria</span><span class="o">(</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;criteria&quot;</span><span class="o">)</span> <span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="o">,</span>
            <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;pageable&quot;</span><span class="o">)</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>検索条件に一致するEntityの総件数を取得するメソッドを定義する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">検索条件に一致するEntityの中から、取得範囲のEntityを抽出メソッドを定義する。</p>
<p class="last">定義したメソッドの引数として、取得範囲の情報(offsetとlimit)を保持する<tt class="docutils literal"><span class="pre">org.springframework.data.domain.Pageable</span></tt>を指定する。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>引数が1つのメソッドに&#64;Paramアノテーションを指定する理由について</strong></p>
<p>上記例では、引数が1つのメソッド(<tt class="docutils literal"><span class="pre">countByCriteria</span></tt>)に対して<tt class="docutils literal"><span class="pre">&#64;Param</span></tt>アノテーションを指定している。
これは、<tt class="docutils literal"><span class="pre">findPageByCriteria</span></tt>メソッド呼び出し時に実行されるSQLとWHERE句を共通化するためである。</p>
<p><tt class="docutils literal"><span class="pre">&#64;Param</span></tt>アノテーションを使用して引数にバインド変数名を指定することで、
SQL内で指定するバインド変数名のネスト構造を合わせている。</p>
<p class="last">具体的なSQLの実装例については、次に示す。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">マッピングファイルにSQLを定義する。</p>
<p>SQLで取得範囲のレコードを絞り込む。</p>
</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="hll"><span class="cp">        /* (3) */</span>
</span><span class="cp">        WHERE</span>
<span class="cp">            todo_title LIKE #{criteria.title} || &#39;%&#39; ESCAPE &#39;~&#39;</span>
<span class="cp">        AND</span>
<span class="cp">            created_at &lt; #{criteria.createdAt}</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/sql&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_long&quot;</span><span class="nt">&gt;</span>
        SELECT
            COUNT(*)
        FROM
            t_todo
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        SELECT
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        FROM
            t_todo
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span> <span class="nt">/&gt;</span>
        ORDER BY
            todo_id
<span class="hll">        LIMIT
</span><span class="hll">            #{pageable.pageSize} /* (4) */
</span><span class="hll">        OFFSET
</span><span class="hll">            #{pageable.offset}  /* (4) */
</span>    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">countByCriteria</span></tt>と<tt class="docutils literal"><span class="pre">findPageByCriteria</span></tt>メソッドの引数に<tt class="docutils literal"><span class="pre">&#64;Param(&quot;criteria&quot;)</span></tt>を指定しているため、
SQL内で指定するバインド変数名は<tt class="docutils literal"><span class="pre">criteria.フィールド名</span></tt>の形式となる。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">データベースから提供されている範囲検索の仕組みを使用して、必要なレコードのみ抽出する。</p>
<p><tt class="docutils literal"><span class="pre">Pageable</span></tt>オブジェクトの<tt class="docutils literal"><span class="pre">offset</span></tt>には「スキップ件数」、
<tt class="docutils literal"><span class="pre">pageSize</span></tt>には「最大取得件数」が格納されている。</p>
<p class="last">上記例は、データベースとしてH2 Databaseを使用した際の実装例である。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Serviceクラスにページネーション検索処理を実装する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="c1">// omitted</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="o">;</span>

    <span class="c1">// omitted</span>

    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Page</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">searchTodos</span><span class="o">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="o">,</span>
            <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">countByCriteriaForPageable</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">total</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// (5)</span>
            <span class="n">todos</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findPageByCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">,</span>
                    <span class="n">pageable</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">todos</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">PageImpl</span><span class="o">&lt;&gt;(</span><span class="n">todos</span><span class="o">,</span> <span class="n">pageable</span><span class="o">,</span> <span class="n">total</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p class="first">Repositoryのメソッドを呼び出し、検索条件に一致した取得範囲のEntityを取得する。</p>
<p class="last">Repositoryのメソッドを呼び出す際は、引数で受け取った<tt class="docutils literal"><span class="pre">Pageable</span></tt>オブジェクトをそのまま渡せばよい。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousecreate">
<span id="id29"></span><h3><a class="toc-backref" href="#id103">5.2.2.7. Entityの登録処理</a><a class="headerlink" href="#dataaccessmybatis3howtousecreate" title="Permalink to this headline">¶</a></h3>
<p>Entityの登録方法について、目的別に実装例を説明する。</p>
<div class="section" id="entity1">
<span id="dataaccessmybatis3howtousecreateone"></span><h4><a class="toc-backref" href="#id104">5.2.2.7.1. Entityの1件登録</a><a class="headerlink" href="#entity1" title="Permalink to this headline">¶</a></h4>
<p>Entityを1件登録する際の実装例を以下に示す。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">void</span> <span class="nf">create</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、引数に指定されたTodoオブジェクトを1件登録するためのメソッドとして、
<tt class="docutils literal"><span class="pre">create</span></tt>メソッドを定義している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Entityを登録するメソッドの返り値について</strong></p>
<p>Entityを登録するメソッドの返り値は、基本的には<tt class="docutils literal"><span class="pre">void</span></tt>でよい。</p>
<p>ただし、SELECTした結果をINSERTするようなSQLを発行する場合は、
アプリケーション要件に応じて<tt class="docutils literal"><span class="pre">boolean</span></tt>や数値型(<tt class="docutils literal"><span class="pre">int</span></tt>又は<tt class="docutils literal"><span class="pre">long</span></tt>)を返り値とすること。</p>
<ul class="last simple">
<li>返り値として<tt class="docutils literal"><span class="pre">boolean</span></tt>を指定した場合は、登録件数が0件の際は<tt class="docutils literal"><span class="pre">false</span></tt>、登録件数が1件以上の際は<tt class="docutils literal"><span class="pre">true</span></tt>が返却される。</li>
<li>返り値として数値型を指定した場合は、登録件数が返却される。</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        INSERT INTO
            t_todo
        (
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        )
        /* (3) */
        VALUES
        (
            #{todoId},
            #{todoTitle},
            #{finished},
            #{createdAt},
            #{version}
        )
    <span class="nt">&lt;/insert&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">insert要素の中に、INSERTするSQLを実装する。</p>
<p><tt class="docutils literal"><span class="pre">id</span></tt>属性には、Repositoryインタフェースに定義したメソッドのメソッド名を指定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">insert</span></tt>要素の詳細については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#insert_update_and_delete">MyBatis3 REFERENCE DOCUMENTATION (Mapper XML Files-insert, update and delete-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">VALUE句にレコード登録時の設定値を指定する。</p>
<p class="last">VALUE句にバインドする値は、#{variableName}形式のバインド変数として指定する。
上記例では、Repositoryインタフェースの引数としてJavaBean(<tt class="docutils literal"><span class="pre">Todo</span></tt>)を指定しているため、
バインド変数名にはJavaBeanのプロパティ名を指定する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>ServiceクラスにRepositoryをDIし、Repositoryインターフェースのメソッドを呼び出す。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.terasoluna.gfw.common.date.jodatime.JodaTimeDateFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.repository.todo.TodoRepository</span><span class="o">;</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="c1">// (4)</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="n">JodaTimeDateFactory</span> <span class="n">dateFactory</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">create</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// (5)</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setTodoId</span><span class="o">(</span><span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setCreatedAt</span><span class="o">(</span><span class="n">dateFactory</span><span class="o">.</span><span class="na">newDate</span><span class="o">());</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="n">todo</span><span class="o">.</span><span class="na">setVersion</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="c1">// (6)</span>
        <span class="n">todoRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
        <span class="c1">// (7)</span>
        <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>ServiceクラスにRepositoryインターフェースをDIする。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p class="first">引数で渡されたEntityオブジェクトに対して、アプリケーション要件に応じて値を設定する。</p>
<p>上記例では、</p>
<ul class="simple">
<li>IDとして「UUID」</li>
<li>登録日時として「システム日時」</li>
<li>完了フラグに「<tt class="docutils literal"><span class="pre">false</span></tt>: 未完了」</li>
<li>バージョンに「<tt class="docutils literal"><span class="pre">1</span></tt>」</li>
</ul>
<p class="last">を設定している。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>Repositoryインターフェースのメソッドを呼び出し、Entityを1件登録する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><p class="first">登録したEntityを返却する。</p>
<p class="last">Serviceクラスの処理で登録値を設定する場合は、登録したEntityオブジェクトを返り値として返却する事を推奨する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousegenid">
<span id="id30"></span><h4><a class="toc-backref" href="#id105">5.2.2.7.2. キーの生成</a><a class="headerlink" href="#dataaccessmybatis3howtousegenid" title="Permalink to this headline">¶</a></h4>
<p>「<a class="reference internal" href="#dataaccessmybatis3howtousecreateone"><em>Entityの1件登録</em></a>」では、
Serviceクラスでキー(ID)の生成をする実装例になっているが、
MyBatis3では、マッピングファイル内でキーを生成する仕組みが用意されている。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>MyBatis3のキー生成機能の使用ケースについて</strong></p>
<p class="last">キーを生成するために、データベースの機能(関数やID列など)を使用する場合は、
MyBatis3のキー生成機能の仕組みを使用する事を推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>キーの生成方法は、2種類用意されている。</p>
<ul class="simple">
<li>データベースから用意されている関数などを呼び出した結果をキーとして扱う方法</li>
<li>データベースから用意されているID列(IDENTITY型、AUTO_INCREMENT型など) + JDBC3.0から追加された<tt class="docutils literal"><span class="pre">Statement#getGeneratedKeys()</span></tt>を呼び出した結果をキーとして扱う方法</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>まず、データベースから用意されている関数などを呼び出した結果をキーとして扱う方法について説明する。
下記例は、データベースとしてH2 Databaseを使用している。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;selectKey</span> <span class="na">keyProperty=</span><span class="s">&quot;todoId&quot;</span> <span class="na">resultType=</span><span class="s">&quot;string&quot;</span> <span class="na">order=</span><span class="s">&quot;BEFORE&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">            /* (2) */
</span><span class="hll">            SELECT RANDOM_UUID()
</span><span class="hll">        <span class="nt">&lt;/selectKey&gt;</span>
</span>        INSERT INTO
            t_todo
        (
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        )
        VALUES
        (
            #{todoId},
            #{todoTitle},
            #{finished},
            #{createdAt},
            #{version}
        )
    <span class="nt">&lt;/insert&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">selectKey</span></tt>要素の中に、キーを生成するためのSQLを実装する。</p>
<p>上記例では、データベースから提供されている関数を使用してUUIDを取得している。</p>
<p class="last"><tt class="docutils literal"><span class="pre">selectKey</span></tt>の詳細については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#insert_update_and_delete">MyBatis3 REFERENCE DOCUMENTATION (Mapper XML Files-insert, update and delete-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>keyProperty</td>
<td><p class="first">取得したキー値を格納するEntityのプロパティ名を指定する。</p>
<p class="last">上記例では、Entityの<tt class="docutils literal"><span class="pre">todoId</span></tt>プロパティに生成したキーが設定される。</p>
</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>resultType</td>
<td>SQLを発行して取得するキー値の型を指定する。</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>order</td>
<td><p class="first">キー生成用SQLを実行するタイミング(<tt class="docutils literal"><span class="pre">BEFORE</span></tt>又は<tt class="docutils literal"><span class="pre">AFTER</span></tt>)を指定する。</p>
<ul class="last simple">
<li><tt class="docutils literal"><span class="pre">BEFORE</span></tt>を指定した場合、<tt class="docutils literal"><span class="pre">selectKey</span></tt>要素で指定したSQLを実行した結果をEntityに反映した後にINSERT文が実行される。</li>
<li><tt class="docutils literal"><span class="pre">AFTER</span></tt>を指定した場合、INSERT文を実行した後に<tt class="docutils literal"><span class="pre">selectKey</span></tt>要素で指定したSQLを実行され、取得した値がEntityに反映される。</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first">キーを生成するためのSQLを実装する。</p>
<p class="last">上記例では、H2 DatabaseのUUIDを生成する関数を呼び出して、キーを生成している。
キー生成の代表的な実装としては、シーケンスオブジェクトから取得した値を文字列にフォーマットする実装があげられる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>次に、データベースから用意されているID列 + JDBC3.0から追加された<tt class="docutils literal"><span class="pre">Statement#getGeneratedKeys()</span></tt>を呼び出した結果をキーとして扱う方法について説明する。
下記例は、データベースとしてH2 Databaseを使用している。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.audit.AuditLogRepository&quot;</span><span class="nt">&gt;</span>

<span class="hll">    <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span> <span class="na">useGeneratedKeys=</span><span class="s">&quot;true&quot;</span> <span class="na">keyProperty=</span><span class="s">&quot;logId&quot;</span><span class="nt">&gt;</span>
</span>        INSERT INTO
            t_audit_log
        (
            level,
            message,
            created_at,
        )
        VALUES
        (
            #{level},
            #{message},
            #{createdAt},
        )
    <span class="nt">&lt;/insert&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>useGeneratedKeys</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">true</span></tt>を指定すると、ID列+<tt class="docutils literal"><span class="pre">Statement#getGeneratedKeys()</span></tt>を呼び出してキーを取得する機能が利用可能となる。</p>
<p class="last"><tt class="docutils literal"><span class="pre">useGeneratedKeys</span></tt>の詳細については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#insert_update_and_delete">MyBatis3 REFERENCE DOCUMENTATION (Mapper XML Files-insert, update and delete-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>keyProperty</td>
<td><p class="first">データベース上で自動でインクリメントされたキー値を格納するEntityのプロパティ名を指定する。</p>
<p class="last">上記例では、INSERT文実行後に、Entityの<tt class="docutils literal"><span class="pre">logId</span></tt>プロパティに<tt class="docutils literal"><span class="pre">Statement#getGeneratedKeys()</span></tt>で取得したキー値が設定される。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousecreatemultiple">
<span id="id33"></span><h4><a class="toc-backref" href="#id106">5.2.2.7.3. Entityの一括登録</a><a class="headerlink" href="#dataaccessmybatis3howtousecreatemultiple" title="Permalink to this headline">¶</a></h4>
<p>Entityを一括で登録する際の実装例を以下に示す。</p>
<p>Entityを一括で登録する場合は、</p>
<ul class="simple">
<li>複数のレコードを同時に登録するINSERT文を発行する</li>
<li>JDBCのバッチ更新機能を使用する</li>
</ul>
<p>方法がある。</p>
<p>JDBCのバッチ更新機能を使用する方法については、「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatch"><em>バッチモードの利用</em></a>」を参照されたい。</p>
<p>ここでは、複数のレコードを同時に登録するINSERT文を発行するする方法について説明する。
下記例は、データベースとしてH2 Databaseを使用している。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">void</span> <span class="nf">createAll</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、引数に指定されたTodoオブジェクトのリストを一括登録するためのメソッドとして、
<tt class="docutils literal"><span class="pre">createAll</span></tt>メソッドを定義している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;createAll&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;list&quot;</span><span class="nt">&gt;</span>
        INSERT INTO
            t_todo
        (
            todo_id,
            todo_title,
            finished,
            created_at,
            version
        )
        /* (2) */
        VALUES
        /* (3) */
        <span class="nt">&lt;foreach</span> <span class="na">collection=</span><span class="s">&quot;list&quot;</span> <span class="na">item=</span><span class="s">&quot;todo&quot;</span> <span class="na">separator=</span><span class="s">&quot;,&quot;</span><span class="nt">&gt;</span>
        (
            #{todo.todoId},
            #{todo.todoTitle},
            #{todo.finished},
            #{todo.createdAt},
            #{todo.version}
        )
        <span class="nt">&lt;/foreach&gt;</span>
    <span class="nt">&lt;/insert&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td>VALUE句にレコード登録時の設定値を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">foreach</span></tt>要素を使用して、引数で渡されたTodoオブジェクトのリストに対して繰り返し処理を行う。</p>
<p class="last"><tt class="docutils literal"><span class="pre">foreach</span></tt>の詳細については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/dynamic-sql.html#foreach">MyBatis3 REFERENCE DOCUMENTATION (Dynamic SQL-foreach-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>collection</td>
<td><p class="first">処理対象のコレクションを指定する。</p>
<p class="last">上記例では、Repositoryのメソッド引数のリストに対して繰り返し処理を行っている。
Repositoryメソッドの引数に<tt class="docutils literal"><span class="pre">&#64;Param</span></tt>を指定していない場合は、<tt class="docutils literal"><span class="pre">&quot;list&quot;</span></tt>を指定する。
<tt class="docutils literal"><span class="pre">&#64;Param</span></tt>を指定した場合は、<tt class="docutils literal"><span class="pre">&#64;Param</span></tt>の<tt class="docutils literal"><span class="pre">value</span></tt>属性に指定した値を指定する。</p>
</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>item</td>
<td><p class="first">リストの中の1要素を保持するローカル変数名を指定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">foreach</span></tt>要素内のSQLからは、#{ローカル変数名.プロパティ名}の形式でJavaBeanのプロパティにアクセスする事ができる。</p>
</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>separator</td>
<td><p class="first">リスト内の要素間を区切るための文字列を指定する。</p>
<p class="last">上記例では、<tt class="docutils literal"><span class="pre">&quot;,&quot;</span></tt>を指定することで、要素毎のVALUE句を<tt class="docutils literal"><span class="pre">&quot;,&quot;</span></tt>で区切っている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>複数のレコードを同時に登録するSQLを使用する際の注意点</strong></p>
<p class="last">複数のレコードを同時に登録するSQLを実行する場合は、前述の「<a class="reference internal" href="#dataaccessmybatis3howtousegenid"><em>キーの生成</em></a>」を使用することが出来ない。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>以下のようなSQLが生成され、実行される。</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="k">INSERT</span> <span class="k">INTO</span>
    <span class="n">t_todo</span>
<span class="p">(</span>
    <span class="n">todo_id</span><span class="p">,</span>
    <span class="n">todo_title</span><span class="p">,</span>
    <span class="n">finished</span><span class="p">,</span>
    <span class="n">created_at</span><span class="p">,</span>
    <span class="k">version</span>
<span class="p">)</span>
<span class="k">VALUES</span>
<span class="p">(</span>
    <span class="s1">&#39;99243507-1b02-45b6-bfb6-d9b89f044e2d&#39;</span><span class="p">,</span>
    <span class="s1">&#39;todo title 1&#39;</span><span class="p">,</span>
    <span class="k">false</span><span class="p">,</span>
    <span class="s1">&#39;09/17/2014 23:59:59.999&#39;</span><span class="p">,</span>
    <span class="mi">1</span>
<span class="p">)</span>
<span class="p">,</span>
<span class="p">(</span>
    <span class="s1">&#39;66b096f1-791f-412f-9a0a-ee4a3a9186c2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;todo title 2&#39;</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;09/17/2014 23:59:59.999&#39;</span><span class="p">,</span>
    <span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>一括登録するためのSQLは、データベースやバージョンによりサポート状況や文法が異なる。
以下に主要なデータベースのリファレンスページへのリンクを記載しておく。</p>
<ul class="last simple">
<li><a class="reference external" href="http://docs.oracle.com/database/121/SQLRF/statements_9014.htm">Oracle 12c</a></li>
<li><a class="reference external" href="http://www-01.ibm.com/support/knowledgecenter/SSEPGG_10.5.0/com.ibm.db2.luw.sql.ref.doc/doc/r0000970.html">DB2 10.5</a></li>
<li><a class="reference external" href="http://www.postgresql.org/docs/9.3/static/sql-insert.html">PostgreSQL 9.3</a></li>
<li><a class="reference external" href="http://dev.mysql.com/doc/refman/5.7/en/insert.html">MySQL 5.7</a></li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtouseupdate">
<span id="id34"></span><h3><a class="toc-backref" href="#id107">5.2.2.8. Entityの更新処理</a><a class="headerlink" href="#dataaccessmybatis3howtouseupdate" title="Permalink to this headline">¶</a></h3>
<p>Entityの更新方法について、目的別に実装例を説明する。</p>
<div class="section" id="dataaccessmybatis3howtouseupdateone">
<span id="id35"></span><h4><a class="toc-backref" href="#id108">5.2.2.8.1. Entityの1件更新</a><a class="headerlink" href="#dataaccessmybatis3howtouseupdateone" title="Permalink to this headline">¶</a></h4>
<p>Entityを1件更新する際の実装例を以下に示す。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>以降の説明では、バージョンカラムを使用して楽観ロックを行う実装例となっているが、
楽観ロックの必要がない場合は、楽観ロック関連の処理を行う必要はない。</p>
<p class="last">排他制御の詳細については、「<a class="reference internal" href="ExclusionControl.html"><em>排他制御</em></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">boolean</span> <span class="nf">update</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、引数に指定されたTodoオブジェクトを1件更新するためのメソッドとして、
<tt class="docutils literal"><span class="pre">update</span></tt>メソッドを定義している。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p></p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Entityを1件更新するメソッドの返り値について</strong></p>
<p>Entityを1件更新するメソッドの返り値は、基本的には<tt class="docutils literal"><span class="pre">boolean</span></tt>でよい。</p>
<p>ただし、更新結果が複数件になった場合にデータ不整合エラーとして扱う必要がある場合は、
数値型(<tt class="docutils literal"><span class="pre">int</span></tt>又は<tt class="docutils literal"><span class="pre">long</span></tt>)を返り値にし、更新件数が1件であることをチェックする必要がある。
主キーが更新条件となっている場合は、更新結果が複数件になる事はないので、<tt class="docutils literal"><span class="pre">boolean</span></tt>でよい。</p>
<ul class="last simple">
<li>返り値として<tt class="docutils literal"><span class="pre">boolean</span></tt>を指定した場合は、更新件数が0件の際は<tt class="docutils literal"><span class="pre">false</span></tt>、更新件数が1件以上の際は<tt class="docutils literal"><span class="pre">true</span></tt>が返却される。</li>
<li>返り値として数値型を指定した場合は、更新件数が返却される。</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;update&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        UPDATE
            t_todo
        SET
            todo_title = #{todoTitle},
            finished = #{finished},
            version = version + 1
        WHERE
            todo_id = #{todoId}
        AND
            version = #{version}
    <span class="nt">&lt;/update&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">update</span></tt>要素の中に、UPDATEするSQLを実装する。</p>
<p><tt class="docutils literal"><span class="pre">id</span></tt>属性には、Repositoryインタフェースに定義したメソッドのメソッド名を指定する。</p>
<p><tt class="docutils literal"><span class="pre">update</span></tt>要素の詳細については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#insert_update_and_delete">MyBatis3 REFERENCE DOCUMENTATION (Mapper XML Files-insert, update and delete-)</a>」を参照されたい。</p>
<p class="last">SET句及びWHERE句にバインドする値は、#{variableName}形式のバインド変数として指定する。
上記例では、Repositoryインタフェースの引数としてJavaBean(<tt class="docutils literal"><span class="pre">Todo</span></tt>)を指定しているため、
バインド変数名にはJavaBeanのプロパティ名を指定する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>ServiceクラスにRepositoryをDIし、Repositoryインターフェースのメソッドを呼び出す。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.repository.todo.TodoRepository</span><span class="o">;</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">update</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// (4)</span>
        <span class="n">Todo</span> <span class="n">currentTodo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">getTodoId</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currentTodo</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">currentTodo</span><span class="o">.</span><span class="na">getVersion</span><span class="o">()</span> <span class="o">!=</span> <span class="n">todo</span><span class="o">.</span><span class="na">getVersion</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ObjectOptimisticLockingFailureException</span><span class="o">(</span><span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">todo</span>
                    <span class="o">.</span><span class="na">getTodoId</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">// (5)</span>
        <span class="n">currentTodo</span><span class="o">.</span><span class="na">setTodoTitle</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">getTodoTitle</span><span class="o">());</span>
        <span class="n">currentTodo</span><span class="o">.</span><span class="na">setFinished</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">isFinished</span><span class="o">());</span>

        <span class="c1">// (6)</span>
        <span class="kt">boolean</span> <span class="n">updated</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">currentTodo</span><span class="o">);</span>
        <span class="c1">// (7)</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">updated</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ObjectOptimisticLockingFailureException</span><span class="o">(</span><span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                    <span class="n">currentTodo</span><span class="o">.</span><span class="na">getTodoId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">currentTodo</span><span class="o">.</span><span class="na">setVersion</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">getVersion</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">currentTodo</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>ServiceクラスにRepositoryインターフェースをDIする。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">更新対象のEntityをデータベースより取得する。</p>
<p class="last">上記例では、Entityが更新されている場合(レコードが削除されている場合又はバージョンが更新されている場合)は、
Spring Frameworkから提供されている楽観ロック例外(<tt class="docutils literal"><span class="pre">org.springframework.orm.ObjectOptimisticLockingFailureException</span></tt>)を発生させている。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p class="first">更新対象のEntityに対して、更新内容を反映する。</p>
<p class="last">上記例では、「タイトル」「完了フラグ」を反映している。更新項目が少ない場合は上記実装例のままでもよいが、
更新項目が多い場合は、「<a class="reference internal" href="Utilities/Dozer.html"><em>Beanマッピング(Dozer)</em></a>」を使用することを推奨する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>Repositoryインターフェースのメソッドを呼び出し、Entityを1件更新する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><p class="first">Entityの更新結果を判定する。</p>
<p class="last">上記例では、Entityが更新されなかった場合(レコードが削除されている場合又はバージョンが更新されている場合)は、
Spring Frameworkから提供されている楽観ロック例外(<tt class="docutils literal"><span class="pre">org.springframework.orm.ObjectOptimisticLockingFailureException</span></tt>)を発生させている。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、更新処理が成功した後に、</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">currentTodo</span><span class="o">.</span><span class="na">setVersion</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">getVersion</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
</pre></div>
</div>
</div></blockquote>
<p>としている。</p>
<p>これはデータベースに更新したバージョンと、Entityが保持するバージョンを合わせるための処理である。</p>
<p class="last">呼び出し元(ControllerやJSPなど)の処理でバージョンを参照する場合は、
データベースの状態とEntityの状態を一致させておかないと、
データ不整合が発生し、アプリケーションが期待通りの動作しない事になる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtouseupdatemultiple">
<span id="id37"></span><h4><a class="toc-backref" href="#id109">5.2.2.8.2. Entityの一括更新</a><a class="headerlink" href="#dataaccessmybatis3howtouseupdatemultiple" title="Permalink to this headline">¶</a></h4>
<p>Entityを一括で更新する際の実装例を以下に示す。</p>
<p>Entityを一括で更新する場合は、</p>
<ul class="simple">
<li>複数のレコードを同時に更新するUPDATE文を発行する</li>
<li>JDBCのバッチ更新機能を使用する</li>
</ul>
<p>方法がある。</p>
<p>JDBCのバッチ更新機能を使用する方法については、「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatch"><em>バッチモードの利用</em></a>」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ここでは、複数のレコードを同時に更新するUPDATE文を発行する方法について説明する。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">int</span> <span class="nf">updateFinishedByTodIds</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;finished&quot;</span><span class="o">)</span> <span class="kt">boolean</span> <span class="n">finished</span><span class="o">,</span>
                               <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;todoIds&quot;</span><span class="o">)</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">todoIds</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、引数に指定されたIDのリストに該当するレコードの<tt class="docutils literal"><span class="pre">finished</span></tt>カラムを更新するためのメソッドとして、
<tt class="docutils literal"><span class="pre">updateFinishedByTodIds</span></tt>メソッドを定義している。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Entityを一括更新するメソッドの返り値について</strong></p>
<p class="last">Entityを一括更新するメソッドの返り値は、数値型(<tt class="docutils literal"><span class="pre">int</span></tt>又は<tt class="docutils literal"><span class="pre">long</span></tt>)でよい。
数値型にすると、更新されたレコード数を取得する事ができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;updateFinishedByTodIds&quot;</span><span class="nt">&gt;</span>
        UPDATE
            t_todo
        SET
            finished = #{finished},
            /* (2) */
            version = version + 1
        WHERE
            /* (3) */
            <span class="nt">&lt;foreach</span> <span class="na">item=</span><span class="s">&quot;todoId&quot;</span> <span class="na">collection=</span><span class="s">&quot;todoIds&quot;</span>
                     <span class="na">open=</span><span class="s">&quot;todo_id IN (&quot;</span> <span class="na">separator=</span><span class="s">&quot;,&quot;</span> <span class="na">close=</span><span class="s">&quot;)&quot;</span><span class="nt">&gt;</span>
                #{todoId}
            <span class="nt">&lt;/foreach&gt;</span>
    <span class="nt">&lt;/update&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first">バージョンカラムを使用して楽観ロックを行う場合は、バージョンカラムを更新する。</p>
<p class="last">更新しないと、楽観ロック制御が正しく動作しなくなる。
排他制御の詳細については、「<a class="reference internal" href="ExclusionControl.html"><em>排他制御</em></a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>-</td>
<td>WHERE句に複数レコードを更新するための更新条件を指定する。</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>-</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">foreach</span></tt>要素を使用して、引数で渡されたIDのリストに対して繰り返し処理を行う。</p>
<p>上記例では、引数で渡されたIDのリストより、IN句を生成している。</p>
<p class="last"><tt class="docutils literal"><span class="pre">foreach</span></tt>の詳細については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/dynamic-sql.html#foreach">MyBatis3 REFERENCE DOCUMENTATION (Dynamic SQL-foreach-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>collection</td>
<td><p class="first">処理対象のコレクションを指定する。</p>
<p class="last">上記例では、Repositoryのメソッド引数のIDのリスト(<tt class="docutils literal"><span class="pre">todoIds</span></tt>)に対して繰り返し処理を行っている。</p>
</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>item</td>
<td>リストの中の1要素を保持するローカル変数名を指定する。</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>separator</td>
<td><p class="first">リスト内の要素間を区切るための文字列を指定する。</p>
<p class="last">上記例では、IN句の区切り文字である<tt class="docutils literal"><span class="pre">&quot;,&quot;</span></tt>を指定している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousedelete">
<span id="id39"></span><h3><a class="toc-backref" href="#id110">5.2.2.9. Entityの削除処理</a><a class="headerlink" href="#dataaccessmybatis3howtousedelete" title="Permalink to this headline">¶</a></h3>
<div class="section" id="dataaccessmybatis3howtousedeleteone">
<span id="id40"></span><h4><a class="toc-backref" href="#id111">5.2.2.9.1. Entityの1件削除</a><a class="headerlink" href="#dataaccessmybatis3howtousedeleteone" title="Permalink to this headline">¶</a></h4>
<p>Entityを1件削除する際の実装例を以下に示す。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>以降の説明では、バージョンカラムを使用した楽観ロックを行う実装例となっているが、
楽観ロックの必要がない場合は、楽観ロック関連の処理を行う必要はない。</p>
<p class="last">排他制御の詳細については、「<a class="reference internal" href="ExclusionControl.html"><em>排他制御</em></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">boolean</span> <span class="nf">delete</span><span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、引数に指定されたTodoオブジェクトを1件削除するためのメソッドとして、
<tt class="docutils literal"><span class="pre">delete</span></tt>メソッドを定義している。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Entityを1件削除するメソッドの返り値について</strong></p>
<p>Entityを1件削除するメソッドの返り値は、基本的には<tt class="docutils literal"><span class="pre">boolean</span></tt>でよい。</p>
<p>ただし、削除結果が複数件になった場合にデータ不整合エラーとして扱う必要がある場合は、
数値型(<tt class="docutils literal"><span class="pre">int</span></tt>又は<tt class="docutils literal"><span class="pre">long</span></tt>)を返り値にし、削除件数が1件であることをチェックする必要がある。
主キーが削除条件となっている場合は、削除結果が複数件になる事はないので、<tt class="docutils literal"><span class="pre">boolean</span></tt>でよい。</p>
<ul class="last simple">
<li>返り値として<tt class="docutils literal"><span class="pre">boolean</span></tt>を指定した場合は、削除件数が0件の際は<tt class="docutils literal"><span class="pre">false</span></tt>、削除件数が1件以上の際は<tt class="docutils literal"><span class="pre">true</span></tt>が返却される。</li>
<li>返り値として数値型を指定した場合は、削除件数が返却される。</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;delete&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        DELETE FROM
            t_todo
        WHERE
            todo_id = #{todoId}
        AND
            version = #{version}
    <span class="nt">&lt;/delete&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">delete</span></tt>要素の中に、DELETEするSQLを実装する。</p>
<p><tt class="docutils literal"><span class="pre">id</span></tt>属性には、Repositoryインタフェースに定義したメソッドのメソッド名を指定する。</p>
<p><tt class="docutils literal"><span class="pre">delete</span></tt>要素の詳細については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#insert_update_and_delete">MyBatis3 REFERENCE DOCUMENTATION (Mapper XML Files-insert, update and delete-)</a>」を参照されたい。</p>
<p class="last">WHERE句にバインドする値は、#{variableName}形式のバインド変数として指定する。
上記例では、Repositoryインタフェースの引数としてJavaBean(<tt class="docutils literal"><span class="pre">Todo</span></tt>)を指定しているため、
バインド変数名にはJavaBeanのプロパティ名を指定する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>ServiceクラスにRepositoryをDIし、Repositoryインターフェースのメソッドを呼び出す。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.repository.todo.TodoRepository</span><span class="o">;</span>

<span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">delete</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// (4)</span>
        <span class="n">Todo</span> <span class="n">currentTodo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currentTodo</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">currentTodo</span><span class="o">.</span><span class="na">getVersion</span><span class="o">()</span> <span class="o">!=</span> <span class="n">version</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ObjectOptimisticLockingFailureException</span><span class="o">(</span><span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">todoId</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// (5)</span>
        <span class="kt">boolean</span> <span class="n">deleted</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">currentTodo</span><span class="o">);</span>
        <span class="c1">// (6)</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">deleted</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ObjectOptimisticLockingFailureException</span><span class="o">(</span><span class="n">Todo</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                    <span class="n">currentTodo</span><span class="o">.</span><span class="na">getTodoId</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">currentTodo</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>ServiceクラスにRepositoryインターフェースをDIする。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">削除対象のEntityをデータベースより取得する。</p>
<p class="last">上記例では、Entityが更新されている場合(レコードが削除されている場合又はバージョンが更新されている場合)は、
Spring Frameworkから提供されている楽観ロック例外(<tt class="docutils literal"><span class="pre">org.springframework.orm.ObjectOptimisticLockingFailureException</span></tt>)を発生させている。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>Repositoryインターフェースのメソッドを呼び出し、Entityを1件削除する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><p class="first">Entityの削除結果を判定する。</p>
<p class="last">上記例では、Entityが削除されなかった場合(レコードが削除されている場合又はバージョンが更新されている場合)は、
Spring Frameworkから提供されている楽観ロック例外(<tt class="docutils literal"><span class="pre">org.springframework.orm.ObjectOptimisticLockingFailureException</span></tt>)を発生させている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousedeletemultiple">
<span id="id42"></span><h4><a class="toc-backref" href="#id112">5.2.2.9.2. Entityの一括削除</a><a class="headerlink" href="#dataaccessmybatis3howtousedeletemultiple" title="Permalink to this headline">¶</a></h4>
<p>Entityを一括で削除する際の実装例を以下に示す。</p>
<p>Entityを一括で削除する場合は、</p>
<ul class="simple">
<li>複数のレコードを同時に削除するDELETE文を発行する</li>
<li>JDBCのバッチ更新機能を使用する</li>
</ul>
<p>方法がある。</p>
<p>JDBCのバッチ更新機能を使用する方法については、「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatch"><em>バッチモードの利用</em></a>」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ここでは、複数のレコードを同時に削除するDELETE文を発行する方法について説明する。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="kt">int</span> <span class="nf">deleteOlderFinishedTodo</span><span class="o">(</span><span class="n">Date</span> <span class="n">criteriaDate</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例では、基準日より前に作成され完了済みのレコードを削除するためのメソッドとして、
<tt class="docutils literal"><span class="pre">deleteOlderFinishedTodo</span></tt>メソッドを定義している。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Entityを一括削除するメソッドの返り値について</strong></p>
<p class="last">Entityを一括削除するメソッドの返り値は、数値型(<tt class="docutils literal"><span class="pre">int</span></tt>又は<tt class="docutils literal"><span class="pre">long</span></tt>)でよい。
数値型にすると、削除されたレコード数を取得する事ができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">&quot;deleteOlderFinishedTodo&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;date&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        DELETE FROM</span>
<span class="cp">            t_todo</span>
<span class="cp">        /* (2) */</span>
<span class="cp">        WHERE</span>
<span class="cp">            finished = TRUE</span>
<span class="cp">        AND</span>
<span class="cp">            created_at  &lt; #{criteriaDate}</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/delete&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">WHERE句に複数レコードを更新するための削除条件を指定する。</p>
<p>上記例では、</p>
<ul class="simple">
<li>完了済み(<tt class="docutils literal"><span class="pre">finished</span></tt>が<tt class="docutils literal"><span class="pre">TRUE</span></tt>)</li>
<li>基準日より前に作成された(<tt class="docutils literal"><span class="pre">created_at</span></tt>が基準日より前)</li>
</ul>
<p class="last">を削除条件として指定している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtousedynamicsql">
<span id="id43"></span><h3><a class="toc-backref" href="#id113">5.2.2.10. 動的SQLの実装</a><a class="headerlink" href="#dataaccessmybatis3howtousedynamicsql" title="Permalink to this headline">¶</a></h3>
<p>動的SQLを組み立てる実装例を以下に示す。</p>
<p>MyBatis3では、動的にSQLを組み立てるためのXML要素と、OGNLベースの式（Expression言語）を使用することで、
動的SQLを組み立てる仕組みを提供している。</p>
<p>動的SQLの詳細については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/dynamic-sql.html">MyBatis3 REFERENCE DOCUMENTATION (Dynamic SQL)</a>」を参照されたい。</p>
<p>MyBatis3では、動的にSQLを組み立てるために、以下のXML要素を提供している。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="78%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">要素名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">if</span></tt></td>
<td>条件に一致した場合のみ、SQLの組み立てを行うための要素。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">choose</span></tt></td>
<td>複数の選択肢の中から条件に一致する1つを選んで、SQLの組み立てを行うための要素。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">where</span></tt></td>
<td>組み立てたWHERE句に対して、接頭語及び末尾の付与や除去など行うための要素。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">set</span></tt></td>
<td>組み立てたSET句用に対して、接頭語及び末尾の付与や除去など行うための要素。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">foreach</span></tt></td>
<td>コレクションや配列に対して繰り返し処理を行うための要素</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">bind</span></tt></td>
<td><p class="first">OGNL式の結果を変数に格納するための要素。</p>
<p class="last"><tt class="docutils literal"><span class="pre">bind</span></tt>要素を使用して格納した変数は、SQL内で参照する事ができる。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>一覧には記載していないが、動的SQLを組み立てるためのXML要素として<tt class="docutils literal"><span class="pre">trim</span></tt>要素が提供されている。</p>
<p><tt class="docutils literal"><span class="pre">trim</span></tt>要素は、<tt class="docutils literal"><span class="pre">where</span></tt>要素と<tt class="docutils literal"><span class="pre">set</span></tt>要素をより汎用的にしたXML要素である。</p>
<p class="last">ほとんどの場合は、<tt class="docutils literal"><span class="pre">where</span></tt>要素と<tt class="docutils literal"><span class="pre">set</span></tt>要素で要件を充たせるため、本ガイドラインでは<tt class="docutils literal"><span class="pre">trim</span></tt>要素の説明は割愛する。
<tt class="docutils literal"><span class="pre">trim</span></tt>要素が必要になる場合は、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/dynamic-sql.html#trim_where_set">MyBatis3 REFERENCE DOCUMENTATION (Dynamic SQL-trim, where, set-)</a>」
を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="if">
<h4><a class="toc-backref" href="#id114">5.2.2.10.1. if要素の実装</a><a class="headerlink" href="#if" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">if</span></tt>要素は、指定した条件に一致した場合のみ、SQLの組み立てを行うためのXML要素である。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    WHERE
        todo_title LIKE #{todoTitle} || &#39;%&#39; ESCAPE &#39;~&#39;
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;finished != null&quot;</span><span class="nt">&gt;</span>
        AND
            finished = #{finished}
    <span class="nt">&lt;/if&gt;</span>
    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">if</span></tt>要素の<tt class="docutils literal"><span class="pre">test</span></tt>属性に、条件を指定する。</p>
<p class="last">上記例では、検索条件として<tt class="docutils literal"><span class="pre">finished</span></tt>が指定されている場合に、<tt class="docutils literal"><span class="pre">finished</span></tt>カラムに対する条件をSQLに加えている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQL(WHERE句)は、以下2パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (1) finished == null</span>
<span class="p">...</span>
<span class="k">WHERE</span>
    <span class="n">todo_title</span> <span class="k">LIKE</span> <span class="o">?</span> <span class="o">||</span> <span class="s1">&#39;%&#39;</span> <span class="k">ESCAPE</span> <span class="s1">&#39;~&#39;</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (2) finished != null</span>
<span class="p">...</span>
<span class="k">WHERE</span>
    <span class="n">todo_title</span> <span class="k">LIKE</span> <span class="o">?</span> <span class="o">||</span> <span class="s1">&#39;%&#39;</span> <span class="k">ESCAPE</span> <span class="s1">&#39;~&#39;</span>
<span class="k">AND</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="choose">
<h4><a class="toc-backref" href="#id115">5.2.2.10.2. choose要素の実装</a><a class="headerlink" href="#choose" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">choose</span></tt>要素は、複数の選択肢の中から条件に一致する1つを選んで、SQLの組み立てを行うためのXML要素である。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    WHERE
        todo_title LIKE #{todoTitle} || &#39;%&#39; ESCAPE &#39;~&#39;
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;choose&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;when</span> <span class="na">test=</span><span class="s">&quot;createdAt != null&quot;</span><span class="nt">&gt;</span>
            AND
                created_at <span class="cp">&lt;![CDATA[ &gt; ]]&gt;</span> #{createdAt}
        <span class="nt">&lt;/when&gt;</span>
        <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;otherwise&gt;</span>
            AND
                created_at <span class="cp">&lt;![CDATA[ &gt; ]]&gt;</span> CURRENT_DATE
        <span class="nt">&lt;/otherwise&gt;</span>
    <span class="nt">&lt;/choose&gt;</span>
    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">choose</span></tt>要素に中に、<tt class="docutils literal"><span class="pre">when</span></tt>要素と<tt class="docutils literal"><span class="pre">otherwise</span></tt>要素を指定して、SQLを組み立てる条件を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">when</span></tt>要素の<tt class="docutils literal"><span class="pre">test</span></tt>属性に、条件を指定する。</p>
<p class="last">上記例では、検索条件として<tt class="docutils literal"><span class="pre">createdAt</span></tt>が指定されている場合に、
<tt class="docutils literal"><span class="pre">create_at</span></tt>カラムの値が指定日以降のレコードを抽出するための条件をSQLに加えている。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">otherwise</span></tt>要素に、全ての<tt class="docutils literal"><span class="pre">when</span></tt>要素に一致しない場合時に組み立てるSQLを指定する。</p>
<p class="last">上記例では、<tt class="docutils literal"><span class="pre">create_at</span></tt>カラムの値が現在日以降のレコード(当日作成されたレコード)を抽出するための条件をSQLに加えている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQL(WHERE句)は、以下2パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (1) createdAt!=null</span>
<span class="p">...</span>
<span class="k">WHERE</span>
    <span class="n">todo_title</span> <span class="k">LIKE</span> <span class="o">?</span> <span class="o">||</span> <span class="s1">&#39;%&#39;</span> <span class="k">ESCAPE</span> <span class="s1">&#39;~&#39;</span>
<span class="k">AND</span>
    <span class="n">created_at</span>   <span class="o">&gt;</span>   <span class="o">?</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (2) createdAt==null</span>
<span class="p">...</span>
<span class="k">WHERE</span>
    <span class="n">todo_title</span> <span class="k">LIKE</span> <span class="o">?</span> <span class="o">||</span> <span class="s1">&#39;%&#39;</span> <span class="k">ESCAPE</span> <span class="s1">&#39;~&#39;</span>
<span class="k">AND</span>
    <span class="n">created_at</span> <span class="o">&gt;</span> <span class="k">CURRENT_DATE</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="where">
<h4><a class="toc-backref" href="#id116">5.2.2.10.3. where要素の実装</a><a class="headerlink" href="#where" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">where</span></tt>要素は、WHERE句を動的に生成するためのXML要素である。</p>
<p><tt class="docutils literal"><span class="pre">where</span></tt>要素を使用すると、</p>
<ul class="simple">
<li>WHERE句の付与</li>
<li>AND句、OR句の除去</li>
</ul>
<p>などが行われるため、シンプルにWHERE句を組み立てる事ができる。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria2&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;where&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;finished != null&quot;</span><span class="nt">&gt;</span>
            AND
                finished = #{finished}
        <span class="nt">&lt;/if&gt;</span>
        <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;createdAt != null&quot;</span><span class="nt">&gt;</span>
            AND
                created_at <span class="cp">&lt;![CDATA[ &gt; ]]&gt;</span> #{createdAt}
        <span class="nt">&lt;/if&gt;</span>
    <span class="nt">&lt;/where&gt;</span>
    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">where</span></tt>要素に中で、WHERE句を組み立てるための動的SQLを実装する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">where</span></tt>要素内で組み立てたSQLに応じて、WHERE句の付与や、AND句及びORの除去などが行われる。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">動的SQLを組み立てる。</p>
<p class="last">上記例では、検索条件として<tt class="docutils literal"><span class="pre">finished</span></tt>が指定されている場合に、
<tt class="docutils literal"><span class="pre">finished</span></tt>カラムに対する条件をSQLに加えている。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">動的SQLを組み立てる。</p>
<p class="last">上記例では、検索条件として<tt class="docutils literal"><span class="pre">createdAt</span></tt>が指定されている場合に、
<tt class="docutils literal"><span class="pre">created_at</span></tt>カラムに対する条件をSQLに加えている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQL(WHERE句)は、以下4パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (1) finished != null &amp;&amp; createdAt != null</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">WHERE</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">AND</span>
    <span class="n">created_at</span>  <span class="o">&gt;</span>  <span class="o">?</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (2) finished != null &amp;&amp; createdAt == null</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">WHERE</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (3) finished == null &amp;&amp; createdAt != null</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">WHERE</span>
    <span class="n">created_at</span>  <span class="o">&gt;</span>  <span class="o">?</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (4) finished == null &amp;&amp; createdAt == null</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="set">
<h4><a class="toc-backref" href="#id117">5.2.2.10.4. set要素の実装例</a><a class="headerlink" href="#set" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">set</span></tt>要素は、SET句を動的に生成するためのXML要素である。</p>
<p><tt class="docutils literal"><span class="pre">set</span></tt>要素を使用すると、</p>
<ul class="simple">
<li>SET句の付与</li>
<li>末尾のカンマの除去</li>
</ul>
<p>などが行われるため、シンプルにSET句を組み立てる事ができる。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&quot;update&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    UPDATE
        t_todo
    <span class="c">&lt;!-- (1)  --&gt;</span>
    <span class="nt">&lt;set&gt;</span>
        version = version + 1,
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;todoTitle != null&quot;</span><span class="nt">&gt;</span>
            todo_title = #{todoTitle}
        <span class="nt">&lt;/if&gt;</span>
    <span class="nt">&lt;/set&gt;</span>
    WHERE
        todo_id = #{todoId}
<span class="nt">&lt;/update&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">set</span></tt>要素に中で、SET句を組み立てるための動的SQLを実装する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">set</span></tt>要素内で組み立てたSQLに応じて、SET句の付与や、末尾のカンマの除去などが行われる。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">動的SQLを組み立てる。</p>
<p class="last">上記例では、更新項目として<tt class="docutils literal"><span class="pre">todoTitle</span></tt>が指定されている場合に、
<tt class="docutils literal"><span class="pre">todo_title</span></tt>カラムを更新カラムとしてSQLに加えている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>上記の動的SQLで生成されるSQLは、以下2パターンとなる。</p>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (1) todoTitle != null</span>
<span class="k">UPDATE</span>
    <span class="n">t_todo</span>
<span class="k">SET</span>
    <span class="k">version</span> <span class="o">=</span> <span class="k">version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">todo_title</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">WHERE</span>
    <span class="n">todo_id</span> <span class="o">=</span> <span class="o">?</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (2) todoTitle == null</span>
<span class="k">UPDATE</span>
    <span class="n">t_todo</span>
<span class="k">SET</span>
   <span class="k">version</span> <span class="o">=</span> <span class="k">version</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">WHERE</span>
    <span class="n">todo_id</span> <span class="o">=</span> <span class="o">?</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="foreach">
<h4><a class="toc-backref" href="#id118">5.2.2.10.5. foreach要素の実装例</a><a class="headerlink" href="#foreach" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">foreach</span></tt>要素は、コレクションや配列に対して繰り返し処理を行うためのXML要素である。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCreatedAtList&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;list&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    <span class="nt">&lt;where&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;list != null&quot;</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- (2) --&gt;</span>
            <span class="nt">&lt;foreach</span> <span class="na">collection=</span><span class="s">&quot;list&quot;</span> <span class="na">item=</span><span class="s">&quot;date&quot;</span> <span class="na">separator=</span><span class="s">&quot;OR&quot;</span><span class="nt">&gt;</span>
            <span class="cp">&lt;![CDATA[</span>
<span class="cp">                (created_at &gt;= #{date} AND created_at &lt; DATEADD(&#39;DAY&#39;, 1, #{date}))</span>
<span class="cp">            ]]&gt;</span>
            <span class="nt">&lt;/foreach&gt;</span>
        <span class="nt">&lt;/if&gt;</span>
    <span class="nt">&lt;/where&gt;</span>
    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first">繰返し処理を行う対象のコレクション又は配列に対して、<tt class="docutils literal"><span class="pre">null</span></tt>チェックを行う。</p>
<p class="last"><tt class="docutils literal"><span class="pre">null</span></tt>にならない事がない場合は、このチェックは実装しなくてもよい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">foreach</span></tt>要素を使用して、コレクションや配列に対して繰返し処理を行い、動的SQLを組み立てる。</p>
<p class="last">上記例では、レコードの作成日付が、指定された日付(日付リスト)の何れかと一致するレコードを検索するためのWHERE句を組み立てている。</p>
</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>collection</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">collection</span></tt>属性に、繰返し処理を行うコレクションや配列を指定する。</p>
<p class="last">上記例では、Repositoryメソッドの引数に指定されたコレクションを指定している。</p>
</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>item</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">item</span></tt>属性に、リストの中の1要素を保持するローカル変数名を指定する。</p>
<p class="last">上記例では、<tt class="docutils literal"><span class="pre">collection</span></tt>属性に日付リストを指定しているので、
<tt class="docutils literal"><span class="pre">date</span></tt>という変数名を指定している。</p>
</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>separator</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">separator</span></tt>属性に、要素間の区切り文字列を指定する。</p>
<p class="last">上記例では、OR条件のWHERE句を組み立てている。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では使用していないが、 <tt class="docutils literal"><span class="pre">foreach</span></tt>要素には、以下の属性が存在する。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>open</td>
<td>コレクションの先頭要素を処理する前に設定する文字列を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>close</td>
<td>コレクションの末尾要素を処理した後に設定する文字列を指定する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>index</td>
<td>ループ番号を格納する変数名を指定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><tt class="docutils literal"><span class="pre">index</span></tt>属性を使用するケースはあまりないが、<tt class="docutils literal"><span class="pre">open</span></tt>属性と <tt class="docutils literal"><span class="pre">close</span></tt>属性は、
IN句などを動的に生成する際に使用される。</p>
<p>以下に、IN句を作成する際の<tt class="docutils literal"><span class="pre">foreach</span></tt>要素の使用例を記載しておく。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;foreach</span> <span class="na">collection=</span><span class="s">&quot;list&quot;</span> <span class="na">item=</span><span class="s">&quot;statusCode&quot;</span>
        <span class="na">open=</span><span class="s">&quot;AND order_status IN (&quot;</span>
        <span class="na">separator=</span><span class="s">&quot;,&quot;</span>
        <span class="na">close=</span><span class="s">&quot;)&quot;</span><span class="nt">&gt;</span>
    #{statusCode}
<span class="nt">&lt;/foreach&gt;</span>
</pre></div>
</div>
</div></blockquote>
<p>以下の様なSQLが組み立てられる。</p>
<blockquote class="last">
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- list=[&#39;accepted&#39;,&#39;checking&#39;]</span>
<span class="p">...</span>
<span class="k">AND</span> <span class="n">order_status</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="o">?</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line">上記の動的SQLで生成されるSQL(WHERE句)は、以下3パターンとなる。</div>
</div>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (1) list=null or statusCodes=[]</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (2) list=[&#39;2014-01-01&#39;]</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">WHERE</span>
    <span class="p">(</span><span class="n">created_at</span> <span class="o">&gt;=</span> <span class="o">?</span> <span class="k">AND</span> <span class="n">created_at</span> <span class="o">&lt;</span> <span class="n">DATEADD</span><span class="p">(</span><span class="s1">&#39;DAY&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">?</span><span class="p">))</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- (3) list=[&#39;2014-01-01&#39;,&#39;2014-01-02&#39;]</span>
<span class="p">...</span>
<span class="k">FROM</span>
    <span class="n">t_todo</span>
<span class="k">WHERE</span>
    <span class="p">(</span><span class="n">created_at</span> <span class="o">&gt;=</span> <span class="o">?</span> <span class="k">AND</span> <span class="n">created_at</span> <span class="o">&lt;</span> <span class="n">DATEADD</span><span class="p">(</span><span class="s1">&#39;DAY&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">?</span><span class="p">))</span>
<span class="k">OR</span>
    <span class="p">(</span><span class="n">created_at</span> <span class="o">&gt;=</span> <span class="o">?</span> <span class="k">AND</span> <span class="n">created_at</span> <span class="o">&lt;</span> <span class="n">DATEADD</span><span class="p">(</span><span class="s1">&#39;DAY&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">?</span><span class="p">))</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">todo_id</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="bind">
<h4><a class="toc-backref" href="#id119">5.2.2.10.6. bind要素の実装例</a><a class="headerlink" href="#bind" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">bind</span></tt>要素は、OGNL式の結果を変数に格納するためのXML要素である。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;escapedTodoTitle&quot;</span>
          <span class="na">value=</span><span class="s">&quot;@org.terasoluna.gfw.common.query.QueryEscapeUtils@toLikeCondition(todoTitle)&quot;</span> <span class="nt">/&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    WHERE
        /* (2) */
        todo_title LIKE #{escapedTodoTitle} || &#39;%&#39; ESCAPE &#39;~&#39;
    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">bind</span></tt>要素を使用して、OGNL式の結果を変数に格納する</p>
<p class="last">上記例では、OGNL式を使ってメソッドを呼び出した結果を、変数に格納している。</p>
</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>name</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">name</span></tt>属性には、変数名を指定する。</p>
<p class="last">ここで指定した変数名は、SQLのバインド変数として使用する事ができる。</p>
</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>value</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">value</span></tt>属性には、OGNL式を指定する。</p>
<p>OGNL式を実行した結果が、<tt class="docutils literal"><span class="pre">name</span></tt>属性で指定した変数に格納される。</p>
<p class="last">上記例では、共通ライブラリから提供しているメソッド(<tt class="docutils literal"><span class="pre">QueryEscapeUtils#toLikeCondition(String)</span></tt>)を呼び出した結果を、
<tt class="docutils literal"><span class="pre">escapedTodoTitle</span></tt>という変数に格納している。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>-</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">bind</span></tt>要素を使用して作成した変数を、バインド変数として指定する。</p>
<p class="last">上記例では、<tt class="docutils literal"><span class="pre">bind</span></tt>要素を使用して作成した変数(<tt class="docutils literal"><span class="pre">escapedTodoTitle</span></tt>)を、バインド変数として指定している。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、<tt class="docutils literal"><span class="pre">bind</span></tt>要素を使用して作成した変数をバインド変数として指定しているが、
置換変数として使用する事もできる。</p>
<p class="last">バインド変数と置換変数については、
「<a class="reference internal" href="#dataaccessmybatis3howtousesqlinjectioncountermeasure"><em>SQL Injection対策</em></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="like">
<span id="dataaccessmybatis3howtouselikeescape"></span><h3><a class="toc-backref" href="#id120">5.2.2.11. LIKE検索時のエスケープ</a><a class="headerlink" href="#like" title="Permalink to this headline">¶</a></h3>
<p>LIKE検索を行う場合は、検索条件として使用する値をLIKE検索用にエスケープする必要がある。</p>
<p>LIKE検索用のエスケープ処理は、
共通ライブラリから提供している<tt class="docutils literal"><span class="pre">org.terasoluna.gfw.common.query.QueryEscapeUtils</span></tt> クラスのメソッドを使用することで実現する事ができる。</p>
<p>共通ライブラリから提供しているエスケープ処理の仕様については、
「<a class="reference internal" href="DataAccessCommon.html#data-access-common-appendix-like-escape"><em>LIKE検索時のエスケープについて</em></a>」を参照されたい。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;todoTitleContainingCondition&quot;</span>
          <span class="na">value=</span><span class="s">&quot;@org.terasoluna.gfw.common.query.QueryEscapeUtils@toContainingCondition(todoTitle)&quot;</span> <span class="nt">/&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    WHERE
        /* (2) (3) */
        todo_title LIKE #{todoTitleContainingCondition} ESCAPE &#39;~&#39;
    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">bind</span></tt>要素(OGNL式)を使用して、共通ライブラリから提供しているLIKE検索用のエスケープ処理メソッドを呼び出す。</p>
<p class="last">上記例では、部分一致用のエスケープ処理を行い<tt class="docutils literal"><span class="pre">todoTitleContainingCondition</span></tt>という変数に格納している。
<tt class="docutils literal"><span class="pre">QueryEscapeUtils&#64;toContainingCondition(String)</span></tt>メソッドは、エスケープした文字列の前後に&#8221;<tt class="docutils literal"><span class="pre">%</span></tt>&#8220;を付与するメソッドである。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>部分一致用のエスケープを行った文字列を、LIKE句のバインド変数として指定する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">ESCAPE句にエスケープ文字を指定する。</p>
<p class="last">共通ライブラリから提供しているエスケープ処理では、
エスケープ文字として<tt class="docutils literal"><span class="pre">&quot;~&quot;</span></tt>を使用しているため、ESCAPE句に<tt class="docutils literal"><span class="pre">'~'</span></tt>を指定している。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、部分一致用のエスケープ処理を行うメソッドを呼び出しているが、</p>
<ul class="simple">
<li>前方一致用のエスケープ(<tt class="docutils literal"><span class="pre">QueryEscapeUtils&#64;toStartingWithCondition(String)</span></tt>)</li>
<li>後方一致用のエスケープ(<tt class="docutils literal"><span class="pre">QueryEscapeUtils&#64;toEndingWithCondition(String)</span></tt>)</li>
<li>エスケープのみ(<tt class="docutils literal"><span class="pre">QueryEscapeUtils&#64;toLikeCondition(String)</span></tt>)</li>
</ul>
<p>を行うメソッドも用意されている。</p>
<p class="last">詳細は「<a class="reference internal" href="DataAccessCommon.html#data-access-common-appendix-like-escape"><em>LIKE検索時のエスケープについて</em></a>」を参照されたい。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>上記例では、マッピングファイル内でエスケープ処理を行うメソッドを呼び出しているが、
Repositoryのメソッドを呼び出す前に、Serviceの処理としてエスケープ処理を行う方法もある。</p>
<p class="last">コンポーネントの役割としては、マッピングファイルでエスケープ処理を行う方が適切なため、
本ガイドラインとしては、マッピングファイル内でエスケープ処理を行う事を推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="sql-injection">
<span id="dataaccessmybatis3howtousesqlinjectioncountermeasure"></span><h3><a class="toc-backref" href="#id121">5.2.2.12. SQL Injection対策</a><a class="headerlink" href="#sql-injection" title="Permalink to this headline">¶</a></h3>
<p>SQLを組み立てる際は、SQL Injectionが発生しないように注意する必要がある。</p>
<p>MyBatis3では、SQLに値を埋め込む仕組みとして、以下の2つの方法を提供している。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="22%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">方法</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>バインド変数を使用して埋め込む</td>
<td><p class="first">この方法を使用すると、 SQL組み立て後に<tt class="docutils literal"><span class="pre">java.sql.PreparedStatement</span></tt> を使用して値が埋め込められるため、
<strong>安全に値を埋め込むことができる。</strong></p>
<p class="last"><strong>ユーザからの入力値をSQLに埋め込む場合は、原則バインド変数を使用すること。</strong></p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>置換変数を使用して埋め込む</td>
<td>この方法を使用すると、SQLを組み立てるタイミングで文字列として置換されてしまうため、
<strong>安全な値の埋め込みは保証されない。</strong></td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>ユーザからの入力値を置換変数を使って埋め込むと、
SQL Injectionが発生する危険性が高くなることを意識すること。</p>
<p>ユーザからの入力値を置換変数を使って埋め込む必要がある場合は、
SQL Injectionが発生しないことを保障するために、かならず入力チェックを行うこと。</p>
<p class="last">基本的には、 <strong>ユーザからの入力値はそのまま使わないことを強く推奨する。</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id44">
<h4><a class="toc-backref" href="#id122">5.2.2.12.1. バインド変数を使って埋め込む方法</a><a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h4>
<p>バインド変数の使用例を以下に示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    INSERT INTO
        t_todo
    (
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    )
    VALUES
    (
        /* (1) */
        #{todoId},
        #{todoTitle},
        #{finished},
        #{createdAt},
        #{version}
    )
<span class="nt">&lt;/insert&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>バインドする値が格納されているプロパティのプロパティ名を、
<tt class="docutils literal"><span class="pre">#{</span></tt> と<tt class="docutils literal"><span class="pre">}</span></tt> で囲み、バインド変数として指定する。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>バインド変数には、いくつかの属性を指定する事が出来る。</p>
<p>指定できる属性としては、</p>
<ul class="simple">
<li>javaType</li>
<li>jdbcType</li>
<li>typeHandler</li>
<li>numericScale</li>
<li>mode</li>
<li>resultMap</li>
<li>jdbcTypeName</li>
</ul>
<p>がある。</p>
<p>基本的には、単純にプロパティ名を指定するだけで、MyBatisが適切な振る舞いを選択してくれる。
上記属性は、MyBatisが適切な振る舞いを選択してくれない時に指定すればよい。</p>
<p class="last">属性の使い方については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#Parameters">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-Parameters-)</a> 」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="id45">
<h4><a class="toc-backref" href="#id123">5.2.2.12.2. 置換変数を使って埋め込む方法</a><a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h4>
<p>置換変数の使用例を以下に示す。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">findAllByCriteria</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;criteria&quot;</span><span class="o">)</span> <span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="o">,</span>
                                 <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;direction&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">direction</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>マッピングファイルにSQLを実装する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;todoTitleContainingCondition&quot;</span>
          <span class="na">value=</span><span class="s">&quot;@org.terasoluna.gfw.common.query.QueryEscapeUtils@toContainingCondition(criteria.todoTitle)&quot;</span> <span class="nt">/&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    WHERE
        todo_title LIKE #{todoTitleContainingCondition} ESCAPE &#39;~&#39;
    ORDER BY
        /* (1) */
        todo_id ${direction}
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>置換する値が格納されているプロパティのプロパティ名を<tt class="docutils literal"><span class="pre">${</span></tt> と
<tt class="docutils literal"><span class="pre">}</span></tt> で囲み、置換変数として指定する。上記例では、<tt class="docutils literal"><span class="pre">${direction}</span></tt> の部分は、<tt class="docutils literal"><span class="pre">&quot;DESC&quot;</span></tt> または<tt class="docutils literal"><span class="pre">&quot;ASC&quot;</span></tt> で置換される。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>置換変数による埋め込みは、必ずアプリケーションとして安全な値であることを担保した上で、</strong>
<strong>テーブル名、カラム名、ソート条件などに限定して使用することを推奨する。</strong></p>
<p>例えば以下のように、コード値とSQLに埋め込むための値のペアを<tt class="docutils literal"><span class="pre">Map</span></tt>に格納しておき、</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">directionMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
<span class="n">directionMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;1&quot;</span><span class="o">,</span> <span class="s">&quot;ASC&quot;</span><span class="o">);</span>
<span class="n">directionMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;2&quot;</span><span class="o">,</span> <span class="s">&quot;DESC&quot;</span><span class="o">);</span>
</pre></div>
</div>
</div></blockquote>
<p>入力値はコード値として扱い、SQLを実行する処理の中で安全な値に変換することが望ましい。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="n">String</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">directionMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">directionCode</span><span class="o">);</span>
<span class="n">todoRepository</span><span class="o">.</span><span class="na">findAllByCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">,</span> <span class="n">direction</span><span class="o">);</span>
</pre></div>
</div>
</div></blockquote>
<p>上記例では<tt class="docutils literal"><span class="pre">Map</span></tt>を使用しているが、
共通ライブラリから提供している「<a class="reference internal" href="Codelist.html"><em>コードリスト</em></a> 」を使用しても良い。
「<a class="reference internal" href="Codelist.html"><em>コードリスト</em></a> 」を使用すると、入力チェックと連動する事ができるため、
より安全に値の埋め込みを行う事ができる。</p>
<ul class="last">
<li><p class="first"><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-codelist.xml</span></tt></p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">    http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;CL_DIRECTION&quot;</span> <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.common.codelist.SimpleMapCodeList&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;map&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;ASC&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;2&quot;</span> <span class="na">value=</span><span class="s">&quot;DESC&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Serviceクラス</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@Inject</span>
<span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;CL_DIRECTION&quot;</span><span class="o">)</span>
<span class="n">CodeList</span> <span class="n">directionCodeList</span><span class="o">;</span>

<span class="c1">// ...</span>

<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">searchTodos</span><span class="o">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="n">String</span> <span class="n">directionCode</span><span class="o">){</span>
    <span class="n">String</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">directionCodeList</span><span class="o">.</span><span class="na">asMap</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">directionCode</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findAllByCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">,</span> <span class="n">direction</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">todos</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-to-extend">
<span id="dataaccessmybatis3howtoextend"></span><h2><a class="toc-backref" href="#id124">5.2.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<div class="section" id="dataaccessmybatis3howtoextendsqlshare">
<span id="id46"></span><h3><a class="toc-backref" href="#id125">5.2.3.1. SQL文の共有</a><a class="headerlink" href="#dataaccessmybatis3howtoextendsqlshare" title="Permalink to this headline">¶</a></h3>
<p>SQL文を複数のSQLで共有する方法について、説明を行う。</p>
<p>MyBatis3では、 <tt class="docutils literal"><span class="pre">sql</span></tt>要素と<tt class="docutils literal"><span class="pre">include</span></tt>要素を使用することで、
SQL文(又はSQL文の一部)を共有する事ができる。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>SQL文の共有化の使用例</strong></p>
<p class="last">ページネーション検索を実現する場合は、「検索条件に一致するEntityの総件数を取得するSQL」と
「 検索条件に一致するEntityのリストを取得するSQL」のWHERE句は共有した方がよい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>マッピングファイルの実装例は以下の通り。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="hll"><span class="c">&lt;!-- (1)  --&gt;</span>
</span><span class="hll"><span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">&gt;</span>
</span>    <span class="cp">&lt;![CDATA[</span>
<span class="cp">    WHERE</span>
<span class="cp">        todo_title LIKE #{title} || &#39;%&#39; ESCAPE &#39;~&#39;</span>
<span class="cp">    AND</span>
<span class="cp">        created_at &lt; #{createdAt}</span>
<span class="cp">    ]]&gt;</span>
<span class="nt">&lt;/sql&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;countByCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;_long&quot;</span><span class="nt">&gt;</span>
    SELECT
        COUNT(*)
    FROM
        t_todo
<span class="hll">    <span class="c">&lt;!-- (2)  --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">/&gt;</span>
</span><span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
<span class="hll">    <span class="c">&lt;!-- (2)  --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;findPageByCriteriaWherePhrase&quot;</span><span class="nt">/&gt;</span>
</span>    ORDER BY
        todo_id
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">sql</span></tt>要素の中に、複数のSQLで共有するSQL文を実装する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">id</span></tt>属性には、マッピングファイル内でユニークとなるIDを指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">include</span></tt>要素を使用して、インクルードするSQLを指定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">refid</span></tt>属性には、インクルードするSQLのID(<tt class="docutils literal"><span class="pre">sql</span></tt>要素の<tt class="docutils literal"><span class="pre">id</span></tt>属性に指定した値)を指定する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendtypehandler">
<span id="id47"></span><h3><a class="toc-backref" href="#id126">5.2.3.2. TypeHandlerの実装</a><a class="headerlink" href="#dataaccessmybatis3howtoextendtypehandler" title="Permalink to this headline">¶</a></h3>
<p>MyBatis3の標準でサポートされていないJavaクラスとのマッピングが必要だったり、
MyBatis3標準の振る舞いを変更する必要がある場合は、独自のTypeHandlerの作成が必要となる。</p>
<p>以下に、</p>
<ul class="simple">
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendtypehandlerblob"><em>BLOB用のTypeHandlerの実装</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendtypehandlerclob"><em>CLOB用のTypeHandlerの実装</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendtypehandlerjoda"><em>Joda-Time用のTypeHandlerの実装</em></a></li>
</ul>
<p>を例に、TypeHandlerの実装方法について説明する。</p>
<p>作成したTypeHandlerをアプリケーションに適用する方法については、
「<a class="reference internal" href="#dataaccessmybatis3howtousesettingstypehandler"><em>TypeHandlerの設定</em></a>」を参照されたい。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>BLOB用とCLOB用の実装例の前提条件について</strong></p>
<p>BLOBとCLOBの実装例では、JDBC 4.0から追加されたメソッドを使用している。</p>
<p>JDBC 4.0との互換性のないJDBCドライバや3rdパーティのラッパクラスなどを使用する場合は、
以下に説明する実装例では動作しない可能性がある点を補足しておく。
JDBC 4.0との互換性がない環境で動作させる場合は、
利用するJDBCドライバの互換バージョンを意識した実装に変更する必要がある。</p>
<p class="last">例えば、PostgreSQL9.3用のJDBCドライバ(<tt class="docutils literal"><span class="pre">postgresql-9.3-1102-jdbc41.jar</span></tt>)では、
JDBC 4.0から追加された多くのメソッドが、未実装の状態である。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="blobtypehandler">
<span id="dataaccessmybatis3howtoextendtypehandlerblob"></span><h4><a class="toc-backref" href="#id127">5.2.3.2.1. BLOB用のTypeHandlerの実装</a><a class="headerlink" href="#blobtypehandler" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3では、BLOBを<tt class="docutils literal"><span class="pre">byte[]</span></tt>にマッピングするためのTypeHandlerを提供している。
ただし、扱うデータの容量が大きい場合は、<tt class="docutils literal"><span class="pre">java.io.InputStream</span></tt>とマッピングが必要なケースがある。</p>
<p>以下に、BLOBと<tt class="docutils literal"><span class="pre">java.io.InputStream</span></tt>をマッピングするためのTypeHandlerの実装例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">infra</span><span class="o">.</span><span class="na">mybatis</span><span class="o">.</span><span class="na">typehandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.ibatis.type.BaseTypeHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.type.JdbcType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.type.MappedTypes</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>

<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlobInputStreamTypeHandler</span> <span class="kd">extends</span> <span class="n">BaseTypeHandler</span><span class="o">&lt;</span><span class="n">InputStream</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNonNullParameter</span><span class="o">(</span><span class="n">PreparedStatement</span> <span class="n">ps</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">InputStream</span> <span class="n">parameter</span><span class="o">,</span>
                                    <span class="n">JdbcType</span> <span class="n">jdbcType</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">ps</span><span class="o">.</span><span class="na">setBlob</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">parameter</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">InputStream</span> <span class="nf">getNullableResult</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="n">String</span> <span class="n">columnName</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">toInputStream</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getBlob</span><span class="o">(</span><span class="n">columnName</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">InputStream</span> <span class="nf">getNullableResult</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">columnIndex</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">toInputStream</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getBlob</span><span class="o">(</span><span class="n">columnIndex</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">InputStream</span> <span class="nf">getNullableResult</span><span class="o">(</span><span class="n">CallableStatement</span> <span class="n">cs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">columnIndex</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">toInputStream</span><span class="o">(</span><span class="n">cs</span><span class="o">.</span><span class="na">getBlob</span><span class="o">(</span><span class="n">columnIndex</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">InputStream</span> <span class="nf">toInputStream</span><span class="o">(</span><span class="n">Blob</span> <span class="n">blob</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="c1">// (4)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">blob</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">blob</span><span class="o">.</span><span class="na">getBinaryStream</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">MyBatis3から提供されている<tt class="docutils literal"><span class="pre">BaseTypeHandler</span></tt>を親クラスに指定する。</p>
<p class="last">その際、<tt class="docutils literal"><span class="pre">BaseTypeHandler</span></tt>のジェネリック型には、<tt class="docutils literal"><span class="pre">InputStream</span></tt>を指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">InputStream</span></tt>を<tt class="docutils literal"><span class="pre">PreparedStatement</span></tt>に設定する処理を実装する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">ResultSet</span></tt>又は<tt class="docutils literal"><span class="pre">CallableStatement</span></tt>から取得した<tt class="docutils literal"><span class="pre">Blob</span></tt>から<tt class="docutils literal"><span class="pre">InputStream</span></tt>を取得し、返り値として返却する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">null</span></tt>を許可するカラムの場合、取得した<tt class="docutils literal"><span class="pre">Blob</span></tt>が<tt class="docutils literal"><span class="pre">null</span></tt>になる可能性があるため、
<tt class="docutils literal"><span class="pre">null</span></tt>チェックを行ってから<tt class="docutils literal"><span class="pre">InputStream</span></tt>を取得する必要がある。</p>
<p class="last">上記実装例では、3つのメソッドで同じ処理が必要になるため、privateメソッドを作成している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="clobtypehandler">
<span id="dataaccessmybatis3howtoextendtypehandlerclob"></span><h4><a class="toc-backref" href="#id128">5.2.3.2.2. CLOB用のTypeHandlerの実装</a><a class="headerlink" href="#clobtypehandler" title="Permalink to this headline">¶</a></h4>
<p>MyBatis3では、CLOBを<tt class="docutils literal"><span class="pre">java.lang.String</span></tt>にマッピングするためのTypeHandlerを提供している。
ただし、扱うデータの容量が大きい場合は、<tt class="docutils literal"><span class="pre">java.io.Reader</span></tt>とマッピングが必要なケースがある。</p>
<p>以下に、CLOBと<tt class="docutils literal"><span class="pre">java.io.Reader</span></tt>をマッピングするためのTypeHandlerの実装例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">infra</span><span class="o">.</span><span class="na">mybatis</span><span class="o">.</span><span class="na">typehandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.ibatis.type.BaseTypeHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.type.JdbcType</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Reader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>

<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClobReaderTypeHandler</span> <span class="kd">extends</span> <span class="n">BaseTypeHandler</span><span class="o">&lt;</span><span class="n">Reader</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNonNullParameter</span><span class="o">(</span><span class="n">PreparedStatement</span> <span class="n">ps</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">Reader</span> <span class="n">parameter</span><span class="o">,</span>
                                    <span class="n">JdbcType</span> <span class="n">jdbcType</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">ps</span><span class="o">.</span><span class="na">setClob</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">parameter</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Reader</span> <span class="nf">getNullableResult</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="n">String</span> <span class="n">columnName</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">toReader</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getClob</span><span class="o">(</span><span class="n">columnName</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Reader</span> <span class="nf">getNullableResult</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">columnIndex</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">toReader</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getClob</span><span class="o">(</span><span class="n">columnIndex</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Reader</span> <span class="nf">getNullableResult</span><span class="o">(</span><span class="n">CallableStatement</span> <span class="n">cs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">columnIndex</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">toReader</span><span class="o">(</span><span class="n">cs</span><span class="o">.</span><span class="na">getClob</span><span class="o">(</span><span class="n">columnIndex</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">Reader</span> <span class="nf">toReader</span><span class="o">(</span><span class="n">Clob</span> <span class="n">clob</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="c1">// (4)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">clob</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">clob</span><span class="o">.</span><span class="na">getCharacterStream</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">MyBatis3から提供されている<tt class="docutils literal"><span class="pre">BaseTypeHandler</span></tt>を親クラスに指定する。</p>
<p class="last">その際、<tt class="docutils literal"><span class="pre">BaseTypeHandler</span></tt>のジェネリック型には、<tt class="docutils literal"><span class="pre">Reader</span></tt>を指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">Reader</span></tt>を<tt class="docutils literal"><span class="pre">PreparedStatement</span></tt>に設定する処理を実装する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">ResultSet</span></tt>又は<tt class="docutils literal"><span class="pre">CallableStatement</span></tt>から取得した<tt class="docutils literal"><span class="pre">Clob</span></tt>から<tt class="docutils literal"><span class="pre">Reader</span></tt>を取得し、返り値として返却する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">null</span></tt>を許可するカラムの場合、取得した<tt class="docutils literal"><span class="pre">Clob</span></tt>が<tt class="docutils literal"><span class="pre">null</span></tt>になる可能性があるため、
<tt class="docutils literal"><span class="pre">null</span></tt>チェックを行ってから<tt class="docutils literal"><span class="pre">Reader</span></tt>を取得する必要がある。</p>
<p class="last">上記実装例では、3つのメソッドで同じ処理が必要になるため、privateメソッドを作成している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="joda-timetypehandler">
<span id="dataaccessmybatis3howtoextendtypehandlerjoda"></span><h4><a class="toc-backref" href="#id129">5.2.3.2.3. Joda-Time用のTypeHandlerの実装</a><a class="headerlink" href="#joda-timetypehandler" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">MyBatis3では、Joda-Timeのクラス(<tt class="docutils literal"><span class="pre">org.joda.time.DateTime</span></tt>、<tt class="docutils literal"><span class="pre">org.joda.time.LocalDateTime</span></tt>、<tt class="docutils literal"><span class="pre">org.joda.time.LocalDate</span></tt>など)はサポートされていない。</div>
<div class="line">そのため、EntityクラスのフィールドにJoda-Timeのクラスを使用する場合は、Joda-Time用のTypeHandlerを用意する必要がある。</div>
</div>
<p><tt class="docutils literal"><span class="pre">org.joda.time.DateTime</span></tt>と<tt class="docutils literal"><span class="pre">java.sql.Timestamp</span></tt>をマッピングするためのTypeHandlerの実装例を、以下に示す。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Jada-Timeから提供されている他のクラス(<tt class="docutils literal"><span class="pre">LocalDateTime</span></tt>、<tt class="docutils literal"><span class="pre">LocalDate</span></tt>、<tt class="docutils literal"><span class="pre">LocalTime</span></tt>など)も同じ要領で実装すればよい。</p>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">infra</span><span class="o">.</span><span class="na">mybatis</span><span class="o">.</span><span class="na">typehandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.sql.CallableStatement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.PreparedStatement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.ResultSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Timestamp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.ibatis.type.BaseTypeHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.type.JdbcType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.DateTime</span><span class="o">;</span>

<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DateTimeTypeHandler</span> <span class="kd">extends</span> <span class="n">BaseTypeHandler</span><span class="o">&lt;</span><span class="n">DateTime</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setNonNullParameter</span><span class="o">(</span><span class="n">PreparedStatement</span> <span class="n">ps</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">,</span>
            <span class="n">DateTime</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">JdbcType</span> <span class="n">jdbcType</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">ps</span><span class="o">.</span><span class="na">setTimestamp</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="k">new</span> <span class="n">Timestamp</span><span class="o">(</span><span class="n">parameter</span><span class="o">.</span><span class="na">getMillis</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">DateTime</span> <span class="nf">getNullableResult</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="n">String</span> <span class="n">columnName</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">toDateTime</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="n">columnName</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">DateTime</span> <span class="nf">getNullableResult</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">columnIndex</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">toDateTime</span><span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="n">columnIndex</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// (3)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">DateTime</span> <span class="nf">getNullableResult</span><span class="o">(</span><span class="n">CallableStatement</span> <span class="n">cs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">columnIndex</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">toDateTime</span><span class="o">(</span><span class="n">cs</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="n">columnIndex</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">DateTime</span> <span class="nf">toDateTime</span><span class="o">(</span><span class="n">Timestamp</span> <span class="n">timestamp</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// (4)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">timestamp</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="o">(</span><span class="n">timestamp</span><span class="o">.</span><span class="na">getTime</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">MyBatis3から提供されている<tt class="docutils literal"><span class="pre">BaseTypeHandler</span></tt>を親クラスに指定する。</p>
<p class="last">その際、<tt class="docutils literal"><span class="pre">BaseTypeHandler</span></tt>のジェネリック型には、<tt class="docutils literal"><span class="pre">DateTime</span></tt>を指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">DateTime</span></tt>を<tt class="docutils literal"><span class="pre">Timestamp</span></tt>に変換し、<tt class="docutils literal"><span class="pre">PreparedStatement</span></tt>に設定する処理を実装する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">ResultSet</span></tt>又は<tt class="docutils literal"><span class="pre">CallableStatement</span></tt>から取得した<tt class="docutils literal"><span class="pre">Timestamp</span></tt>を<tt class="docutils literal"><span class="pre">DateTime</span></tt>に変換し、返り値として返却する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">null</span></tt>を許可するカラムの場合、<tt class="docutils literal"><span class="pre">Timestamp</span></tt>が<tt class="docutils literal"><span class="pre">null</span></tt>になる可能性があるため、
<tt class="docutils literal"><span class="pre">null</span></tt>チェックを行ってから<tt class="docutils literal"><span class="pre">DateTime</span></tt>に変換する必要がある。</p>
<p class="last">上記実装例では、3つのメソッドで同じ処理が必要になるため、privateメソッドを作成している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resulthandler">
<span id="dataaccessmybatis3howtoextendresulthandler"></span><h3><a class="toc-backref" href="#id130">5.2.3.3. ResultHandlerの実装</a><a class="headerlink" href="#resulthandler" title="Permalink to this headline">¶</a></h3>
<p>MyBatis3では、検索結果を1件単位で処理する仕組みを提供している。</p>
<p>この仕組みを利用すると、</p>
<ul class="simple">
<li>DBより取得した値をJavaの処理で加工する</li>
<li>DBより取得した値などをJavaの処理として集計する</li>
</ul>
<p>といった処理を行う際に、同時に消費するメモリの容量を最小限に抑える事ができる。</p>
<p>例えば、検索結果をCSV形式のデータとしてダウンロードするような処理を実装する場合は、
検索結果を1件単位で処理する仕組みを使用するとよい。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>検索結果が大量になる可能性があり、且つJavaの処理で検索結果を1件ずつ処理する必要がある場合は、</strong>
<strong>この仕組みを使用することを強く推奨する。</strong></p>
<p>検索結果を1件単位で処理する仕組みを使用しない場合、
検索結果の全データ「1データのサイズ * 検索結果件数」をメモリ上に同時に確保することになり、
全てのデータに対して処理が終了するまでGC候補になることはない。</p>
<p>一方、検索結果を1件単位で処理する仕組みを使用した場合、
基本的には「1データのサイズ」をメモリ上に確保するだけであり、
1データの処理を終えた時点でGC候補となる。</p>
<p>例えば「1データのサイズ」が<tt class="docutils literal"><span class="pre">2KB</span></tt>で「検索結果件数」が<tt class="docutils literal"><span class="pre">10,000</span></tt>件だった場合、</p>
<ul class="simple">
<li>まとめて処理を行う場合は、<tt class="docutils literal"><span class="pre">20MB</span></tt>のメモリ</li>
<li>1件単位で処理を行う場合は、<tt class="docutils literal"><span class="pre">2KB</span></tt>のメモリ</li>
</ul>
<p>が同時に消費される。シングルスレッドで動くアプリケーションであれば問題になる事はないが、
Webアプリケーションの様なマルチスレッドで動くアプリケーションの場合は、問題になる事がある。</p>
<p>仮に100スレッドで同時に処理を行った場合、</p>
<ul class="simple">
<li>まとめて処理を行う場合は、<tt class="docutils literal"><span class="pre">2GB</span></tt>のメモリ</li>
<li>1件単位で処理を行う場合は、<tt class="docutils literal"><span class="pre">200KB</span></tt>のメモリ</li>
</ul>
<p>が同時に消費される。</p>
<p>結果として、</p>
<ul class="simple">
<li>まとめて処理を行う場合は、ヒープの最大サイズの指定によっては、メモリ枯渇によるシステムダウンやフルGCの頻発による性能劣化などが起こる可能性が高まる。</li>
<li>1件単位で処理を行う場合は、メモリ枯渇やコストの高いGC処理が発生する可能性を抑える事ができる。</li>
</ul>
<p class="last">上記に挙げた数字は目安であり、実際の計測値ではないという点を補足しておく。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に、検索結果をCSV形式のデータとしてダウンロードする処理の実装例を示す。</p>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>

    <span class="c1">// (1) (2)</span>
    <span class="kt">void</span> <span class="nf">collectAllByCriteria</span><span class="o">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="n">ResultHandler</span> <span class="n">resultHandler</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>メソッドの引数として、  <tt class="docutils literal"><span class="pre">org.apache.ibatis.session.ResultHandler</span></tt>を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">メソッドの返り値は、<tt class="docutils literal"><span class="pre">void</span></tt>型を指定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">void</span></tt>以外を指定すると、<tt class="docutils literal"><span class="pre">ResultHandler</span></tt>が呼び出されなくなるので、注意すること。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにSQLを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;collectAllByCriteria&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;TodoCriteria&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    <span class="nt">&lt;where&gt;</span>
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;title != null&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;titleContainingCondition&quot;</span>
                  <span class="na">value=</span><span class="s">&quot;@org.terasoluna.gfw.common.query.QueryEscapeUtils@toContainingCondition()&quot;</span> <span class="nt">/&gt;</span>
            todo_titile LIKE #{titleContainingCondition} ESCAPE &#39;~&#39;
        <span class="nt">&lt;/if&gt;</span>
        <span class="nt">&lt;if</span> <span class="na">test=</span><span class="s">&quot;createdAt != null&quot;</span><span class="nt">&gt;</span>
            <span class="cp">&lt;![CDATA[</span>
<span class="cp">            AND created_at &lt; #{createdAt}</span>
<span class="cp">            ]]&gt;</span>
        <span class="nt">&lt;/if&gt;</span>
    <span class="nt">&lt;/where&gt;</span>
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>マッピングファイルの実装は、通常の検索処理と同じである。</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>fetchSize属性の指定について</strong></p>
<p>大量のデータを返すようなクエリを記述する場合には、<tt class="docutils literal"><span class="pre">fetchSize</span></tt>属性に適切な値を設定すること。
<tt class="docutils literal"><span class="pre">fetchSize</span></tt>属性は、JDBCドライバとデータベース間の通信において、
一度の通信で取得するデータの件数を設定するパラメータである。</p>
<p class="last"><tt class="docutils literal"><span class="pre">fetchSize</span></tt>属性を省略した場合は、JDBCドライバのデフォルト値が利用されるため、
デフォルト値が全件取得するJDBCドライバの場合、メモリの枯渇の原因になる可能性があるので、
注意が必要となる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>ServiceクラスにRepositoryをDIし、Repositoryインターフェースのメソッドを呼び出す。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">DateTimeFormatter</span> <span class="n">DATE_FORMATTER</span> <span class="o">=</span>
        <span class="n">DateTimeFormat</span><span class="o">.</span><span class="na">forPattern</span><span class="o">(</span><span class="s">&quot;yyyy/MM/dd&quot;</span><span class="o">);</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">downloadTodos</span><span class="o">(</span><span class="n">TodoCriteria</span> <span class="n">criteria</span><span class="o">,</span>
        <span class="kd">final</span> <span class="n">BufferedWriter</span> <span class="n">downloadWriter</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// (4)</span>
        <span class="n">ResultHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResultHandler</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleResult</span><span class="o">(</span><span class="n">ResultContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="o">(</span><span class="n">Todo</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getResultObject</span><span class="o">();</span>
                <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">getTodoId</span><span class="o">());</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">getTodoTitle</span><span class="o">());</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">isFinished</span><span class="o">());</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">DATE_FORMATTER</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">getCreatedAt</span><span class="o">().</span><span class="na">getTime</span><span class="o">()));</span>
                    <span class="n">downloadWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                    <span class="n">downloadWriter</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">SystemException</span><span class="o">(</span><span class="s">&quot;e.xx.fw.9001&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="c1">// (5)</span>
        <span class="n">todoRepository</span><span class="o">.</span><span class="na">collectAllByCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>

    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">ResultHandler</span></tt>のインスタンスを生成する。</p>
<p><tt class="docutils literal"><span class="pre">ResultHandler</span></tt>の<tt class="docutils literal"><span class="pre">handleResult</span></tt>メソッドの中に、1件毎に行う処理を実装する。</p>
<p class="last">上記例では、<tt class="docutils literal"><span class="pre">ResultHandler</span></tt>の実装クラスは作らず、無名オブジェクトとして<tt class="docutils literal"><span class="pre">ResultHandler</span></tt>の実装を行っている。
実装クラスを作成してもよいが、複数の処理で共有する必要がない場合は、無理に実装クラスを作成する必要はない。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p class="first">Repositoryインタフェースのメソッドを呼び出す。</p>
<p>メソッドを呼び出す際に、(4)で生成した<tt class="docutils literal"><span class="pre">ResultHandler</span></tt>のインスタンスを引数に指定する。</p>
<p><tt class="docutils literal"><span class="pre">ResultHandler</span></tt>を使用した場合、MyBatisは以下の処理を検索結果の件数分繰り返す。</p>
<ul class="last simple">
<li>検索結果からレコードを取得し、JavaBeanにマッピングを行う。</li>
<li><tt class="docutils literal"><span class="pre">ResultHandler</span></tt>インスタンスの<tt class="docutils literal"><span class="pre">handleResult(ResultContext)</span></tt>メソッドを呼び出す。</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>ResultHandler使用時の注意点</strong></p>
<p><tt class="docutils literal"><span class="pre">ResultHandler</span></tt>を使用する場合、以下の２点に注意すること。</p>
<ul class="last simple">
<li>MyBatis3では、検索処理の性能向上させる仕組みとして、検索結果をローカルキャッシュ及びグローバルな2次キャッシュに保存する仕組みを提供しているが、<tt class="docutils literal"><span class="pre">ResultHandler</span></tt>を引数に取るメソッドから返されるデータはキャッシュされない。</li>
<li>手動マッピングを使用して複数行のデータを一つのJavaオブジェクトにマッピングするステートメントに対して<tt class="docutils literal"><span class="pre">ResultHandler</span></tt>を使用した場合、不完全な状態(関連Entityのオブジェクトがマッピングされる前の状態)のオブジェクトが渡されるケースがある。</li>
</ul>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>ResultContextのメソッドについて</strong></p>
<p><tt class="docutils literal"><span class="pre">ResultHandler#handleResult</span></tt>メソッドの引数である<tt class="docutils literal"><span class="pre">ResultContext</span></tt>には、以下のメソッドが用意がされている。</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">メソッド</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>getResultObject</td>
<td><tt class="docutils literal"><span class="pre">select</span></tt>要素の  <tt class="docutils literal"><span class="pre">resultType</span></tt>属性で指定したJavaクラスのオブジェクトを取得するためのメソッド。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>getResultCount</td>
<td><tt class="docutils literal"><span class="pre">ResultHandler#handleResult</span></tt>メソッドの呼び出し回数を取得するためのメソッド。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>stop</td>
<td>以降のレコードに対する処理を中止するようにMyBatis側に通知するためのメソッド。
このメソッドは、以降のレコードを全て破棄したい場合に使用するとよい。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p class="last"><tt class="docutils literal"><span class="pre">ResultContext</span></tt>には<tt class="docutils literal"><span class="pre">isStopped</span></tt>というメソッドもあるが、これはMyBatis側が使用するメソッドなので、説明は割愛する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortype">
<span id="id48"></span><h3><a class="toc-backref" href="#id131">5.2.3.4. SQL実行モードの利用</a><a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortype" title="Permalink to this headline">¶</a></h3>
<p>MyBatis3では、SQLを実行するモードとして以下の3種類を用意しており、デフォルトは<tt class="docutils literal"><span class="pre">SIMPLE</span></tt>である。</p>
<p>ここでは、</p>
<ul class="simple">
<li>実行モードの使用方法</li>
<li>バッチモードのRepository利用時の注意点</li>
</ul>
<div class="line-block">
<div class="line">について説明を行う。</div>
<div class="line">実行モードの説明については、「<a class="reference internal" href="#dataaccessmybatis3howtousesettingsexecutortype"><em>SQL実行モードの設定</em></a>」を参照されたい。</div>
</div>
<div class="section" id="preparedstatement">
<span id="dataaccessmybatis3howtoextendexecutortypereuse"></span><h4><a class="toc-backref" href="#id132">5.2.3.4.1. PreparedStatement再利用モードの利用</a><a class="headerlink" href="#preparedstatement" title="Permalink to this headline">¶</a></h4>
<p>実行モードを<tt class="docutils literal"><span class="pre">SIMPLE</span></tt>から<tt class="docutils literal"><span class="pre">REUSE</span></tt>に変更した場合、MyBatis内部の<tt class="docutils literal"><span class="pre">PreparedStatement</span></tt>の扱い方は変わるが、
MyBatisの動作(使い方)は変わらない。</p>
<p>実行モードをデフォルト(<tt class="docutils literal"><span class="pre">SIMPLE</span></tt>)から<tt class="docutils literal"><span class="pre">REUSE</span></tt>に変更する方法を、以下に示す。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></tt> に設定を追加する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration</span>
<span class="cp">        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;settings&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;defaultExecutorType&quot;</span> <span class="na">value=</span><span class="s">&quot;REUSE&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">defaultExecutorType</span></tt>に<tt class="docutils literal"><span class="pre">REUSE</span></tt>に変更する。</p>
<p class="last">上記設定を行うと、デフォルト動作がPreparedStatement再利用モードになる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatch">
<span id="id49"></span><h4><a class="toc-backref" href="#id133">5.2.3.4.2. バッチモードの利用</a><a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatch" title="Permalink to this headline">¶</a></h4>
<p>Mapperインタフェースの更新系メソッドの呼び出しを、全てバッチモードで実行する場合は、
「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypereuse"><em>PreparedStatement再利用モードの利用</em></a>」と同じ方法で、
実行モードを<tt class="docutils literal"><span class="pre">BATCH</span></tt>モードに変更すればよい。</p>
<p>ただし、バッチモードはいくつかの制約事項があるため、
実際のアプリケーション開発では<tt class="docutils literal"><span class="pre">SIMPLE</span></tt>又は<tt class="docutils literal"><span class="pre">REUSE</span></tt>モードと共存して使用するケースが想定される。</p>
<p>例えば、</p>
<ul class="simple">
<li>大量のデータ更新を伴い性能要件を充たす事が最優先される処理では、バッチモードを使用する。</li>
<li>楽観ロックの制御などデータの一貫性を保つために更新結果の判定が必要な処理では、<tt class="docutils literal"><span class="pre">SIMPLE</span></tt>又は<tt class="docutils literal"><span class="pre">REUSE</span></tt>モードを使用する。</li>
</ul>
<p>等の使い分けを行う場合である。</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>実行モードを共存して使用する際の注意点</strong></p>
<p>アプリケーション内で複数の実行モードを使用する場合は、
<strong>同一トランザクション内で実行モードを切り替える事が出来ないという点に注意すること。</strong></p>
<p>仮に同一トランザクション内で複数の実行モードを使用した場合は、MyBatisが矛盾を検知しエラーとなる。</p>
<p>これは、同一トランザクション内の処理において、</p>
<ul class="simple">
<li>XxxRepositoryのメソッド呼び出しは<tt class="docutils literal"><span class="pre">BATCH</span></tt>モードで実行する</li>
<li>YyyRepositoryのメソッド呼び出しは<tt class="docutils literal"><span class="pre">REUSE</span></tt>モードで実行する</li>
</ul>
<p>といった事が出来ないという事を意味する。</p>
<p>本ガイドラインをベースに作成するアプリケーションのトランザクション境界は、
Service又はRepositoryとなる。
そのため、<strong>アプリケーション内で複数の実行モードを使用する場合は、</strong>
<strong>ServiceやRepositoryの設計を行う際に、実行モードを意識する必要がある。</strong></p>
<p class="last">トランザクションを分離させたい場合は、ServiceやRepositoryのメソッドアノテーションとして、
<tt class="docutils literal"><span class="pre">&#64;Transactional(propagation</span> <span class="pre">=</span> <span class="pre">Propagation.REQUIRES_NEW)</span></tt>を指定する事で実現する事ができる。
トランザクション管理の詳細については、「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#service-transaction-management"><em>トランザクション管理について</em></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以降では、</p>
<ul class="simple">
<li>複数の実行モードを共存させるための設定方法</li>
<li>アプリケーションの実装例</li>
</ul>
<p>について説明を行う。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchindividualsetting">
<span id="id50"></span><h5>5.2.3.4.2.1. 個別にバッチモードのRepositoryを作成するための設定<a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchindividualsetting" title="Permalink to this headline">¶</a></h5>
<p>特定のRepositoryに対してバッチモードのRepositoryを作成したい場合は、
MyBatis-Springから提供されている<tt class="docutils literal"><span class="pre">org.mybatis.spring.mapper.MapperFactoryBean</span></tt>を使用して、
RepositoryのBean定義を行えばよい。</p>
<p>下記の設定例では、</p>
<ul class="simple">
<li>通常使用するRepositoryとして<tt class="docutils literal"><span class="pre">REUSE</span></tt>モードのRepository</li>
<li>特定のRepositoryに対して<tt class="docutils literal"><span class="pre">BATCH</span></tt>モードのRepository</li>
</ul>
<p>をBean登録している。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-infra.xml</span></tt> にBean定義を追加する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
       <span class="na">xmlns:mybatis=</span><span class="s">&quot;http://mybatis.org/schema/mybatis-spring&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">       http://www.springframework.org/schema/beans</span>
<span class="s">       http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">       http://www.springframework.org/schema/context</span>
<span class="s">       http://www.springframework.org/schema/context/spring-context.xsd</span>
<span class="s">       http://mybatis.org/schema/mybatis-spring</span>
<span class="s">       http://mybatis.org/schema/mybatis-spring.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocation&quot;</span>
                  <span class="na">value=</span><span class="s">&quot;classpath:META-INF/mybatis/mybatis-config.xml&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionTemplate&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlSessionFactory&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;REUSE&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;mybatis:scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.domain.repository&quot;</span>
                  <span class="na">template-ref=</span><span class="s">&quot;sqlSessionTemplate&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (2) --&gt;</span>

    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;batchSqlSessionTemplate&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlSessionFactory&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;BATCH&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;todoBatchRepository&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- (5) --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mapperInterface&quot;</span>
                  <span class="na">value=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- (6) --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlSessionTemplate&quot;</span> <span class="na">ref=</span><span class="s">&quot;batchSqlSessionTemplate&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>通常使用するRepositoryで利用するための<tt class="docutils literal"><span class="pre">SqlSessionTemplate</span></tt>をBean定義する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">通常使用するRepositoryをスキャンしBean登録する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">template-ref</span></tt>属性に、(1)で定義した<tt class="docutils literal"><span class="pre">SqlSessionTemplate</span></tt>を指定する。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>バッチモードのRepositoryで利用するための<tt class="docutils literal"><span class="pre">SqlSessionTemplate</span></tt>をBean定義する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">バッチモード用のRepositoryをBean定義する。</p>
<p><tt class="docutils literal"><span class="pre">id</span></tt>属性には、(2)でスキャンしたRepositoryのBean名と重複しない値を指定する。
(2)でスキャンされたRepositoryのBean名は、インタフェース名を「lowerCamelCase」にした値にとなる。</p>
<p class="last">上記例では、バッチモード用の<tt class="docutils literal"><span class="pre">TodoRepository</span></tt>が<tt class="docutils literal"><span class="pre">todoBatchRepository</span></tt>という名前のBeanでBean登録される。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">mapperInterface</span></tt>プロパティには、
バッチモードを利用するRepositoryのインタフェース名(FQCN)を指定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">sqlSessionTemplate</span></tt>プロパティには、
(3)で定義したバッチモード用の<tt class="docutils literal"><span class="pre">SqlSessionTemplate</span></tt>を指定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><tt class="docutils literal"><span class="pre">SqlSessionTemplate</span></tt>をBean定義すると、アプリケーション終了時に以下の様なWARNログが出力される。</p>
<p>これは、<tt class="docutils literal"><span class="pre">SqlSession</span></tt>インタフェースが<tt class="docutils literal"><span class="pre">java.io.Closeable</span></tt>を継承しているため、
SpringのApplicationContextの終了処理時に<tt class="docutils literal"><span class="pre">close</span></tt>メソッドが呼び出されている事が原因である。</p>
<blockquote>
<div><div class="highlight-text"><div class="highlight"><pre>21:12:35.999 [Thread-2] WARN  o.s.b.f.s.DisposableBeanAdapter - Invocation of destroy method &#39;close&#39; failed on bean with name &#39;sqlSessionTemplate&#39;
java.lang.UnsupportedOperationException: Manual close is not allowed over a Spring managed SqlSession
    at org.mybatis.spring.SqlSessionTemplate.close(SqlSessionTemplate.java:310) ~[mybatis-spring-1.2.2.jar:1.2.2]
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_20]
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_20]
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_20]
    at java.lang.reflect.Method.invoke(Method.java:483) ~[na:1.8.0_20]
</pre></div>
</div>
</div></blockquote>
<p>上記ログが出力されても、アプリケーションの動作に影響はないため、システム運用上問題がなければ対策は不要である。</p>
<p>ただし、ログ監視などシステム運用上問題がある場合は、
SpringのApplicationContextの終了処理時に呼び出されるメソッド(<tt class="docutils literal"><span class="pre">destroy-method</span></tt>属性)を指定する事で、
ログ出力を抑止する事ができる。</p>
<p>下記例では、<tt class="docutils literal"><span class="pre">getExecutorType</span></tt>メソッドを呼び出すように指定している。
<tt class="docutils literal"><span class="pre">getExecutorType</span></tt>メソッドは、コンストラクタ引数で指定した実行モードを返却するだけのメソッドであり、
このメソッドを呼び出しても他への副作用はない。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;batchSqlSessionTemplate&quot;</span>
      <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span>
<span class="hll">      <span class="na">destroy-method=</span><span class="s">&quot;getExecutorType&quot;</span><span class="nt">&gt;</span>
</span>    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlSessionFactory&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;BATCH&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchbulksetting">
<span id="id51"></span><h5>5.2.3.4.2.2. 一括でバッチモードのRepositoryを作成するための設定<a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchbulksetting" title="Permalink to this headline">¶</a></h5>
<p>一括でバッチモードのRepositoryを作成したい場合は、
MyBatis-Springから提供されているスキャン機能(<tt class="docutils literal"><span class="pre">mybatis:scan</span></tt>要素)を使用して、
RepositoryのBean定義を行えばよい。</p>
<p>下記の設定例では、全てのRepositoryに対して、<tt class="docutils literal"><span class="pre">REUSE</span></tt>モードと<tt class="docutils literal"><span class="pre">BATCH</span></tt>モードのRepositoryをBean登録している。</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">BeanNameGenerator</span></tt>を作成する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.config.BeanDefinition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.support.BeanDefinitionRegistry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.support.BeanNameGenerator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.util.ClassUtils</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.beans.Introspector</span><span class="o">;</span>

<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BachRepositoryBeanNameGenerator</span> <span class="kd">implements</span> <span class="n">BeanNameGenerator</span> <span class="o">{</span>
    <span class="c1">// (2)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">generateBeanName</span><span class="o">(</span><span class="n">BeanDefinition</span> <span class="n">definition</span><span class="o">,</span> <span class="n">BeanDefinitionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">defaultBeanName</span> <span class="o">=</span> <span class="n">Introspector</span><span class="o">.</span><span class="na">decapitalize</span><span class="o">(</span><span class="n">ClassUtils</span><span class="o">.</span><span class="na">getShortName</span><span class="o">(</span><span class="n">definition</span>
                <span class="o">.</span><span class="na">getBeanClassName</span><span class="o">()));</span>
        <span class="k">return</span> <span class="n">defaultBeanName</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;Repository&quot;</span><span class="o">,</span> <span class="s">&quot;BatchRepository&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">SpringのApplicationContextに登録するBean名を生成するクラスを作成する。</p>
<p class="last">このクラスは、通常使用する<tt class="docutils literal"><span class="pre">REUSE</span></tt>モードのRepositoryのBean名と、
<tt class="docutils literal"><span class="pre">BATCH</span></tt>モードのBean名が重複しないようにするために必要なクラスである。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">Bean名を生成するためのメソッドを実装する。</p>
<p class="last">上記例では、Bean名のsuffixを<tt class="docutils literal"><span class="pre">BatchRepository</span></tt>とする事で、
通常使用される<tt class="docutils literal"><span class="pre">REUSE</span></tt>モードのRepositoryのBean名と重複しないようにしている。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-infra.xml</span></tt> にBean定義を追加する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
       <span class="na">xmlns:mybatis=</span><span class="s">&quot;http://mybatis.org/schema/mybatis-spring&quot;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">       http://www.springframework.org/schema/beans</span>
<span class="s">       http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">       http://www.springframework.org/schema/context</span>
<span class="s">       http://www.springframework.org/schema/context/spring-context.xsd</span>
<span class="s">       http://mybatis.org/schema/mybatis-spring</span>
<span class="s">       http://mybatis.org/schema/mybatis-spring.xsd&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocation&quot;</span>
                  <span class="na">value=</span><span class="s">&quot;classpath:META-INF/mybatis/mybatis-config.xml&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;batchSqlSessionTemplate&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;sqlSessionFactory&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;BATCH&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;mybatis:scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.domain.repository&quot;</span>
        <span class="na">template-ref=</span><span class="s">&quot;batchSqlSessionTemplate&quot;</span>
        <span class="na">name-generator=</span><span class="s">&quot;com.example.domain.repository.BatchRepositoryBeanNameGenerator&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">属性</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>-</td>
<td><tt class="docutils literal"><span class="pre">mybatis:scan</span></tt>要素を使用して、バッチモードのRepositoryをBean登録する。</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>base-package</td>
<td><p class="first">Repositoryをスキャンするベースパッケージを指定する。</p>
<p class="last">指定パッケージの配下に存在するRepositoryインタフェースがスキャンされ、
SpringのApplicationContextにBean登録される。</p>
</td>
</tr>
<tr class="row-even"><td>&nbsp;</td>
<td>template-ref</td>
<td>バッチモード用の<tt class="docutils literal"><span class="pre">SqlSessionTemplate</span></tt>のBeanを指定する。</td>
</tr>
<tr class="row-odd"><td>&nbsp;</td>
<td>name-generator</td>
<td><p class="first">スキャンしたRepositoryのBean名を生成するためのクラスを指定する。</p>
<p>具体的には、(1)で作成したクラスのクラス名(FQCN)を指定する。</p>
<p class="last">この指定を省略した場合、Bean名が重複するため、
バッチモードのRepositoryはSpringのApplicationContextに登録されない。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchusage">
<span id="id52"></span><h5>5.2.3.4.2.3. バッチモードのRepositoryの使用例<a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchusage" title="Permalink to this headline">¶</a></h5>
<p>以下に、バッチモードのRepositoryを使用してデータベースにアクセスするための実装例を示す。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="c1">// (1)</span>
    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;todoBatchRepository&quot;</span><span class="o">)</span>
    <span class="n">TodoRepository</span> <span class="n">todoBatchRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateTodos</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="o">:</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// (2)</span>
            <span class="n">todoBatchRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>バッチモードのRepositoryをインジェクションする。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">バッチモードのRepositoryのメソッドを呼び出し、Entityの更新を行う。</p>
<p>バッチモードのRepositoryの場合は、メソッドを呼び出したタイミングでSQLが実行されないため、
メソッドから返却される更新結果は無視する必要がある。</p>
<p class="last">Entityを更新するためのSQLは、トランザクションがコミットされる直前にバッチ実行され、
エラーがなければコミットされる。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>バッチ実行のタイミングについて</strong></p>
<p>SQLがバッチ実行されるタイミングは、基本的には以下の場合である。</p>
<ul class="simple">
<li>トランザクションがコミットされる直前</li>
<li>クエリ(SELECT)を実行する直前</li>
<li>別の更新用メソッドを呼び出した直後</li>
</ul>
<p class="last">Repositoryのメソッドの呼び出し順番に関する注意点は、「<a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesmethodcallorder"><em>Repositoryのメソッドの呼び出し順番</em></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchnotes">
<span id="id53"></span><h4><a class="toc-backref" href="#id134">5.2.3.4.3. バッチモードのRepository利用時の注意点</a><a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchnotes" title="Permalink to this headline">¶</a></h4>
<p>バッチモードのRepositoryを利用する場合、Serviceクラスの実装として、
以下の点に注意する必要がある。</p>
<ul class="simple">
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesupdateresult"><em>更新結果の判定</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesduplicate"><em>一意制約違反の検知方法</em></a></li>
<li><a class="reference internal" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesmethodcallorder"><em>Repositoryのメソッドの呼び出し順番</em></a></li>
</ul>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchnotesupdateresult">
<span id="id54"></span><h5>5.2.3.4.3.1. 更新結果の判定<a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesupdateresult" title="Permalink to this headline">¶</a></h5>
<p>バッチモードのRepositoryを使用した場合、更新結果の妥当性をチェックする事ができない。</p>
<p>バッチモードを使用する場合、Mapperインタフェースのメソッドから返却される更新結果は、</p>
<ul class="simple">
<li>返り値が数値(<tt class="docutils literal"><span class="pre">int</span></tt>や<tt class="docutils literal"><span class="pre">long</span></tt>)の場合は、<a class="reference external" href="http://mybatis.github.io/mybatis-3/apidocs/reference/org/apache/ibatis/executor/BatchExecutor.html#BATCH_UPDATE_RETURN_VALUE">固定値</a>(<tt class="docutils literal"><span class="pre">org.apache.ibatis.executor.BatchExecutor#BATCH_UPDATE_RETURN_VALUE</span></tt>)</li>
<li>返り値が<tt class="docutils literal"><span class="pre">boolean</span></tt>の場合は、<tt class="docutils literal"><span class="pre">false</span></tt></li>
</ul>
<p>が返却される。</p>
<p>これは、Mapperインタフェースのメソッドを呼び出したタイミングではSQLが発行されず、
バッチ実行用にキューイング(<tt class="docutils literal"><span class="pre">java.sql.Statement#addBatch()</span></tt>)される仕組みになっているためである。</p>
<p><strong>つまり、更新結果の妥当性をチェックする必要がある場合(楽観ロックによる排他制御処理など)では、</strong>
<strong>バッチモードを使用する事はできない。</strong></p>
<blockquote>
<div><div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>MyBatis3自体の機能としては、
<tt class="docutils literal"><span class="pre">org.apache.ibatis.session.SqlSession</span></tt>インタフェースのメソッド(<tt class="docutils literal"><span class="pre">flushStatements</span></tt>)を使用すると、
バッチ実行用にキューイングされているSQLを実行し、更新結果を受け取る事ができる。
ただし、本ガイドラインでは<tt class="docutils literal"><span class="pre">SqlSession</span></tt>を直接使用する前提ではないため、
可能な限り<tt class="docutils literal"><span class="pre">SqlSession</span></tt>を直接使用しないようにする事を推奨する。</p>
<p class="last">どうしても<tt class="docutils literal"><span class="pre">SqlSession</span></tt>インタフェースのメソッドを直接呼び出す必要がある場合は、
「<a class="reference external" href="http://mybatis.github.io/spring/sqlsession.html">MyBatis-Spring REFERENCE DOCUMENTATION(Using an SqlSession)</a>」
を参照されたい。
MyBatis-Springが提供している<tt class="docutils literal"><span class="pre">org.mybatis.spring.SqlSessionTemplate</span></tt>を使用するという点がポイントである。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>バッチモード使用時のJDBCドライバの動作について</strong></p>
<p><tt class="docutils literal"><span class="pre">SqlSession</span></tt>インタフェースを使用するとバッチ実行時の更新結果を受け取る事ができると前述したが、
JDBCドライバから返却される更新結果が「処理したレコード数」になる保証はない。</p>
<p class="last">これは、使用するJDBCドライバの実装にも依存する部分なので、
使用するJDBCドライバの仕様を確認しておく必要がある。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>これは、以下の様な実装が出来ないことを意味している。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;todoBatchRepository&quot;</span><span class="o">)</span>
    <span class="n">TodoRepository</span> <span class="n">todoBatchRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateTodos</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="o">:</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">updateSuccess</span> <span class="o">=</span> <span class="n">todoBatchRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
            <span class="c1">// (1)</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">updateSuccess</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ...</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>上記例のように実装した場合、更新結果は常に<tt class="docutils literal"><span class="pre">false</span></tt>になるため、
必ず更新失敗時の処理が実行されてしまう。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchnotesduplicate">
<span id="id56"></span><h5>5.2.3.4.3.2. 一意制約違反の検知方法<a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesduplicate" title="Permalink to this headline">¶</a></h5>
<p>バッチモードのRepositoryを使用した場合、
一意制約違反などのデータベースエラーをServiceの処理として検知する事が出来ないケースがある。</p>
<p>これは、Mapperインタフェースのメソッドを呼び出したタイミングではSQLが発行されず、
バッチ実行用にキューイング(<tt class="docutils literal"><span class="pre">java.sql.Statement#addBatch()</span></tt>)される仕組みになっているためであり、
以下の様な実装が出来ないことを意味している。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;todoBatchRepository&quot;</span><span class="o">)</span>
    <span class="n">TodoRepository</span> <span class="n">todoBatchRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">storeTodos</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="o">:</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">todoBatchRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
            <span class="c1">// (1)</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">DuplicateKeyException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ....</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">上記例のように実装した場合、
このタイミングで<tt class="docutils literal"><span class="pre">org.springframework.dao.DuplicateKeyException</span></tt>が発生することはないため、
<tt class="docutils literal"><span class="pre">DuplicateKeyException</span></tt>補足後の処理が実行される事はない。</p>
<p class="last">これは、SQLがバッチ実行されるタイミングが、
Serviceの処理が終わった後(トランザクションがコミットされる直前)に行われるためである。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendexecutortypebatchnotesmethodcallorder">
<span id="id57"></span><h5>5.2.3.4.3.3. Repositoryのメソッドの呼び出し順番<a class="headerlink" href="#dataaccessmybatis3howtoextendexecutortypebatchnotesmethodcallorder" title="Permalink to this headline">¶</a></h5>
<p>バッチモードを使用する目的は更新処理の性能向上であるが、
Repositoryのメソッドの呼び出し順番を間違えると、性能向上につながらないケースがある。</p>
<p>バッチモードを使用して性能向上させるためには、以下のMyBatisの仕様を理解しておく必要がある。</p>
<ul class="simple">
<li>クエリ(SELECT)を実行すると、それまでキューイングされていたSQLがバッチ実行される。</li>
<li>連続して呼び出された更新処理(Repositoryのメソッド)毎に<tt class="docutils literal"><span class="pre">PreparedStatement</span></tt>が生成され、SQLをキューイングする。</li>
</ul>
<p>これは、以下の様な実装をすると、バッチモードを利用するメリットがない事を意味している。</p>
<ul class="simple">
<li>例１</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;todoBatchRepository&quot;</span><span class="o">)</span>
    <span class="n">TodoRepository</span> <span class="n">todoBatchRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">storeTodos</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="o">:</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// (1)</span>
            <span class="n">Todo</span> <span class="n">currentTodo</span> <span class="o">=</span> <span class="n">todoBatchRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">todo</span><span class="o">.</span><span class="na">getTodoId</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">currentTodo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">todoBatchRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span><span class="o">{</span>
                <span class="n">todoBatchRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">上記例のように実装した場合、繰返し処理の先頭にクエリを発行しているため、
1件毎にSQLがバッチ実行される事になってしまう。
これはほぼ、シンプルモード(<tt class="docutils literal"><span class="pre">SIMPLE</span></tt>)で実行しているのと同義である。</p>
<p class="last">上記のような処理が必要な場合は、
PreparedStatement再利用モード(<tt class="docutils literal"><span class="pre">REUSE</span></tt>)のRepositoryを使用した方が効率的である。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ul class="simple">
<li>例２</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@Transactional</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nd">@Named</span><span class="o">(</span><span class="s">&quot;todoBatchRepository&quot;</span><span class="o">)</span>
    <span class="n">TodoRepository</span> <span class="n">todoBatchRepository</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">storeTodos</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Todo</span> <span class="n">todo</span> <span class="o">:</span> <span class="n">todos</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// (2)</span>
            <span class="n">todoBatchRepository</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
            <span class="n">todoBatchRepository</span><span class="o">.</span><span class="na">createHistory</span><span class="o">(</span><span class="n">todo</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">上記のような処理が必要な場合は、Repositoryのメソッドが交互に呼び出されているため、
1件毎に<tt class="docutils literal"><span class="pre">PreparedStatement</span></tt>が生成されてしまう。
これはほぼ、シンプルモード(<tt class="docutils literal"><span class="pre">SIMPLE</span></tt>)で実行しているのと同義である。</p>
<p class="last">上記のような処理が必要な場合は、
PreparedStatement再利用モード(<tt class="docutils literal"><span class="pre">REUSE</span></tt>)のRepositoryを使用した方が効率的である。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3howtoextendstoredprocedure">
<span id="id58"></span><h3><a class="toc-backref" href="#id135">5.2.3.5. ストアドプロシージャの実装</a><a class="headerlink" href="#dataaccessmybatis3howtoextendstoredprocedure" title="Permalink to this headline">¶</a></h3>
<p>データベースに登録されているストアドプロシージャやファンクションを、
MyBatis3から呼び出す方法について説明を行う。</p>
<p>以下で説明する実装例では、PostgreSQLに登録されているファンクションを呼び出している。</p>
<ul class="simple">
<li>ストアードプロシージャ（ファンクション）を登録する。</li>
</ul>
<blockquote>
<div><div class="highlight-guess"><div class="highlight"><pre><span class="cm">/* (1) */</span>
<span class="no">CREATE</span> <span class="no">FUNCTION</span> <span class="n">findTodo</span><span class="p">(</span><span class="n">pTodoId</span> <span class="no">CHAR</span><span class="p">)</span>
<span class="no">RETURNS</span> <span class="no">TABLE</span><span class="p">(</span>
    <span class="n">todo_id</span> <span class="no">CHAR</span><span class="p">,</span>
    <span class="n">todo_title</span> <span class="no">VARCHAR</span><span class="p">,</span>
    <span class="n">finished</span> <span class="no">BOOLEAN</span><span class="p">,</span>
    <span class="n">created_at</span> <span class="no">TIMESTAMP</span><span class="p">,</span>
    <span class="n">version</span> <span class="no">BIGINT</span>
<span class="p">)</span> <span class="no">AS</span> <span class="err">$$</span> <span class="no">BEGIN</span> <span class="no">RETURN</span> <span class="no">QUERY</span>
<span class="no">SELECT</span>
    <span class="n">t</span><span class="p">.</span><span class="n">todo_id</span><span class="p">,</span>
    <span class="n">t</span><span class="p">.</span><span class="n">todo_title</span><span class="p">,</span>
    <span class="n">t</span><span class="p">.</span><span class="n">finished</span><span class="p">,</span>
    <span class="n">t</span><span class="p">.</span><span class="n">created_at</span><span class="p">,</span>
    <span class="n">t</span><span class="p">.</span><span class="n">version</span>
<span class="no">FROM</span>
    <span class="n">t_todo</span> <span class="n">t</span>
<span class="no">WHERE</span>
    <span class="n">t</span><span class="p">.</span><span class="n">todo_id</span> <span class="o">=</span> <span class="n">pTodoId</span><span class="p">;</span>
<span class="no">END</span><span class="p">;</span>
<span class="err">$$</span> <span class="no">LANGUAGE</span> <span class="n">plpgsql</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>このファンクションは、指定されたIDのレコードを取得するファンクションである。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Repositoryインタフェースにメソッドを定義する。</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="c1">// (2)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="kd">extends</span> <span class="n">Repository</span> <span class="o">{</span>
    <span class="n">Todo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>SQLを発行する際と同じインタフェースでよい。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルにストアドプロシージャの呼び出し処理を実装する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span>
            <span class="na">statementType=</span><span class="s">&quot;CALLABLE&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- (4) --&gt;</span>
        {call findTodo(#{todoId})}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">ストアドプロシージャを呼び出すステートメントを実装する。</p>
<p>ストアドプロシージャを呼び出す場合は、<tt class="docutils literal"><span class="pre">statementType</span></tt>属性に<tt class="docutils literal"><span class="pre">CALLABLE</span></tt>を指定する。
<tt class="docutils literal"><span class="pre">CALLABLE</span></tt>を指定すると、
<tt class="docutils literal"><span class="pre">java.sql.CallableStatement</span></tt>を使用してストアドプロシージャが呼び出される。</p>
<p class="last">OUTパラメータをJavaBeanにマッピングするために、
<tt class="docutils literal"><span class="pre">resultType</span></tt>属性又は<tt class="docutils literal"><span class="pre">resultMap</span></tt>属性を指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">ストアドプロシージャを呼び出す。</p>
<p>ストアドプロシージャ（ファクション）を呼び出す場合は、</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">{call</span> <span class="pre">Procedure</span> <span class="pre">or</span> <span class="pre">Function名(INパラメータ...)}</span></tt></li>
</ul>
<p>形式で指定する。</p>
<p class="last">上記例では、<tt class="docutils literal"><span class="pre">findTodo</span></tt>という名前のファンクションに対して、
INパラメータにIDを指定して呼び出している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="appendix">
<span id="dataaccessmybatis3appendix"></span><h2><a class="toc-backref" href="#id136">5.2.4. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mapper">
<span id="dataaccessmybatis3appendixaboutmappermechanism"></span><h3><a class="toc-backref" href="#id137">5.2.4.1. Mapperインタフェースの仕組みについて</a><a class="headerlink" href="#mapper" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Mapperインタフェースを使用する場合、開発者はMapperインタフェースとマッピングファイルを作成するだけで、SQLを実行する事ができる。</div>
<div class="line">Mapperインタフェースの実装クラスは、MyBatis3がJDKのProxy機能を使用してアプリケーション実行時に生成されるため、
開発者がMapperインタフェースの実装クラスを作成する必要はない。</div>
</div>
<div class="line-block">
<div class="line">Mapperインタフェースは、MyBatis3から提供されているインタフェースの継承やアノテーションなどの定義は不要であり、
単にJavaのインタフェースとして作成すればよい。</div>
<div class="line">以下に、Mapperインタフェースとマッピングファイルの作成例、及びアプリケーション(Service)での利用例を示す。</div>
<div class="line">ここでは、開発者が作成する成果物をイメージしてもらう事が目的なので、コードに対する説明はポイントとなる点に絞って行っている。</div>
</div>
<ul>
<li><p class="first">Mapperインタフェースの作成例</p>
<p>本ガイドラインでは、MyBatis3のMapperインタフェースをRepositoryインタフェースとして使用することを前提としているため、
インタフェース名は、「Entity名」 + <tt class="docutils literal"><span class="pre">&quot;Repository&quot;</span></tt> というネーミングにしている。</p>
</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TodoRepository</span> <span class="o">{</span>
    <span class="n">Todo</span> <span class="nf">findOne</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p class="first">マッピングファイルの作成例</p>
<p>マッピングファイルでは、ネームスペースとしてMapperインタフェースのFQCN(Fully Qualified Class Name)を指定し、
Mapperインタフェースに定義したメソッドの呼び出し時に実行するSQLとの紐づけは、
各種ステートメントタグ(insert/update/delete/selectタグ)のid属性に、メソッド名を指定する事で行う事ができる。</p>
</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org/DTD Mapper 3.0//EN&quot;</span>
<span class="cp">    &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="hll"><span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.todo.TodoRepository&quot;</span><span class="nt">&gt;</span>
</span>
    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;todoResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;todo_id&quot;</span> <span class="na">property=</span><span class="s">&quot;todoId&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;title&quot;</span> <span class="na">property=</span><span class="s">&quot;title&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&quot;finished&quot;</span> <span class="na">property=</span><span class="s">&quot;finished&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

<span class="hll">    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;String&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;todoResultMap&quot;</span><span class="nt">&gt;</span>
</span>      SELECT
        todo_id,
        title,
        finished
      FROM
        t_todo
      WHERE
        todo_id = #{todoId}
    <span class="nt">&lt;/select&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p class="first">アプリケーション(Service)でのMapperインタフェースの使用例</p>
<p>アプリケーション(Service)からMapperインタフェースのメソッドを呼び出す場合は、Spring(DIコンテナ)によって注入されたMapperオブジェクトのメソッドを呼び出す。
アプリケーション(Service)は、Mapperオブジェクトのメソッドを呼び出すことで、透過的にSQLが実行され、SQLの実行結果を得ることができる。</p>
</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">todo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Todo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.example.domain.repository.todo.TodoRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoServiceImpl</span> <span class="kd">implements</span> <span class="n">TodoService</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="n">TodoRepository</span> <span class="n">todoRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">Todo</span> <span class="nf">getTodo</span><span class="o">(</span><span class="n">String</span> <span class="n">todoId</span><span class="o">){</span>
<span class="hll">        <span class="n">Todo</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todoRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">todoId</span><span class="o">);</span>
</span>        <span class="k">if</span><span class="o">(</span><span class="n">todo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ResourceNotFoundException</span><span class="o">(</span>
                <span class="n">ResultMessages</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;e.ex.td.5001&quot;</span> <span class="o">,</span><span class="n">todoId</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">todo</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>以下に、Mapperインタフェースのメソッドを呼び出した際に、SQLが実行されるまでの処理フローについて説明を行う。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/DataAccessMyBatis3MapperMechanism.png"><img alt="Mapper mechanism" src="../_images/DataAccessMyBatis3MapperMechanism.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - Mapper mechanism</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">アプリケーションは、Mapperインタフェースに定義されているメソッドを呼び出す。</p>
<p class="last">Mapperインタフェースの実装クラス(MapperインタフェースのProxyオブジェクト)は、アプリケーション起動時にMyBatis3のコンポーネントによって生成される。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">MapperインタフェースのProxyオブジェクトは、<tt class="docutils literal"><span class="pre">MapperProxy</span></tt> のinvokeメソッドを呼び出す。</p>
<p class="last"><tt class="docutils literal"><span class="pre">MapperProxy</span></tt> は、Mapperインタフェースのメソッド呼び出しをハンドリングする役割をもつ。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">MapperProxy</span></tt> は、呼び出されたMapperインタフェースのメソッドに対応する <tt class="docutils literal"><span class="pre">MapperMethod</span></tt> を生成し、executeメソッドを呼び出す。</p>
<p class="last"><tt class="docutils literal"><span class="pre">MapperMethod</span></tt> は、 呼び出されたMapperインタフェースのメソッドに対応する<tt class="docutils literal"><span class="pre">SqlSession</span></tt> のメソッドを呼び出す役割をもつ。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">MapperMethod</span></tt> は、 <tt class="docutils literal"><span class="pre">SqlSession</span></tt> のメソッドを呼び出す。</p>
<p class="last"><tt class="docutils literal"><span class="pre">SqlSession</span></tt> のメソッドを呼び出す際は、実行するSQLステートメントを特定するためのキー(以降、「ステートメントID」と呼ぶ)を引き渡している。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">SqlSession</span></tt> は、指定されたステートメントIDをキーに、マッピングファイルよりSQLステートメントを取得する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">SqlSession</span></tt> は、マッピングファイルより取得したSQLステートメントに指定されているバインド変数に値を設定し、SQLを実行する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td><p class="first">Mapperインタフェース(<tt class="docutils literal"><span class="pre">SqlSession</span></tt> )は、SQLの実行結果をJavaBeanなどに変換して、アプリケーションに返却する。</p>
<p class="last">件数のカウントや、更新件数などを取得する場合は、プリミティブ型やプリミティブラッパ型などが返却値となるケースもある。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p><strong>ステートメントIDとは</strong></p>
<p>ステートメントIDは、実行するSQLステートメントを特定するためのキーであり、
<strong>「MapperインタフェースのFQCN + &#8221;.&#8221; + 呼び出されたMapperインタフェースのメソッド名」</strong> というルールで生成される。</p>
<p class="last"><tt class="docutils literal"><span class="pre">MapperMethod</span></tt> によって生成されたステートメントIDに対応するSQLステートメントをマッピングファイルに定義するためには、
マッピングファイルのネームスペースに「MapperインタフェースのFQCN」、
各種ステートメントタグのid属性に「Mapperインタフェースのメソッド名」を指定する必要がある。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixsettingstypealias">
<span id="id59"></span><h3><a class="toc-backref" href="#id138">5.2.4.2. TypeAliasの設定</a><a class="headerlink" href="#dataaccessmybatis3appendixsettingstypealias" title="Permalink to this headline">¶</a></h3>
<p>TypeAliasの設定は、基本的には<tt class="docutils literal"><span class="pre">package</span></tt> 要素を使用してパッケージ単位で設定すればよいが、</p>
<ul class="simple">
<li>クラス単位でエイリアス名を設定する方法</li>
<li>デフォルトで付与されるエイリアス名を上書きする方法(任意のエイリアス名を指定する方法)</li>
</ul>
<p>も用意されている。</p>
<div class="section" id="id60">
<h4><a class="toc-backref" href="#id139">5.2.4.2.1. TypeAliasをクラス単位に設定</a><a class="headerlink" href="#id60" title="Permalink to this headline">¶</a></h4>
<p>TypeAliasの設定は、クラス単位で設定する事もできる。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;typeAliases&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;typeAlias</span>
</span><span class="hll">        <span class="na">type=</span><span class="s">&quot;com.example.domain.repository.account.AccountSearchCriteria&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">&quot;com.example.domain.model&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/typeAliases&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">typeAlias</span></tt> 要素の<tt class="docutils literal"><span class="pre">type</span></tt> 属性に、エイリアスを設定するクラスの完全修飾クラス名(FQCN)を指定する。</p>
<p>上記例だと、<tt class="docutils literal"><span class="pre">com.example.domain.repository.account.AccountSearchCriteria</span></tt> クラスのエイリアス名は、
<tt class="docutils literal"><span class="pre">AccountSearchCriteria</span></tt> (パッケージの部分が除去された部分)となる。</p>
<p class="last">エイリアス名に任意の値を指定したい場合は、<tt class="docutils literal"><span class="pre">typeAlias</span></tt> 要素の<tt class="docutils literal"><span class="pre">alias</span></tt> 属性に任意のエイリアス名を指定することができる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id61">
<h4><a class="toc-backref" href="#id140">5.2.4.2.2. デフォルトで付与されるエイリアス名の上書き</a><a class="headerlink" href="#id61" title="Permalink to this headline">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">package</span></tt> 要素を使用してエイリアスを設定した場合や、
<tt class="docutils literal"><span class="pre">typeAlias</span></tt> 要素の<tt class="docutils literal"><span class="pre">alias</span></tt> 属性を省略してエイリアスを設定した場合は、
TypeAliasのエイリアス名は、完全修飾クラス名(FQCN)からパッケージの部分が除去された部分となる。</p>
<p>デフォルトで付与されるエイリアス名ではなく、任意のエイリアス名にしたい場合は、
TypeAliasを設定したいクラスに<tt class="docutils literal"><span class="pre">&#64;org.apache.ibatis.type.Alias</span></tt> アノテーションを指定する事で、
任意のエイリアス名を指定する事ができる。</p>
<ul class="simple">
<li>エイリアス設定対象のJavaクラス</li>
</ul>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">model</span><span class="o">.</span><span class="na">book</span><span class="o">;</span>

<span class="hll"><span class="nd">@Alias</span><span class="o">(</span><span class="s">&quot;BookAuthor&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
   <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">model</span><span class="o">.</span><span class="na">article</span><span class="o">;</span>

<span class="hll"><span class="nd">@Alias</span><span class="o">(</span><span class="s">&quot;ArticleAuthor&quot;</span><span class="o">)</span> <span class="c1">// (1)</span>
</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
   <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">&#64;Alias</span></tt> アノテーションの<tt class="docutils literal"><span class="pre">value</span></tt> 属性に、エイリアス名を指定する。</p>
<p>上記例だと、<tt class="docutils literal"><span class="pre">com.example.domain.model.book.Author</span></tt> クラスのエイリアス名は、
<tt class="docutils literal"><span class="pre">BookAuthor</span></tt> となる。</p>
<p class="last">異なるパッケージの中に同じクラス名のクラスが格納されている場合は、この方法を使用することで、それぞれ異なるエイリアス名を設定する事ができる。
ただし、本ガイドラインでは、クラス名は重複しないように設計する事を推奨する。
上記例であれば、クラス名自体を<tt class="docutils literal"><span class="pre">BookAuthor</span></tt> と<tt class="docutils literal"><span class="pre">ArticleAuthor</span></tt> にすることを検討して頂きたい。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>TypeAliasの エイリアス名は、</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">typeAlias</span></tt> 要素の<tt class="docutils literal"><span class="pre">alias</span></tt> 属性の指定値</li>
<li><tt class="docutils literal"><span class="pre">&#64;Alias</span></tt> アノテーションの<tt class="docutils literal"><span class="pre">value</span></tt> 属性の指定値</li>
<li>デフォルトで付与されるエイリアス名(完全修飾クラス名からパッケージの部分が除去された部分)</li>
</ul>
</div></blockquote>
<p class="last">の優先順で適用される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixswitchingsqlbydatabase">
<span id="id62"></span><h3><a class="toc-backref" href="#id141">5.2.4.3. データベースによるSQL切替について</a><a class="headerlink" href="#dataaccessmybatis3appendixswitchingsqlbydatabase" title="Permalink to this headline">¶</a></h3>
<p>MyBatis3では、JDBCドライバから接続しているデータベースのベンダー情報を取得して、
使用するSQLを切り替える仕組み(<tt class="docutils literal"><span class="pre">org.apache.ibatis.mapping.VendorDatabaseIdProvider</span></tt>)を提供している。</p>
<p>この仕組みは、動作環境として複数のデータベースをサポートするようなアプリケーションを構築する際に有効である。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>本ガイドラインでは、環境依存するコンポーネントや設定ファイルについては、
[projectName]-envというサブプロジェクトで管理し、
ビルド時に実行環境にあったコンポーネントや設定ファイル作成を選択するスタイルを推奨している。</p>
<p>[projectName]-envは、</p>
<ul class="simple">
<li>開発環境(ローカルのPC環境)</li>
<li>各種試験環境</li>
<li>商用環境</li>
</ul>
<p>毎の差分を吸収するためのサブプロジェクトであり、
複数のデータベースをサポートするアプリケーションの開発でも利用する事ができる。</p>
<p>基本的には、環境依存するコンポーネントや設定ファイルは、
[projectName]-envというサブプロジェクトで管理する事を推奨するが、
SQLのちょっとした違いを吸収したい場合は、本仕組みを使用してもよい。</p>
<p class="last"><strong>アーキテクトは、データベースの違いによるSQLの環境依存をどのように実装するかの指針を明確に示すことで、</strong>
<strong>アプリケーション全体として統一された実装となるように心がけてほしい。</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/spring/projectName-infra.xml</span></tt> にBean定義を追加する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:mybatis=</span><span class="s">&quot;http://mybatis.org/schema/mybatis-spring&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;</span>
<span class="s">        http://www.springframework.org/schema/beans</span>
<span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://mybatis.org/schema/mybatis-spring</span>
<span class="s">        http://mybatis.org/schema/mybatis-spring.xsd</span>
<span class="s">    &quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">&quot;classpath:/META-INF/spring/projectName-env.xml&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;databaseIdProvider&quot;</span>
          <span class="na">class=</span><span class="s">&quot;org.apache.ibatis.mapping.VendorDatabaseIdProvider&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;properties&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;props&gt;</span>
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;H2&quot;</span><span class="nt">&gt;</span>h2<span class="nt">&lt;/prop&gt;</span>
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">&quot;PostgreSQL&quot;</span><span class="nt">&gt;</span>postgresql<span class="nt">&lt;/prop&gt;</span>
            <span class="nt">&lt;/props&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sqlSessionFactory&quot;</span>
        <span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;databaseIdProvider&quot;</span> <span class="na">ref=</span><span class="s">&quot;databaseIdProvider&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configLocation&quot;</span>
            <span class="na">value=</span><span class="s">&quot;classpath:/META-INF/mybatis/mybatis-config.xml&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;mybatis:scan</span> <span class="na">base-package=</span><span class="s">&quot;com.example.domain.repository&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">MyBatis3から提供されている<tt class="docutils literal"><span class="pre">VendorDatabaseIdProvider</span></tt>をBean定義する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">VendorDatabaseIdProvider</span></tt>は、
JDBCドライバから取得したデータベースのプロダクト名(<tt class="docutils literal"><span class="pre">java.sql.DatabaseMetaData#getDatabaseProductName()</span></tt>)をデータベースIDとして扱うためのクラスである。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">properties</span></tt>プロパティには、JDBCドライバから取得したデータベースのプロダクト名とデータベースIDのマッピングを指定する。</p>
<p class="last">マッピング仕様ついては、「<a class="reference external" href="http://mybatis.github.io/mybatis-3/configuration.html#databaseIdProvider">MyBatis3 REFERENCE DOCUMENTATION(Configuration-databaseIdProvider-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">データベースIDを使用する<tt class="docutils literal"><span class="pre">SqlSessionFactoryBean</span></tt>の<tt class="docutils literal"><span class="pre">databaseIdProvider</span></tt>プロパティ対して、
(1)で定義した<tt class="docutils literal"><span class="pre">DatabaseIdProvider</span></tt>を指定する。</p>
<p class="last">この指定を行うと、マッッピングファイルからデータベースIDを参照する事が可能となる。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>本ガイドラインでは、<tt class="docutils literal"><span class="pre">properties</span></tt>プロパティを指定して、
データベースのプロダクト名とデータベースIDをマッピングする方式を推奨する。</p>
<p class="last">理由は、JDBCドライバから取得したデータベースのプロダクト名は、
JDBCのバージョンによって変わる可能性があるためである。
<tt class="docutils literal"><span class="pre">properties</span></tt>プロパティを使用すると、使用するバージョン毎のプロダクト名の違いを、
一箇所で管理する事ができる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>マッピングファイルの実装を行う。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&quot;create&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;selectKey</span> <span class="na">keyProperty=</span><span class="s">&quot;todoId&quot;</span> <span class="na">resultType=</span><span class="s">&quot;string&quot;</span> <span class="na">order=</span><span class="s">&quot;BEFORE&quot;</span>
               <span class="na">databaseId=</span><span class="s">&quot;h2&quot;</span><span class="nt">&gt;</span>
        SELECT RANDOM_UUID()
    <span class="nt">&lt;/selectKey&gt;</span>
    <span class="nt">&lt;selectKey</span> <span class="na">keyProperty=</span><span class="s">&quot;todoId&quot;</span> <span class="na">resultType=</span><span class="s">&quot;string&quot;</span> <span class="na">order=</span><span class="s">&quot;BEFORE&quot;</span>
               <span class="na">databaseId=</span><span class="s">&quot;postgresql&quot;</span><span class="nt">&gt;</span>
        SELECT UUID_GENERATE_V4()
    <span class="nt">&lt;/selectKey&gt;</span>

    INSERT INTO
      t_todo
    (
        todo_id
        ,todo_title
        ,finished
        ,created_at
        ,version
    )
    VALUES
    (
        #{todoId}
        ,#{todoTitle}
        ,#{finished}
        ,#{createdAt}
        ,#{version}
    )
<span class="nt">&lt;/insert&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">ステートメント要素(<tt class="docutils literal"><span class="pre">select</span></tt>要素、<tt class="docutils literal"><span class="pre">update</span></tt>要素、<tt class="docutils literal"><span class="pre">sql</span></tt>要素など)をデータベース毎に切り替えたい場合は、
各要素の<tt class="docutils literal"><span class="pre">databaseId</span></tt>属性にデータベースIDを指定する。</p>
<p><tt class="docutils literal"><span class="pre">databaseId</span></tt>属性を指定すると、データベースIDが一致するステートメント要素が使用される。</p>
<p class="last">上記例では、データベース固有のUUID生成関数を呼び出して、IDを生成している。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>上記例では、PostgreSQLのUUID生成関数として<tt class="docutils literal"><span class="pre">UUID_GENERATE_V4()</span></tt>を呼び出しているが、
この関数は、<a class="reference external" href="http://www.postgresql.org/docs/9.3/static/uuid-ossp.html">uuid-ossp</a>と呼ばれるサブモジュールの関数である。</p>
<p class="last">この関数を使用したい場合は、uuid-osspモジュールを有効にする必要がある。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>データベースIDは、OGNLベースの式（Expression言語）内でも参照する事ができる。</p>
<p>これは、データベースIDを動的SQLの条件として使用できる事を意味している。
以下に実装例を紹介する。</p>
<blockquote class="last">
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllByCreatedAtBefore&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;_int&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Todo&quot;</span><span class="nt">&gt;</span>
    SELECT
        todo_id,
        todo_title,
        finished,
        created_at,
        version
    FROM
        t_todo
    WHERE
        <span class="nt">&lt;choose&gt;</span>
            <span class="c">&lt;!-- (2) --&gt;</span>
            <span class="nt">&lt;when</span> <span class="na">test=</span><span class="s">&quot;_databaseId == &#39;h2&#39;&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;criteriaDate&quot;</span>
                      <span class="na">value=</span><span class="s">&quot;&#39;DATEADD(\&#39;DAY\&#39;,#{days} * -1,#{currentDate})&#39;&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/when&gt;</span>
            <span class="nt">&lt;when</span> <span class="na">test=</span><span class="s">&quot;_databaseId == &#39;postgresql&#39;&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;criteriaDate&quot;</span>
                      <span class="na">value=</span><span class="s">&quot;&#39;#{currentDate}::DATE - (#{days} * INTERVAL \&#39;1 DAY\&#39;)&#39;&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/when&gt;</span>
        <span class="nt">&lt;/choose&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">            created_at &lt; ${criteriaDate}</span>
<span class="cp">        ]]&gt;</span>
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">OGNLベースの式（Expression言語）内では、
<tt class="docutils literal"><span class="pre">_databaseId</span></tt>という特別な変数にデータベースIDが格納されている。</p>
<p class="last">上記例では、「システム日付 - 指定日」より前に作成されたレコードを抽出するための条件を、
データベースの関数を利用して指定している。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="entity1sql">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatonce"></span><h3><a class="toc-backref" href="#id142">5.2.4.4. 関連Entityを１回のSQLで取得する方法について</a><a class="headerlink" href="#entity1sql" title="Permalink to this headline">¶</a></h3>
<p>主Entityと関連Entityを1回のSQLでまとめて取得する方法について説明する。</p>
<p>主Entityと関連Entityをまとめて取得する仕組みを使用すると、
ServiceクラスでEntity(JavaBean)の組み立て処理を行う必要がなくなり、
Serviceクラスは業務ロジック(ビジネスルール)の実装に集中する事ができる。</p>
<div class="line-block">
<div class="line">また、この方法は、N+1問題を回避する手段としても使用される。</div>
<div class="line">N+1問題については、「<a class="reference internal" href="DataAccessCommon.html#data-access-common-howtosolve-n-plus-1"><em>N+1問題の対策方法</em></a>」を参照されたい。</div>
</div>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>主Entityと関連Entityをまとめて取得する場合は、以下の点に注意して使用すること。</p>
<ul class="simple">
<li>以下の説明では全ての関連Entityを1回のSQLでまとめて取得しているが、
実際のプロジェクトで使用する場合は、
処理で必要となる関連Entityのみ取得するようにした方がよいケースがある。
使用しない関連Entityを同時に取得すると、
無駄なオブジェクト生成やマッピング処理が行われるため性能劣化の要因となる事がある。
<strong>特に、一覧検索を行うSQLでは、必要な関連Entityのみ取得するようにした方がよいケースが多い。</strong></li>
</ul>
<p></p>
<ul class="simple">
<li>使用頻度の低い関連Entityについては、
まとめて取得せず必要なときに個別に取得する方法を採用した方がよいケースがある。
使用頻度の低い関連Entityを同時に取得すると、
無駄なオブジェクト生成やマッピング処理が行われるため性能劣化の要因となる事がある。</li>
</ul>
<p></p>
<ul class="last simple">
<li>1:Nの関係となる関連Entityが複数含まれる場合、
主Entityと関連Entityを別々に取得する方法を採用した方がよいケースがある。
1:Nの関係となる関連Entityが複数ある場合、
無駄なデータをDBから取得する必要があるため、性能劣化の要因となる事がある。
主Entityと関連Entityを別々に取得する方法の一例については、
「<a class="reference internal" href="DataAccessCommon.html#data-access-common-howtosolve-n-plus-1"><em>N+1問題の対策方法</em></a>」を参照されたい。</li>
</ul>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>使用頻度の低い関連Entityを必要になった時に個別に取得する方法としては、</p>
<ul class="simple">
<li>Serviceクラスの処理で関連Entityを取得するメソッド(SQL)を呼び出して取得する。</li>
<li>関連Entityを&#8221;Lazy Load&#8221;対象にし、Getterメソッドが呼び出された際にSQLを透過的に実行して取得する。</li>
</ul>
<p>方法がある。</p>
<p>&#8220;Lazy Load&#8221;の仕組みを使用すると、
ServiceクラスでEntity(JavaBean)の組み立て処理を行う必要がなくなり、
Serviceクラスは業務ロジック(ビジネスルール)の実装に集中する事ができる。</p>
<p><strong>一覧検索を行うSQLで&#8221;Lazy Load&#8221;を使用するとN+1問題を引き起こすので、使用する際は注意すること。</strong></p>
<p class="last">&#8220;Lazy Load&#8221;の使用方法については、「<a class="reference internal" href="#dataaccessmybatis3appendixnestedselectlazysetting"><em>関連EntityをLazy Loadするための設定</em></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>ここからは、ショッピングサイトで扱う注文データを、
1回のSQLでまとめて取得し、主Entity及び関連Entityにマッピングする実装例について説明を行う。</p>
<p>ここで説明する実装方法は、あくまで一例である。
MyBatis3では、本節で説明していない機能も多く提供しており、より高度なマッピングを行う事も可能である。</p>
<p>MyBatis3のマッピング機能の詳細については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#Result_Maps">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-Result Maps-)</a> 」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3appendixacquirerelatedobjectsatoncetable">
<span id="id63"></span><h4><a class="toc-backref" href="#id143">5.2.4.4.1. テーブルレイアウトとデータ</a><a class="headerlink" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncetable" title="Permalink to this headline">¶</a></h4>
<p>説明で使用するテーブルは、以下の通り。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/service_entity_table_layout.png"><img alt="ER diagram" src="../_images/service_entity_table_layout.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ER diagram</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="17%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">カテゴリ</th>
<th class="head">テーブル名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>トランザクション系</td>
<td>t_order</td>
<td><p class="first">注文データを保持するテーブル。</p>
<p class="last">１つの注文に対して、1レコードが格納される。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>&nbsp;</td>
<td>t_order_item</td>
<td><p class="first">１つの注文で購入された商品データを保持するテーブル。</p>
<p class="last">1つの注文で複数の商品が購入された場合は、商品数分レコードが格納される。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>&nbsp;</td>
<td>t_order_coupon</td>
<td><p class="first">１つの注文で使用されたクーポンのデータを保持するテーブル。</p>
<p class="last">1つの注文で、複数のクーポンが使用された場合は、クーポン数分レコードが格納される。
クーポンを使用しなかった場合は、レコードは格納されない。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>マスタ系</td>
<td>m_item</td>
<td>商品を定義するマスタテーブル。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>&nbsp;</td>
<td>m_category</td>
<td>商品のカテゴリを定義するマスタテーブル。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>&nbsp;</td>
<td>m_item_category</td>
<td><p class="first">商品が所属するカテゴリを定義するマスタテーブル。</p>
<p class="last">商品とカテゴリのマッピングを保持している。
1つの商品は、複数のカテゴリに属すことができるモデルとなっている。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>&nbsp;</td>
<td>m_coupon</td>
<td>クーポンを定義するマスタテーブル。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td>コード系</td>
<td>c_order_status</td>
<td>注文ステータスを定義するコードテーブル。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>説明で使用するテーブルレイアウトと格納データを作成するためのSQL(DDLとDML)を以下に示す。
(SQLはH2 Database用である)</p>
<ul class="simple">
<li>マスタ系テーブル作成用のDDL</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">m_item</span> <span class="p">(</span>
    <span class="n">code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">name</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
    <span class="n">price</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">m_item_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">m_category</span> <span class="p">(</span>
    <span class="n">code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">name</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">m_category_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">m_item_category</span> <span class="p">(</span>
    <span class="n">item_code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">category_code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">m_item_category_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">item_code</span><span class="p">,</span> <span class="n">category_code</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">m_item_category_fk1</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">item_code</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">m_item</span><span class="p">(</span><span class="n">code</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">m_item_category_fk2</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">category_code</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">m_category</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">m_coupon</span> <span class="p">(</span>
    <span class="n">code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">name</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
    <span class="n">price</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">m_coupon_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>コード系テーブル作成用のDDL</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">c_order_status</span> <span class="p">(</span>
    <span class="n">code</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">name</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">c_order_status_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>トランザクション系テーブル作成用のDDL</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t_order</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">status_code</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_fk</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">c_order_status</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t_order_item</span> <span class="p">(</span>
    <span class="n">order_id</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">item_code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="n">quantity</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_item_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">item_code</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_item_fk1</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">t_order</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_item_fk2</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">item_code</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">m_item</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">t_order_coupon</span> <span class="p">(</span>
    <span class="n">order_id</span> <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">coupon_code</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_coupon_pk</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">order_id</span><span class="p">,</span> <span class="n">coupon_code</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_coupon_fk1</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">t_order</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="k">CONSTRAINT</span> <span class="n">t_order_coupon_fk2</span> <span class="k">FOREIGN</span> <span class="k">KEY</span><span class="p">(</span><span class="n">coupon_code</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">m_coupon</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>データ投入用のDML</li>
</ul>
<blockquote>
<div><div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- Setup master tables</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_item</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;ITM0000001&#39;</span><span class="p">,</span><span class="s1">&#39;Orange juice&#39;</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_item</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;ITM0000002&#39;</span><span class="p">,</span><span class="s1">&#39;NotePC&#39;</span><span class="p">,</span><span class="mi">100000</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_category</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;CTG0000001&#39;</span><span class="p">,</span><span class="s1">&#39;Drink&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_category</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;CTG0000002&#39;</span><span class="p">,</span><span class="s1">&#39;PC&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_category</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;CTG0000003&#39;</span><span class="p">,</span><span class="s1">&#39;Hot selling&#39;</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_item_category</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;ITM0000001&#39;</span><span class="p">,</span><span class="s1">&#39;CTG0000001&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_item_category</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;ITM0000002&#39;</span><span class="p">,</span><span class="s1">&#39;CTG0000002&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_item_category</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;ITM0000002&#39;</span><span class="p">,</span><span class="s1">&#39;CTG0000003&#39;</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_coupon</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;CPN0000001&#39;</span><span class="p">,</span><span class="s1">&#39;Join coupon&#39;</span><span class="p">,</span><span class="mi">3000</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">m_coupon</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;CPN0000002&#39;</span><span class="p">,</span><span class="s1">&#39;PC coupon&#39;</span><span class="p">,</span><span class="mi">30000</span><span class="p">);</span>

<span class="c1">-- Setup code tables</span>
<span class="k">INSERT</span>  <span class="k">INTO</span>  <span class="n">c_order_status</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span><span class="s1">&#39;Order accepted&#39;</span><span class="p">);</span>
<span class="k">INSERT</span>  <span class="k">INTO</span>  <span class="n">c_order_status</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;checking&#39;</span><span class="p">,</span><span class="s1">&#39;Stock checking&#39;</span><span class="p">);</span>
<span class="k">INSERT</span>  <span class="k">INTO</span>  <span class="n">c_order_status</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;shipped&#39;</span><span class="p">,</span><span class="s1">&#39;Item Shipped&#39;</span><span class="p">);</span>

<span class="c1">-- Setup transaction tables</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;accepted&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;checking&#39;</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order_item</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;ITM0000001&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order_item</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;ITM0000002&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order_item</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;ITM0000001&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order_item</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;ITM0000002&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order_coupon</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;CPN0000001&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">t_order_coupon</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;CPN0000002&#39;</span><span class="p">);</span>

<span class="k">COMMIT</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixacquirerelatedobjectsatonceentity">
<span id="id64"></span><h4><a class="toc-backref" href="#id144">5.2.4.4.2. Entityのクラス図</a><a class="headerlink" href="#dataaccessmybatis3appendixacquirerelatedobjectsatonceentity" title="Permalink to this headline">¶</a></h4>
<p>実装例では、上記テーブルに格納されているレコードを、以下のEntity(JavaBean)にマッピングする。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_entity.png"><img alt="Class(JavaBean) diagram" src="../_images/dataaccess_entity.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - Class(JavaBean) diagram</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="17%" />
<col width="72%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">クラス名</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>Order</td>
<td><p class="first">t_orderテーブルの1レコードを表現するJavaBean。</p>
<p>関連Entityとして、<tt class="docutils literal"><span class="pre">OrderStatus</span></tt>を1件、<tt class="docutils literal"><span class="pre">OrderItem</span></tt>および<tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>を複数保持する。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">OrderStatus</span> <span class="n">orderStatus</span><span class="o">;</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span> <span class="n">orderItems</span><span class="o">;</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">OrderCoupon</span><span class="o">&gt;</span> <span class="n">orderCoupons</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>OrderItem</td>
<td><p class="first">t_order_itemテーブルの1レコードを表現するJavaBean。</p>
<p>関連Entityとして、<tt class="docutils literal"><span class="pre">Item</span></tt>を保持する。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderItem</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">orderId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Item</span> <span class="n">item</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">quantity</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>OrderCoupon</td>
<td><p class="first">t_order_couponテーブルの1コードを表現するJavaBean。</p>
<p>関連Entityとして、<tt class="docutils literal"><span class="pre">Coupon</span></tt>を保持する。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderCoupon</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">orderId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Coupon</span> <span class="n">coupon</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>Item</td>
<td><p class="first">m_itemテーブルの1コードを表現するJavaBean。</p>
<p>関連オブジェクトとして、所属している<tt class="docutils literal"><span class="pre">Category</span></tt>を複数保持する。
<tt class="docutils literal"><span class="pre">Category</span></tt>との紐づけは、m_item_categoryテーブルによって行われる。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">categories</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>Category</td>
<td><p class="first">m_categoryテーブルの1レコードを表現するJavaBean。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Category</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>Coupon</td>
<td><p class="first">m_couponテーブルの1レコードを表現するJavaBean。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Coupon</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>OrderStatus</td>
<td><p class="first">c_order_statusテーブルの1レコードを表現するJavaBean。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderStatus</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixacquirerelatedobjectsatoncerepository">
<span id="id65"></span><h4><a class="toc-backref" href="#id145">5.2.4.4.3. Repositoryインタフェースの実装</a><a class="headerlink" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncerepository" title="Permalink to this headline">¶</a></h4>
<p>実装例では、</p>
<ul class="simple">
<li>Orderオブジェクトを1件取得するメソッド(<tt class="docutils literal"><span class="pre">findOne</span></tt>)</li>
<li>該当ページのOrderオブジェクトを取得するメソッド(<tt class="docutils literal"><span class="pre">findPage</span></tt>)</li>
</ul>
<p>を実装する。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">order</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.domain.model.Order</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderRepository</span> <span class="o">{</span>

    <span class="n">Order</span> <span class="nf">findOne</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">findPage</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;pageable&quot;</span><span class="o">)</span> <span class="n">Pageable</span> <span class="n">pageable</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixacquirerelatedobjectsatoncesql">
<span id="id66"></span><h4><a class="toc-backref" href="#id146">5.2.4.4.4. SQLの実装</a><a class="headerlink" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncesql" title="Permalink to this headline">¶</a></h4>
<p>関連Entityを1回のSQLでまとめて取得する場合は、
取得対象のテーブルをJOINしてマッピングに必要な全てのレコードを取得する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.order.OrderRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sql</span> <span class="na">id=</span><span class="s">&quot;selectFromJoin&quot;</span><span class="nt">&gt;</span>
        SELECT
            /* (2) */
            o.id,
            /* (3) */
            o.status_code,
            os.name AS status_name,
            /* (4) */
            oi.quantity,
            i.code AS item_code,
            i.name AS item_name,
            i.price AS item_price,
            /* (5) */
            ct.code AS category_code,
            ct.name AS category_name,
            /* (6) */
            cp.code AS coupon_code,
            cp.name AS coupon_name,
            cp.price AS coupon_price
        FROM
            ${orderTable} o
        /* (7) */
        INNER JOIN c_order_status os ON os.code = o.status_code
        INNER JOIN t_order_item oi ON oi.order_id = o.id
        INNER JOIN m_item i ON i.code = oi.item_code
        INNER JOIN m_item_category ic ON ic.item_code = i.code
        INNER JOIN m_category ct ON ct.code = ic.category_code
        /* (8) */
        LEFT JOIN t_order_coupon oc ON oc.order_id = o.id
        LEFT JOIN m_coupon cp ON cp.code = oc.coupon_code
    <span class="nt">&lt;/sql&gt;</span>

    <span class="c">&lt;!-- (9) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findOne&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;_int&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;orderResultMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;orderTable&quot;</span> <span class="na">value=</span><span class="s">&quot;&#39;t_order&#39;&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;selectFromJoin&quot;</span><span class="nt">/&gt;</span>
        WHERE
            o.id = #{id}
        ORDER BY
            item_code ASC,
            category_code ASC,
            coupon_code ASC
    <span class="nt">&lt;/select&gt;</span>

    <span class="c">&lt;!-- (10) --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPage&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;orderResultMap&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bind</span> <span class="na">name=</span><span class="s">&quot;orderTable&quot;</span> <span class="na">value=</span><span class="s">&quot;</span>
<span class="s">            &#39;(</span>
<span class="s">              SELECT</span>
<span class="s">                  *</span>
<span class="s">              FROM</span>
<span class="s">                  t_order</span>
<span class="s">              ORDER BY</span>
<span class="s">                  id DESC</span>
<span class="s">              LIMIT #{pageable.pageSize}</span>
<span class="s">              OFFSET #{pageable.offset}</span>
<span class="s">              )&#39;&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;include</span> <span class="na">refid=</span><span class="s">&quot;selectFromJoin&quot;</span><span class="nt">/&gt;</span>
        ORDER BY
            id DESC,
            item_code ASC,
            category_code ASC,
            coupon_code ASC
    <span class="nt">&lt;/select&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">findOne</span></tt>メソッドと<tt class="docutils literal"><span class="pre">findPage</span></tt>メソッド用のSELECT句、FROM句、JOIN句を実装する。</p>
<p class="last">上記例では、<tt class="docutils literal"><span class="pre">findOne</span></tt>メソッドと<tt class="docutils literal"><span class="pre">findPage</span></tt>メソッドの共通箇所を共通化している。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>Orderオブジェクトを生成するために必要なデータを取得する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">OrderStatusオブジェクトを生成するために必要なデータを取得する。</p>
<p class="last">取得するカラム名は重複しないようにする必要がある。
上記例では、<tt class="docutils literal"><span class="pre">name</span></tt>カラムが重複するため、
AS句を使用して別名(<tt class="docutils literal"><span class="pre">status_</span></tt>プレフィックス)を指定している。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td><p class="first">OrderItemオブジェクトとItemオブジェクトを生成するために必要なデータを取得する。</p>
<p class="last">取得するカラム名は重複しないようにする必要がある。
上記例では、<tt class="docutils literal"><span class="pre">code</span></tt>,<tt class="docutils literal"><span class="pre">name</span></tt>, <tt class="docutils literal"><span class="pre">price</span></tt>が重複するため、
AS句を使用して別名(<tt class="docutils literal"><span class="pre">item_</span></tt>プレフィックス)を指定している。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p class="first">Categoryオブジェクトを生成するために必要なデータを取得する。</p>
<p class="last">取得するカラム名は重複しないようにする必要がある。
上記例では、<tt class="docutils literal"><span class="pre">code</span></tt>,<tt class="docutils literal"><span class="pre">name</span></tt>が重複するため、
AS句を使用して別名(<tt class="docutils literal"><span class="pre">category_</span></tt>プレフィックス)を指定している。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td><p class="first">OrderCouponオブジェクトとCouponオブジェクトを生成するために必要なデータを取得する。</p>
<p class="last">取得するカラム名は重複しないようにする必要がある。
上記例では、<tt class="docutils literal"><span class="pre">code</span></tt>,<tt class="docutils literal"><span class="pre">name</span></tt>, <tt class="docutils literal"><span class="pre">price</span></tt>が重複するため、
AS句を使用して別名(<tt class="docutils literal"><span class="pre">coupon_</span></tt>プレフィックス)を指定している。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>関連オブジェクトを生成するために必要なデータが格納されているテーブルを結合する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="8">
<li></li>
</ol>
</td>
<td>レコードが格納されない可能性のあるテーブルについては、外部結合とする。
クーポンを使用しない場合、t_order_couponにレコードが格納されないので外部結合にする必要がある。
t_order_couponと結合するt_couponも同様である。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="9">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">findOne</span></tt>メソッド用のSQLを実装する。</p>
<p class="last">ORDER BY句には、1:Nの関連をもつEntityの並び順を指定する。
上記例では、PKの昇順で並べ替えている。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="10">
<li></li>
</ol>
</td>
<td><tt class="docutils literal"><span class="pre">findPage</span></tt>メソッド用のSQLを実装する。
ORDER BY句には、Orderと1:Nの関連をもつEntityの並び順を指定する。
上記例では、OrderはPKの降順(新しい順)、関連EntityはPKの昇順で並べ替えている。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>1:Nの関連を持つ関連Entityを1回のSQLでまとめて取得する際にページネーション検索が必要な場合は、
MyBatis3から提供されている<tt class="docutils literal"><span class="pre">RowBounds</span></tt>を使用することが出来ない。</p>
<p>代替案としては、</p>
<ul class="simple">
<li>まず主Entityのみを検索するメソッドを呼び出し、関連Entityは別途のメソッドを呼び出して取得する</li>
<li>SQLでページ範囲内の主Entityのみ格納されている仮想テーブルを作成し、仮想テーブルのレコードとJOINする事で、
マッピングに必要な全てのレコードを取得する(上記例の <tt class="docutils literal"><span class="pre">findPage</span></tt>は、このパターンで実装している)</li>
</ul>
<p class="last">等の方法が考えられる。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>上記SQL(findPage)を実行すると以下のレコードが取得される。
注文レコードとしては2件だが、レコードが複数件格納される関連テーブルと結合しているため、
合計で9レコードが取得される。</p>
<p>内訳は、</p>
<ul class="simple">
<li>1～3行目は、注文IDが<tt class="docutils literal"><span class="pre">2</span></tt>の<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトを生成するためのレコード</li>
<li>4～9行目は、注文IDが<tt class="docutils literal"><span class="pre">1</span></tt>の<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトを生成するためレコード</li>
</ul>
<p>となる。</p>
<p>以降の説明では、注文IDが<tt class="docutils literal"><span class="pre">1</span></tt>のレコードを例に、
どのように検索結果(<tt class="docutils literal"><span class="pre">ResultSet</span></tt>)をJavaBeanにマッピングするかを説明していく。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_sql_result.png"><img alt="Result Set of findPage" src="../_images/dataaccess_sql_result.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - Result Set of findPage</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemapping">
<span id="id67"></span><h4><a class="toc-backref" href="#id147">5.2.4.4.5. マッピングの実装</a><a class="headerlink" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncemapping" title="Permalink to this headline">¶</a></h4>
<p>上記レコードを、<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトと関連Entityにマッピングするための定義を以下に示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; &gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.domain.repository.order.OrderRepository&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- ... --&gt;</span>

    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Order&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;item.code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;itemResultMap&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/collection&gt;</span>
        <span class="c">&lt;!-- (4) --&gt;</span>
        <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderCoupon&quot;</span>
                    <span class="na">notNullColumn=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
            <span class="c">&lt;!-- (5) --&gt;</span>
            <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;coupon.code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/collection&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Item&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- (7) --&gt;</span>
        <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">ofType=</span><span class="s">&quot;Category&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;category_code&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;category_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/collection&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;/mapper&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>取得したレコードを<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトにマッピングするための定義。
関連Entity(<tt class="docutils literal"><span class="pre">OrderStatus</span></tt>, <tt class="docutils literal"><span class="pre">OrderItem</span></tt>,<tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>)のマッピングを行う。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>取得したレコードを<tt class="docutils literal"><span class="pre">OrderStatus</span></tt>オブジェクトにマッピングするための定義。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>取得したレコードを<tt class="docutils literal"><span class="pre">OrderItem</span></tt>オブジェクトにマッピングするための定義。
関連Entity(<tt class="docutils literal"><span class="pre">Item</span></tt>)へのマッピングは、別の<tt class="docutils literal"><span class="pre">resultMap</span></tt>(6)に委譲している。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>取得したレコードを<tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>オブジェクトにマッピングするための定義。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td>取得したレコードを<tt class="docutils literal"><span class="pre">Coupon</span></tt>オブジェクトにマッピングするための定義。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="6">
<li></li>
</ol>
</td>
<td>取得したレコードを<tt class="docutils literal"><span class="pre">Item</span></tt>オブジェクトにマッピングするための定義。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="7">
<li></li>
</ol>
</td>
<td>取得したレコードを<tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクトにマッピングするための定義。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="order">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingorder"></span><h5>5.2.4.4.5.1. Orderオブジェクトへのマッピングの実装<a class="headerlink" href="#order" title="Permalink to this headline">¶</a></h5>
<p><tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="hll"><span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Order&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">    <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;item.code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;itemResultMap&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderCoupon&quot;</span>
                <span class="na">notNullColumn=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;coupon.code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_order.png"><img alt="ResultMap for Order" src="../_images/dataaccess_resultmap_order.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for Order</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">検索結果を<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトにマッピングする。</p>
<p class="last"><tt class="docutils literal"><span class="pre">type</span></tt>属性にマッピングするクラスを指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<tt class="docutils literal"><span class="pre">id</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Order#id</span></tt>プロパティに設定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">id</span></tt>カラムはPKなので、<tt class="docutils literal"><span class="pre">id</span></tt>要素を使用してマッピングを行う。
<tt class="docutils literal"><span class="pre">id</span></tt>要素を使用すると、指定したプロパティの値でレコードがグループ化される。
具体的には、<tt class="docutils literal"><span class="pre">id=1</span></tt>と<tt class="docutils literal"><span class="pre">id=2</span></tt>の2つにグループ化され、
2つの<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトが生成される。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="orderstatus">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingorderstatus"></span><h5>5.2.4.4.5.2. OrderStatusオブジェクトへのマッピングの実装<a class="headerlink" href="#orderstatus" title="Permalink to this headline">¶</a></h5>
<p><tt class="docutils literal"><span class="pre">OrderStatus</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>「<a class="reference internal" href="../ImplementationAtEachLayer/DomainLayer.html#domainlayer-entity"><em>Entityの実装</em></a>」のEntityクラスの作成方針では、
「コード系テーブルは、Entityとして扱うのではなく、java.lang.Stringなどの基本型で扱う。」としている。
これは、コード系テーブルで保持しているデータは、
「<a class="reference internal" href="Codelist.html"><em>コードリスト</em></a>」などの別の仕組みを使用するケースが多いためである。</p>
<p>本節では、関連Entity(JavaBean)へのマッピング方法を説明する事が目的なので、
コード系テーブルもEntityとして扱っている点を補足しておく。</p>
<p class="last">実際のプロジェクトでは、Entityクラスの作成方針を参考にEntityを作成することを推奨する。</p>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Order&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
</span><span class="hll">    <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;item.code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;itemResultMap&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderCoupon&quot;</span>
                <span class="na">notNullColumn=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;coupon.code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_orderstatus.png"><img alt="ResultMap for OrderStatus" src="../_images/dataaccess_resultmap_orderstatus.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for OrderStatus</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>取得したレコードの<tt class="docutils literal"><span class="pre">status_code</span></tt>カラムの値を、
<tt class="docutils literal"><span class="pre">OrderStatus#code</span></tt>プロパティに設定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>取得したレコードの<tt class="docutils literal"><span class="pre">status_name</span></tt>カラムの値を、
<tt class="docutils literal"><span class="pre">OrderStatus#name</span></tt>プロパティに設定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">OrderStatus</span></tt>オブジェクトには、<tt class="docutils literal"><span class="pre">id</span></tt>カラムでグループ化されたレコードの値が設定される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="orderitem">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingorderitem"></span><h5>5.2.4.4.5.3. OrderItemオブジェクトへのマッピングの実装<a class="headerlink" href="#orderitem" title="Permalink to this headline">¶</a></h5>
<p><tt class="docutils literal"><span class="pre">OrderItem</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Order&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;item.code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (5) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;itemResultMap&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/collection&gt;</span>
</span>    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderCoupon&quot;</span>
                <span class="na">notNullColumn=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;coupon.code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_orderitem.png"><img alt="ResultMap for OrderItem" src="../_images/dataaccess_resultmap_orderitem.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for OrderItem</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">検索結果を<tt class="docutils literal"><span class="pre">OrderItem</span></tt>オブジェクトにマッピングし、
<tt class="docutils literal"><span class="pre">Order#orderItems</span></tt>プロパティに追加する。</p>
<p class="last">1:Nの関係の関連Entityにマッピングする場合は、<tt class="docutils literal"><span class="pre">collection</span></tt>要素を使用する。
<tt class="docutils literal"><span class="pre">collection</span></tt>要素の詳細は、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#collection">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-collection-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<tt class="docutils literal"><span class="pre">id</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">OrderItem#orderId</span></tt>プロパティに設定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">id</span></tt>カラムはPKなので、<tt class="docutils literal"><span class="pre">id</span></tt>要素を使用してマッピングを行う。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<tt class="docutils literal"><span class="pre">item_code</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Item#code</span></tt>プロパティに設定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">item_code</span></tt>カラムはPKなので、<tt class="docutils literal"><span class="pre">id</span></tt>要素を使用してマッピングを行う。
<tt class="docutils literal"><span class="pre">id</span></tt>要素を使用すると、指定したプロパティの値でレコードがグループ化される。
具体的には、<tt class="docutils literal"><span class="pre">Item#code=ITM0000001</span></tt>と<tt class="docutils literal"><span class="pre">Item#code=ITM0000002</span></tt>の2つにグループ化され、
2つの<tt class="docutils literal"><span class="pre">OrderItem</span></tt>オブジェクトが生成される。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>取得したレコードの<tt class="docutils literal"><span class="pre">quantity</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">OrderItem#quantity</span></tt>プロパティに設定する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="5">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">Item</span></tt>オブジェクトの生成を、別の<tt class="docutils literal"><span class="pre">resultMap</span></tt>に委譲し、
生成されたオブジェクトを<tt class="docutils literal"><span class="pre">OrderItem#item</span></tt>プロパティに設定する。
実際のマッピングは、
「<a class="reference internal" href="#dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingitem"><em>Itemオブジェクトへのマッピングの実装</em></a>」を参照されたい。</p>
<p class="last">1:1の関係の関連Entityにマッピングする場合は、<tt class="docutils literal"><span class="pre">association</span></tt>要素を使用する。
<tt class="docutils literal"><span class="pre">association</span></tt>要素の詳細は、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#association">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-association-)</a>」を参照されたい。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">OrderItem</span></tt>オブジェクトには、
<tt class="docutils literal"><span class="pre">id</span></tt>カラムと<tt class="docutils literal"><span class="pre">item_code</span></tt>カラムでグループ化されたレコードの値が設定される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="item">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingitem"></span><h5>5.2.4.4.5.4. Itemオブジェクトへのマッピングの実装<a class="headerlink" href="#item" title="Permalink to this headline">¶</a></h5>
<p><tt class="docutils literal"><span class="pre">Item</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="hll"><span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll"><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Item&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">    <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">    <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">    <span class="c">&lt;!-- (4) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">ofType=</span><span class="s">&quot;Category&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;category_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;category_name&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_item.png"><img alt="ResultMap for Item" src="../_images/dataaccess_resultmap_item.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for Item</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">検索結果を<tt class="docutils literal"><span class="pre">Item</span></tt>オブジェクトにマッピングする。</p>
<p class="last"><tt class="docutils literal"><span class="pre">type</span></tt>属性にマッピングするクラスを指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<tt class="docutils literal"><span class="pre">item_code</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Item#code</span></tt>に設定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">item_code</span></tt>カラムはPKなので、<tt class="docutils literal"><span class="pre">id</span></tt>要素を使用してマッピングを行う。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>取得したレコードの<tt class="docutils literal"><span class="pre">item_name</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Item#name</span></tt>に設定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="4">
<li></li>
</ol>
</td>
<td>取得したレコードの<tt class="docutils literal"><span class="pre">item_price</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Item#price</span></tt>に設定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">Item</span></tt>オブジェクトには、
<tt class="docutils literal"><span class="pre">id</span></tt>カラムと<tt class="docutils literal"><span class="pre">item_code</span></tt>カラムでグループ化されたレコードの値が設定される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="category">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingcategory"></span><h5>5.2.4.4.5.5. Categoryオブジェクトへのマッピングの実装<a class="headerlink" href="#category" title="Permalink to this headline">¶</a></h5>
<p><tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Item&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="nt">/&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">ofType=</span><span class="s">&quot;Category&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;category_code&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;category_name&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">    <span class="nt">&lt;/collection&gt;</span>
</span><span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_category.png"><img alt="ResultMap for Category" src="../_images/dataaccess_resultmap_category.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for Category</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">検索結果を<tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクトにマッピングし、<tt class="docutils literal"><span class="pre">Item#categories</span></tt>プロパティに追加する。</p>
<p class="last">1:Nの関係の関連Entityにマッピングする場合は、<tt class="docutils literal"><span class="pre">collection</span></tt>要素を使用する。
<tt class="docutils literal"><span class="pre">collection</span></tt>要素の詳細は、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#collection">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-collection-)</a>」を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<tt class="docutils literal"><span class="pre">category_code</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Category#code</span></tt>に設定する。</p>
<p><tt class="docutils literal"><span class="pre">category_code</span></tt>カラムはPKなので、<tt class="docutils literal"><span class="pre">id</span></tt>要素を使用してマッピングを行う。
<tt class="docutils literal"><span class="pre">id</span></tt>要素を使用すると、指定したプロパティの値でレコードがグループ化される。</p>
<p>具体的には、</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">Item#code=ITM0000001</span></tt>のカテゴリとして、<tt class="docutils literal"><span class="pre">Category#code=CTG0000001</span></tt>の<tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクト</li>
<li><tt class="docutils literal"><span class="pre">Item#code=ITM0000002</span></tt>のカテゴリとして、<tt class="docutils literal"><span class="pre">Category#code=CTG0000002</span></tt>と<tt class="docutils literal"><span class="pre">Category#code=CTG0000003</span></tt>の2つの<tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクト</li>
</ul>
<p class="last">が生成される。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>取得したレコードの<tt class="docutils literal"><span class="pre">category_name</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Category#name</span></tt> に設定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">Category</span></tt>オブジェクトには、
<tt class="docutils literal"><span class="pre">id</span></tt>カラムと<tt class="docutils literal"><span class="pre">item_code</span></tt>カラムと<tt class="docutils literal"><span class="pre">category_code</span></tt>カラムでグループ化されたレコードの値が設定される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="ordercoupon">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingordercoupon"></span><h5>5.2.4.4.5.6. OrderCouponオブジェクトへのマッピングの実装<a class="headerlink" href="#ordercoupon" title="Permalink to this headline">¶</a></h5>
<p><tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Order&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;item.code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;itemResultMap&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderCoupon&quot;</span> <span class="na">notNullColumn=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;coupon.code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">/&gt;</span>
</span>        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_ordercoupon.png"><img alt="ResultMap for OrderCoupon" src="../_images/dataaccess_resultmap_ordercoupon.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for OrderCoupon</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">検索結果を<tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>オブジェクトにマッピングし、<tt class="docutils literal"><span class="pre">Order#orderCoupons</span></tt>プロパティに追加する。</p>
<p>1:Nの関係の関連Entityにマッピングする場合は、<tt class="docutils literal"><span class="pre">collection</span></tt>要素を使用する。
<tt class="docutils literal"><span class="pre">collection</span></tt>要素の詳細は、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#collection">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-collection-)</a>」を参照されたい。</p>
<p>上記例にて、<tt class="docutils literal"><span class="pre">notNullColumn</span></tt>属性を指定している点に注目してほしい。</p>
<p>これは<tt class="docutils literal"><span class="pre">t_coupon</span></tt>テーブルにレコードが存在しない時に、
<tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>オブジェクトを生成させないための設定である。
本実装例では、<tt class="docutils literal"><span class="pre">id</span></tt>カラムが<tt class="docutils literal"><span class="pre">2</span></tt>のデータには<tt class="docutils literal"><span class="pre">t_coupon</span></tt>テーブルのレコードを格納していないため、
検索結果をみると、<tt class="docutils literal"><span class="pre">coupon_code</span></tt>と<tt class="docutils literal"><span class="pre">coupon_name</span></tt>と<tt class="docutils literal"><span class="pre">coupon_price</span></tt>の値が<tt class="docutils literal"><span class="pre">null</span></tt>になっているのがわかる。</p>
<p><tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>オブジェクトにマッピングするカラムがこの3つだけであれば、
<tt class="docutils literal"><span class="pre">notNullColumn</span></tt>属性を指定する必要はないが、
実装例では<tt class="docutils literal"><span class="pre">id</span></tt>カラムの値を<tt class="docutils literal"><span class="pre">OrderCoupon#orderId</span></tt>プロパティにマッピングする設定を行っているため、
<tt class="docutils literal"><span class="pre">notNullColumn</span></tt>属性の指定が必要となる。
これは、マッピング対象のカラムの中に<tt class="docutils literal"><span class="pre">null</span></tt>でない値がセットされていた場合に、
MyBatisがオブジェクトを生成するためである。</p>
<p class="last">上記例のように、<tt class="docutils literal"><span class="pre">notNullColumn</span></tt>属性に<tt class="docutils literal"><span class="pre">coupon_code</span></tt>カラムを指定しておくと、
<tt class="docutils literal"><span class="pre">coupon_code</span></tt>カラムが<tt class="docutils literal"><span class="pre">null</span></tt>でない場合(つまり、レコードが存在する場合)にのみ、
オブジェクトが生成される。
<tt class="docutils literal"><span class="pre">notNullColumn</span></tt>属性には、複数のカラムを指定する事もできる。</p>
</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<tt class="docutils literal"><span class="pre">id</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">OrderCoupon#orderId</span></tt>プロパティに設定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">orderId</span></tt>はPKなので、<tt class="docutils literal"><span class="pre">id</span></tt>要素を使用する。</p>
</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td><p class="first">取得したレコードの<tt class="docutils literal"><span class="pre">coupon_code</span></tt>カラムの値を<tt class="docutils literal"><span class="pre">Coupon#code</span></tt>に設定する。</p>
<p><tt class="docutils literal"><span class="pre">coupon_code</span></tt>カラムはPKなので、<tt class="docutils literal"><span class="pre">id</span></tt>要素を使用してマッピングを行う。
<tt class="docutils literal"><span class="pre">id</span></tt>要素を使用すると、指定したプロパティの値でレコードがグループ化される。</p>
<p class="last">具体的には、<tt class="docutils literal"><span class="pre">Coupon#code=CPN0000001</span></tt>と<tt class="docutils literal"><span class="pre">Coupon#code=CPN0000002</span></tt>の2つにグループ化され、
2つの<tt class="docutils literal"><span class="pre">OrderCoupon</span></tt>オブジェクトが生成される。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="coupon">
<span id="dataaccessmybatis3appendixacquirerelatedobjectsatoncemappingcoupon"></span><h5>5.2.4.4.5.7. Couponオブジェクトへのマッピングの実装<a class="headerlink" href="#coupon" title="Permalink to this headline">¶</a></h5>
<p><tt class="docutils literal"><span class="pre">Coupon</span></tt>オブジェクトへのマッピングを行う。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;orderResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Order&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.code&quot;</span> <span class="na">column=</span><span class="s">&quot;status_code&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;orderStatus.name&quot;</span> <span class="na">column=</span><span class="s">&quot;status_name&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderItems&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderItem&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;item.code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;quantity&quot;</span> <span class="na">column=</span><span class="s">&quot;quantity&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">&quot;item&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;itemResultMap&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/collection&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;orderCoupons&quot;</span> <span class="na">ofType=</span><span class="s">&quot;OrderCoupon&quot;</span> <span class="na">notNullColumn=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;orderId&quot;</span> <span class="na">column=</span><span class="s">&quot;id&quot;</span><span class="nt">/&gt;</span>
<span class="hll">        <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;coupon.code&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_code&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (2) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.name&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_name&quot;</span><span class="nt">/&gt;</span>
</span><span class="hll">        <span class="c">&lt;!-- (3) --&gt;</span>
</span><span class="hll">        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;coupon.price&quot;</span> <span class="na">column=</span><span class="s">&quot;coupon_price&quot;</span><span class="nt">/&gt;</span>
</span>    <span class="nt">&lt;/collection&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_resultmap_coupon.png"><img alt="ResultMap for Coupon" src="../_images/dataaccess_resultmap_coupon.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - ResultMap for Coupon</strong></p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td>取得したレコードの<tt class="docutils literal"><span class="pre">coupon_code</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Coupon#code</span></tt>に設定する。</td>
</tr>
<tr class="row-odd"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td>取得したレコードの<tt class="docutils literal"><span class="pre">coupon_name</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Coupon#name</span></tt>に設定する。</td>
</tr>
<tr class="row-even"><td><ol class="first last arabic simple" start="3">
<li></li>
</ol>
</td>
<td>取得したレコードの<tt class="docutils literal"><span class="pre">coupon_price</span></tt>カラムの値を、<tt class="docutils literal"><span class="pre">Coupon#price</span></tt>に設定する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">Coupon</span></tt>オブジェクトには、
<tt class="docutils literal"><span class="pre">id</span></tt>カラムと<tt class="docutils literal"><span class="pre">coupon_code</span></tt>カラムでグループ化されたレコードの値が設定される。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="dataaccessmybatis3appendixacquirerelatedobjectsatonceobject">
<span id="id70"></span><h5>5.2.4.4.5.8. マッピング後のオブジェクト図<a class="headerlink" href="#dataaccessmybatis3appendixacquirerelatedobjectsatonceobject" title="Permalink to this headline">¶</a></h5>
<p>実際にマッピングされた<tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトおよび関連Entityの状態は、以下の通りである。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_object.png"><img alt="Mapped object diagram" src="../_images/dataaccess_object.png" style="width: 90%;" /></a>
<p class="caption"><strong>Picture - Mapped object diagram</strong></p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">Order</span></tt>オブジェクトにマッピングされたレコードとカラムは、以下の通りである。</div>
<div class="line">グレーアウトしている部分は、グループ化によって、グレーアウトされていない部分にマージされる。</div>
</div>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../_images/dataaccess_sql_result_used.png"><img alt="Valid Result Set" src="../_images/dataaccess_sql_result_used.png" style="width: 100%;" /></a>
<p class="caption"><strong>Picture - Valid Result Set</strong></p>
</div>
</div></blockquote>
<blockquote id="dataaccessmybatis3appendixacquirerelatedobjectswarningsqlmapping">
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>1:Nの関連をもつレコードをJOINしてマッピングする場合、グレーアウトされている部分のデータの取得が無駄になる点を、意識しておくこと。</p>
<p class="last">Nの部分のデータを使用しない処理で、同じSQLを使用した場合、さらに無駄なデータの取得となってしまうので、Nの部分を取得するSQLと、取得しないSQLを、別々に用意しておくなどの工夫を行うこと。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="entitysql">
<span id="dataaccessmybatis3appendixnestedselect"></span><h3><a class="toc-backref" href="#id148">5.2.4.5. 関連EntityをネストしたSQLを使用して取得する方法について</a><a class="headerlink" href="#entitysql" title="Permalink to this headline">¶</a></h3>
<p>MyBatis3では、マッピング時に別のSQL(ネストしたSQL)を使用して関連Entityを取得する方法を提供している。</p>
<p>ネストしたSQLを使用して関連Entityを取得する仕組みを使用すると、</p>
<ul class="simple">
<li>個々のSQL定義</li>
<li><tt class="docutils literal"><span class="pre">resultMap</span></tt>要素のマッピング定義</li>
</ul>
<p>をシンプルにする事ができる。</p>
<blockquote>
<div><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>各種定義がシンプルになる一方で、ネストしたSQLを多用すると、
N+1問題を引き起こす要因になるという事を意識する必要がある。</p>
<p>ネストしたSQLを使用する場合のMyBatisのデフォルトの動作は、&#8221;Eager Load&#8221;となる。
これは、関連Entityの使用有無に関係なくSQLが発行される事を意味しており、</p>
<ul class="simple">
<li>無駄なSQLの実行とデータの取得</li>
<li>N+1問題</li>
</ul>
<p class="last">などが発生する危険性が高まる。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>MyBatis3では、ネストしたSQLを使用して関連Entityを取得する際の動作を、
&#8220;Lazy Load&#8221;に変更するためのオプションを提供している。</p>
<p class="last">&#8220;Lazy Load&#8221;の使用方法については、「<a class="reference internal" href="#dataaccessmybatis3appendixnestedselectlazysetting"><em>関連EntityをLazy Loadするための設定</em></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3appendixnestedselectmapping">
<span id="id71"></span><h4><a class="toc-backref" href="#id149">5.2.4.5.1. 関連EntityをネストしたSQLを使用して取得する実装例</a><a class="headerlink" href="#dataaccessmybatis3appendixnestedselectmapping" title="Permalink to this headline">¶</a></h4>
<p>ネストしたSQLを使用して関連Entityを取得する際の実装例を以下に示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Item&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="nt">/&gt;</span>
<span class="hll">    <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span>
</span><span class="hll">        <span class="na">select=</span><span class="s">&quot;findAllCategoryByItemCode&quot;</span> <span class="nt">/&gt;</span>
</span><span class="nt">&lt;/resultMap&gt;</span>

<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllCategoryByItemCode&quot;</span>
    <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Category&quot;</span><span class="nt">&gt;</span>
    SELECT
        ct.code,
        ct.name
    FROM
        m_item_category ic
    INNER JOIN m_category ct ON ct.code = ic.category_code
    WHERE
        ic.item_code = #{itemCode}
    ORDER BY
        code
<span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">association</span></tt>要素又は<tt class="docutils literal"><span class="pre">collection</span></tt>要素の<tt class="docutils literal"><span class="pre">select</span></tt>属性に、
呼び出すSQLのステートメントIDを指定する。</p>
<p><tt class="docutils literal"><span class="pre">column</span></tt>属性には、SQLに渡すパラメータ値が格納されているカラム名を指定する。
上記例では、
<tt class="docutils literal"><span class="pre">findAllCategoryByItemCode</span></tt>のパラメータとして<tt class="docutils literal"><span class="pre">item_code</span></tt>カラムの値を渡している。</p>
<p class="last">指定可能な属性の詳細は、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/sqlmap-xml.html#Nested_Select_for_Association">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-Nested Select for Association-)</a>」を参照されたい。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>上記例では、<tt class="docutils literal"><span class="pre">fetchType</span></tt>属性を指定していないため、
&#8220;Lazy Load&#8221;と&#8221;Eager Load&#8221;のどちらで実行されるかは、
アプリケーション全体の設定に依存する。</p>
<p class="last">アプリケーション全体の設定については、
「<a class="reference internal" href="#dataaccessmybatis3appendixnestedselectlazysettingmybatis"><em>Lazy Loadを使用するためのMyBatisの設定</em></a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="entitylazy-load">
<span id="dataaccessmybatis3appendixnestedselectlazysetting"></span><h4><a class="toc-backref" href="#id150">5.2.4.5.2. 関連EntityをLazy Loadするための設定</a><a class="headerlink" href="#entitylazy-load" title="Permalink to this headline">¶</a></h4>
<p>ネストしたSQLを使用して関連Entityを取得する際のMyBatis3のデフォルト動作は、
&#8220;Eager Load&#8221;であるが、&#8221;Lazy Load&#8221;を使用する事も可能である。</p>
<p>以下に、&#8221;Lazy Load&#8221;を使用するために最低限必要な設定及び使用方法について説明を行う。</p>
<p>説明していない設定値については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/configuration.html#settings">MyBatis3 REFERENCE DOCUMENTATION(Mapper XML Files-settings-)</a>」を参照されたい。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="dataaccessmybatis3appendixnestedselectlazysettinglibrary">
<span id="id72"></span><h5>5.2.4.5.2.1. バイトコード操作ライブラリの追加<a class="headerlink" href="#dataaccessmybatis3appendixnestedselectlazysettinglibrary" title="Permalink to this headline">¶</a></h5>
<p>&#8220;Lazy Load&#8221;を使用する場合は、&#8221;Lazy Load&#8221;を実現するためのProxyオブジェクトを生成するために、</p>
<ul class="simple">
<li>CGLIB</li>
<li>JAVASSIST</li>
</ul>
<p>のいずれか一方のライブラリが必要となる。</p>
<p>ここでは、MyBatis 3.2系のデフォルトに指定されているCGLIBを依存ライブラリに追加する方法を示す。</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">projectName-domain/pom.xml</span></tt></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>cglib<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>cglib<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.2.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><tt class="file docutils literal"><span class="pre">pom.xml</span></tt>に、CGLIBのアーティファクトを追加する。</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>MyBatis 3.3.0以降のバージョンでは、JAVASSISTがMyBatis本体に内包されるため、
ライブラリを追加しなくても&#8221;Lazy Load&#8221;を使用する事ができる。</p>
<p>3.2系ではCGLIBがデフォルトだが、3.3系からはMyBatisが内包しているJAVASSISTがデフォルトになる。</p>
<p>3.2系でJAVASSISTを使用する場合は、</p>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">pom.xml</span></tt>にJAVASSISTのアーティファクトを追加</li>
<li>MyBatis設定ファイル(<tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></tt>)に「<tt class="docutils literal"><span class="pre">proxyFactory=JAVASSIST</span></tt>」を追加</li>
</ul>
<p>すればよい。</p>
<p class="last">JAVASSISTのアーティファクト情報については、
「<a class="reference external" href="http://mybatis.github.io/mybatis-3/dependencies.html#compile">MyBatis3 PROJECT DOCUMENTATION(Project Dependencies-compile-)</a>」を参照されたい。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="lazy-loadmybatis">
<span id="dataaccessmybatis3appendixnestedselectlazysettingmybatis"></span><h5>5.2.4.5.2.2. Lazy Loadを使用するためのMyBatisの設定<a class="headerlink" href="#lazy-loadmybatis" title="Permalink to this headline">¶</a></h5>
<p>MyBatis3では、&#8221;Lazy Load&#8221;の使用有無を、</p>
<ul class="simple">
<li>アプリケーションの全体設定(MyBatis設定ファイル)</li>
<li>個別設定(マッピングファイル)</li>
</ul>
<p>の2箇所で指定する事ができる。</p>
<ul class="simple">
<li>アプリケーションの全体設定は、
MyBatis設定ファイル(<tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></tt>)に指定する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration</span>
<span class="cp">        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;settings&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;lazyLoadingEnabled&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">アプリケーションのデフォルト動作を<tt class="docutils literal"><span class="pre">lazyLoadingEnabled</span></tt>に指定する。</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">true</span></tt>: &#8220;Lazy Load&#8221;</li>
<li><tt class="docutils literal"><span class="pre">false</span></tt>: &#8220;Eager Load&#8221; (デフォルト)</li>
</ul>
<p class="last"><tt class="docutils literal"><span class="pre">association</span></tt>要素と<tt class="docutils literal"><span class="pre">collection</span></tt>要素の<tt class="docutils literal"><span class="pre">fetchType</span></tt>属性を指定した場合は、
<tt class="docutils literal"><span class="pre">fetchType</span></tt>属性の指定値が優先される。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>「<tt class="docutils literal"><span class="pre">false</span></tt>: &#8220;Eager Load&#8221;」の状態で<tt class="docutils literal"><span class="pre">association</span></tt>要素又は<tt class="docutils literal"><span class="pre">collection</span></tt>要素の<tt class="docutils literal"><span class="pre">select</span></tt>属性を使用すると、
マッピング時にSQLが実行されるので、注意が必要である。</p>
<p class="last">特に理由がない場合は、<tt class="docutils literal"><span class="pre">lazyLoadingEnabled</span></tt>は<tt class="docutils literal"><span class="pre">true</span></tt>にする事を推奨する。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>個別設定は、
マッピングファイルの<tt class="docutils literal"><span class="pre">association</span></tt>要素と<tt class="docutils literal"><span class="pre">collection</span></tt>要素の<tt class="docutils literal"><span class="pre">fetchType</span></tt>属性で指定する。</li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre>    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Item&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span>
<span class="hll">            <span class="na">fetchType=</span><span class="s">&quot;lazy&quot;</span>
</span>            <span class="na">select=</span><span class="s">&quot;findAllCategoryByItemCode&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findAllCategoryByItemCode&quot;</span>
        <span class="na">parameterType=</span><span class="s">&quot;string&quot;</span> <span class="na">resultType=</span><span class="s">&quot;Category&quot;</span><span class="nt">&gt;</span>
        SELECT
            ct.code,
            ct.name
        FROM
            m_item_category ic
        INNER JOIN m_category ct ON ct.code = ic.category_code
        WHERE
            ic.item_code = #{itemCode}
        ORDER BY
            code
    <span class="nt">&lt;/select&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first"><tt class="docutils literal"><span class="pre">association</span></tt>要素又は<tt class="docutils literal"><span class="pre">collection</span></tt>要素の<tt class="docutils literal"><span class="pre">fetchType</span></tt>属性に、
<tt class="docutils literal"><span class="pre">lazy</span></tt>又は<tt class="docutils literal"><span class="pre">eager</span></tt>を指定する。</p>
<p class="last"><tt class="docutils literal"><span class="pre">fetchType</span></tt>属性を指定すると、アプリケーション全体の設定を上書きする事ができる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="lazy-load">
<span id="dataaccessmybatis3appendixnestedselectlazysettingtiming"></span><h5>5.2.4.5.2.3. Lazy Loadの実行タイミングを制御するための設定<a class="headerlink" href="#lazy-load" title="Permalink to this headline">¶</a></h5>
<p>MyBatis3では、&#8221;Lazy Load&#8221;を実行するタイミングを制御するためのオプションを提供している。</p>
<p>&#8220;Lazy Load&#8221;を実行するタイミングを制御するための設定は、
MyBatis設定ファイル(<tt class="file docutils literal"><span class="pre">projectName-domain/src/main/resources/META-INF/mybatis/mybatis-config.xml</span></tt>)に指定する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration</span>
<span class="cp">        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;settings&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">&quot;aggressiveLazyLoading&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/settings&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple">
<li></li>
</ol>
</td>
<td><p class="first">&#8220;Lazy Load&#8221;を実行するタイミングを<tt class="docutils literal"><span class="pre">aggressiveLazyLoading</span></tt>に指定する。</p>
<ul class="last simple">
<li><tt class="docutils literal"><span class="pre">true</span></tt>: &#8220;Lazy Load&#8221;対象となっているプロパティを保持するオブジェクトのgetterメソッドが呼び出されたタイミングで実行する（デフォルト）</li>
<li><tt class="docutils literal"><span class="pre">false</span></tt>: &#8220;Lazy Load&#8221;対象となっているプロパティのgetterメソッドが呼び出されたタイミングで実行する</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>「<tt class="docutils literal"><span class="pre">true</span></tt>」（デフォルト）の場合、使用されないデータを取得するためにSQLが実行される可能性があるので、注意が必要である。</p>
<p>具体的には、以下のようなマッピングを行い、
&#8220;Lazy Load&#8221;対象になっていないプロパティだけにアクセスするケースである。
「<tt class="docutils literal"><span class="pre">true</span></tt>」（デフォルト）の場合、&#8221;Lazy Load&#8221;対象のプロパティに対して直接アクセスしなくても、
&#8220;Lazy Load&#8221;が実行されてしまう。</p>
<p>特に理由がない場合は、<tt class="docutils literal"><span class="pre">aggressiveLazyLoading</span></tt>は<tt class="docutils literal"><span class="pre">false</span></tt>にする事を推奨する。</p>
<ul class="last">
<li><p class="first">Entity</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">categories</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">マッピングファイル</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;itemResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;Item&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;code&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;item_name&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;item_price&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">&quot;categories&quot;</span> <span class="na">column=</span><span class="s">&quot;item_code&quot;</span>
        <span class="na">fetchType=</span><span class="s">&quot;lazy&quot;</span> <span class="na">select=</span><span class="s">&quot;findByItemCode&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/resultMap&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">アプリケーションコード(Service)</p>
<div class="highlight-java"><div class="highlight"><pre>    <span class="n">Item</span> <span class="n">item</span> <span class="o">=</span> <span class="n">itemRepository</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">itemCode</span><span class="o">);</span>
<span class="hll">    <span class="c1">// (2)</span>
</span><span class="hll">    <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getCode</span><span class="o">();</span>
</span>    <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">price</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">getPrice</span><span class="o">();</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">項番</p>
</th>
<th class="head"><p class="first last">説明</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><ol class="first last arabic simple" start="2">
<li></li>
</ol>
</td>
<td><p class="first">上記例では、&#8221;Lazy Load&#8221;対象のプロパティである<tt class="docutils literal"><span class="pre">categories</span></tt>プロパティにアクセスしていないが、
<tt class="docutils literal"><span class="pre">Item#code</span></tt>プロパティにアクセスした際に、&#8221;Lazy Load&#8221;が実行される。</p>
<p class="last">「<tt class="docutils literal"><span class="pre">false</span></tt>」（デフォルト）の場合、上記のケースでは&#8221;Lazy Load&#8221;は実行されない。</p>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div></blockquote>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="DataAccessJpa.html" title="5.3. データベースアクセス（JPA編）"
             >next</a> |</li>
        <li class="right" >
          <a href="DataAccessCommon.html" title="5.1. データベースアクセス（共通編）"
             >previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Server Framework for Java (5.x) Development Guideline 5.1.0-SNAPSHOT documentation</a> &raquo;</li>
          <li><a href="index.html" >5. TERASOLUNA Server Framework for Java (5.x)の機能詳細</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2015, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>