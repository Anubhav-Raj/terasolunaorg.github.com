<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>6.3. Authentication &mdash; TERASOLUNA Global Framework Development Guideline 1.1.0-SNAPSHOT documentation</title>
    
    <link rel="stylesheet" href="../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1.0-SNAPSHOT',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="TERASOLUNA Global Framework Development Guideline 1.1.0-SNAPSHOT documentation" href="../index.html" />
    <link rel="up" title="6. Security for TERASOLUNA Global Framework" href="index.html" />
    <link rel="next" title="6.4. Password Hashing" href="PasswordHashing.html" />
    <link rel="prev" title="6.2. Spring Security Tutorial" href="Tutorial.html" /><script src="../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../_static/solarized-dark.css" rel="stylesheet">
<link href="../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="PasswordHashing.html" title="6.4. Password Hashing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Tutorial.html" title="6.2. Spring Security Tutorial"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.1.0-SNAPSHOT documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">6. Security for TERASOLUNA Global Framework</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6.3. Authentication</a><ul>
<li><a class="reference internal" href="#overview">6.3.1. Overview</a><ul>
<li><a class="reference internal" href="#login">6.3.1.1. Login</a></li>
<li><a class="reference internal" href="#logout">6.3.1.2. Logout</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">6.3.2. How to use</a><ul>
<li><a class="reference internal" href="#setting-sec-http-element">6.3.2.1. Setting <tt class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></tt> element</a></li>
<li><a class="reference internal" href="#setting-sec-form-login-element">6.3.2.2. Setting <tt class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></tt> element</a><ul>
<li><a class="reference internal" href="#creating-login-form">6.3.2.2.1. Creating login form</a></li>
<li><a class="reference internal" href="#changing-attribute-name-of-login-form">6.3.2.2.2. Changing attribute name of login form</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-authentication-process">6.3.2.3. Setting authentication process</a><ul>
<li><a class="reference internal" href="#authenticationprovider-class-settings">6.3.2.3.1. <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt> class settings</a></li>
<li><a class="reference internal" href="#userdetailsservice-class-settings">6.3.2.3.2. <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt> class settings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use-userdetails-class">6.3.2.4. How to use <tt class="docutils literal"><span class="pre">UserDetails</span></tt> class</a><ul>
<li><a class="reference internal" href="#using-userdetails-object-in-java-class">6.3.2.4.1. Using <tt class="docutils literal"><span class="pre">UserDetails</span></tt> object in Java class</a></li>
<li><a class="reference internal" href="#accessing-userdetails-in-jsp">6.3.2.4.2. Accessing <tt class="docutils literal"><span class="pre">UserDetails</span></tt> in JSP</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session-management-in-spring-security">6.3.2.5. Session management in Spring Security</a><ul>
<li><a class="reference internal" href="#setting-sessionauthenticationstrategy">6.3.2.5.1. Setting <tt class="docutils literal"><span class="pre">SessionAuthenticationStrategy</span></tt></a></li>
<li><a class="reference internal" href="#controlling-the-number-of-concurrent-sessions">6.3.2.5.2. Controlling the number of concurrent sessions.</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-the-handler-class-in-case-of-authentication-error">6.3.2.6. Setting the handler class in case of authentication error</a></li>
<li><a class="reference internal" href="#setting-sec-logout-element">6.3.2.7. Setting <tt class="docutils literal"><span class="pre">&lt;sec:logout&gt;</span></tt> element</a></li>
<li><a class="reference internal" href="#setting-sec-remember-me-element">6.3.2.8. Setting <tt class="docutils literal"><span class="pre">&lt;sec:remember-me&gt;</span></tt> element</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">6.3.3. How to extend</a><ul>
<li><a class="reference internal" href="#extending-userdetailsservice">6.3.3.1. Extending <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt></a><ul>
<li><a class="reference internal" href="#extending-userdetails">6.3.3.1.1. Extending <tt class="docutils literal"><span class="pre">UserDetails</span></tt></a></li>
<li><a class="reference internal" href="#implementing-an-independent-userdetailsservice">6.3.3.1.2. Implementing an independent <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt></a></li>
<li><a class="reference internal" href="#id3">6.3.3.1.3. How to use</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extending-authenticationprovider">6.3.3.2. Extending <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt></a><ul>
<li><a class="reference internal" href="#extending-usernamepasswordauthenticationtoken">6.3.3.2.1. Extending <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationToken</span></tt></a></li>
<li><a class="reference internal" href="#implementing-an-independent-authenticationprovider">6.3.3.2.2. Implementing an independent <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt></a></li>
<li><a class="reference internal" href="#extending-usernamepasswordauthenticationfilter">6.3.3.2.3. Extending <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></tt></a></li>
<li><a class="reference internal" href="#id4">6.3.3.2.4. How to use</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix">6.3.4. Appendix</a></li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="Tutorial.html"
                        title="previous chapter">6.2. Spring Security Tutorial</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="PasswordHashing.html"
                        title="next chapter">6.4. Password Hashing</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/Security/Authentication.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="authentication">
<h1>6.3. Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">Â¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id5">Overview</a><ul>
<li><a class="reference internal" href="#login" id="id6">Login</a></li>
<li><a class="reference internal" href="#logout" id="id7">Logout</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id8">How to use</a><ul>
<li><a class="reference internal" href="#setting-sec-http-element" id="id9">Setting <tt class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></tt> element</a></li>
<li><a class="reference internal" href="#setting-sec-form-login-element" id="id10">Setting <tt class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></tt> element</a><ul>
<li><a class="reference internal" href="#creating-login-form" id="id11">Creating login form</a></li>
<li><a class="reference internal" href="#changing-attribute-name-of-login-form" id="id12">Changing attribute name of login form</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-authentication-process" id="id13">Setting authentication process</a><ul>
<li><a class="reference internal" href="#authenticationprovider-class-settings" id="id14"><tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt> class settings</a></li>
<li><a class="reference internal" href="#userdetailsservice-class-settings" id="id15"><tt class="docutils literal"><span class="pre">UserDetailsService</span></tt> class settings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use-userdetails-class" id="id16">How to use <tt class="docutils literal"><span class="pre">UserDetails</span></tt> class</a><ul>
<li><a class="reference internal" href="#using-userdetails-object-in-java-class" id="id17">Using <tt class="docutils literal"><span class="pre">UserDetails</span></tt> object in Java class</a></li>
<li><a class="reference internal" href="#accessing-userdetails-in-jsp" id="id18">Accessing <tt class="docutils literal"><span class="pre">UserDetails</span></tt> in JSP</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session-management-in-spring-security" id="id19">Session management in Spring Security</a><ul>
<li><a class="reference internal" href="#setting-sessionauthenticationstrategy" id="id20">Setting <tt class="docutils literal"><span class="pre">SessionAuthenticationStrategy</span></tt></a></li>
<li><a class="reference internal" href="#controlling-the-number-of-concurrent-sessions" id="id21">Controlling the number of concurrent sessions.</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-the-handler-class-in-case-of-authentication-error" id="id22">Setting the handler class in case of authentication error</a></li>
<li><a class="reference internal" href="#setting-sec-logout-element" id="id23">Setting <tt class="docutils literal"><span class="pre">&lt;sec:logout&gt;</span></tt> element</a></li>
<li><a class="reference internal" href="#setting-sec-remember-me-element" id="id24">Setting <tt class="docutils literal"><span class="pre">&lt;sec:remember-me&gt;</span></tt> element</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id25">How to extend</a><ul>
<li><a class="reference internal" href="#extending-userdetailsservice" id="id26">Extending <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt></a><ul>
<li><a class="reference internal" href="#extending-userdetails" id="id27">Extending <tt class="docutils literal"><span class="pre">UserDetails</span></tt></a></li>
<li><a class="reference internal" href="#implementing-an-independent-userdetailsservice" id="id28">Implementing an independent <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt></a></li>
<li><a class="reference internal" href="#id3" id="id29">How to use</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extending-authenticationprovider" id="id30">Extending <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt></a><ul>
<li><a class="reference internal" href="#extending-usernamepasswordauthenticationtoken" id="id31">Extending <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationToken</span></tt></a></li>
<li><a class="reference internal" href="#implementing-an-independent-authenticationprovider" id="id32">Implementing an independent <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt></a></li>
<li><a class="reference internal" href="#extending-usernamepasswordauthenticationfilter" id="id33">Extending <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></tt></a></li>
<li><a class="reference internal" href="#id4" id="id34">How to use</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix" id="id35">Appendix</a></li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id5">6.3.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">Â¶</a></h2>
<div class="line-block">
<div class="line">This chapter explains about Authentication functionality provided by Spring Security.</div>
</div>
<p>In Spring Security, user authentication can be implemented by just performing configuration file settings.
DB authentication, LDAP authentication, CAS authentication, JAAS authentication, X509 authentication and Basic authentication are the authentication methods provided by Spring Security. However, only DB authentication is described in this guideline.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<blockquote>
<div>For details of authentication types other than DB authentication, refer to the official document of each authentication method.</div></blockquote>
<ul class="last simple">
<li><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#ldap">LDAP Authentication</a></li>
<li><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#cas">CAS Authentication</a></li>
<li><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#jaas">Java Authentication and Authorization Service (JAAS) Provider</a></li>
<li><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#x509">X.509 Authentication</a></li>
<li><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#basic">Basic and Digest Authentication</a></li>
</ul>
</div>
<div class="section" id="login">
<h3><a class="toc-backref" href="#id6">6.3.1.1. Login</a><a class="headerlink" href="#login" title="Permalink to this headline">Â¶</a></h3>
<p>Flow of Spring Security login process is as follows:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/Authentication_Login_overview.png"><img alt="Authentication(Login)" src="../_images/Authentication_Login_overview.png" style="width: 80%;" /></a>
</div>
<ol class="arabic simple">
<li>Authentication filter is activated on receiving the request specifying authentication.</li>
<li>Authentication filter extracts username and password from the request and generates authentication information.
The  generated authentication information is used as a parameter to execute authentication process of authentication manager.</li>
<li>Authentication manager executes authentication process of the specified authentication provider.
Authentication provider acquires user information from datasource (DB or LDAP) and performs user authentication such as password verification.
When authentication is successful, authentication information that holds the authenticated information is created and returned to the authentication manager.
When authentication fails, the authentication manager raises authentication failure exception.</li>
<li>Authentication manager returns the received authentication information to authentication filter.</li>
<li>Authentication filter stores the received authentication information (authenticated) in session.</li>
<li>When authentication is successful, it initializes the session information before authentication and creates new session information.</li>
<li>It redirects to the specified path of successful/failed  authentication and returns session ID to client.</li>
</ol>
</div>
<div class="section" id="logout">
<h3><a class="toc-backref" href="#id7">6.3.1.2. Logout</a><a class="headerlink" href="#logout" title="Permalink to this headline">Â¶</a></h3>
<p>Flow of Spring Security logout process is as follows:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/Authentication_Logout_overview.png"><img alt="Authentication(Logout)" src="../_images/Authentication_Logout_overview.png" style="width: 80%;" /></a>
</div>
<ol class="arabic simple">
<li>Logout filter gets activated on receiving request for logout.</li>
<li>It discards the session information.
It sets a response such that client cookie (Cookie in figure) is discarded.</li>
<li>It redirects to the specified logout path.</li>
</ol>
<dl class="docutils">
<dt></dt>
<dd><div class="first last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The session information that remains after logout can be used by a third party. Hence, in order to prevent such spoofing,
session information is discarded at the time of logout using <tt class="docutils literal"><span class="pre">org.springframework.security.web.session.ConcurrentSessionFilter</span></tt>.</p>
</div>
</dd>
</dl>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id8">6.3.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">Â¶</a></h2>
<div class="line-block">
<div class="line">Settings to be performed in Spring Security configuration file so as to use authentication functionality, are as follows:</div>
<div class="line">For basic settings, refer to <a class="reference internal" href="SpringSecurity.html"><em>Spring Security Overview</em></a>.</div>
</div>
<div class="section" id="setting-sec-http-element">
<h3><a class="toc-backref" href="#id9">6.3.2.1. Setting <tt class="docutils literal"><span class="pre">&lt;sec:http&gt;</span></tt> element</a><a class="headerlink" href="#setting-sec-http-element" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">As shown in the following example, basic settings for authentication functionality of</div>
<div class="line">Spring Security can be omitted by setting the <tt class="docutils literal"><span class="pre">auto-config</span></tt> attribute of <tt class="docutils literal"><span class="pre">&lt;http&gt;</span></tt> element in spring-security.xml to <tt class="docutils literal"><span class="pre">true</span></tt>.</div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
    <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">        http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans</span>
<span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/context</span>
<span class="s">        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span> <span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
      <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;/sec:http&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">By setting <tt class="docutils literal"><span class="pre">auto-config=&quot;true&quot;</span></tt>,</div>
<div class="line">it is enabled even if <tt class="docutils literal"><span class="pre">&lt;form-login&gt;</span></tt>, <tt class="docutils literal"><span class="pre">&lt;http-basic&gt;</span></tt> and <tt class="docutils literal"><span class="pre">&lt;logout&gt;</span></tt> elements are not set.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><tt class="docutils literal"><span class="pre">&lt;form-login&gt;</span></tt>, <tt class="docutils literal"><span class="pre">&lt;http-basic&gt;</span></tt> and <tt class="docutils literal"><span class="pre">&lt;logout&gt;</span></tt> elements are explained here.</p>
<blockquote class="last">
<div><table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Element name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&lt;form-login&gt;</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter</span></tt> is enabled.</div>
<div class="line">UsernamePasswordAuthenticationFilter is the Filter that performs authentication by extracting username and password from the request at the time of POST method.</div>
<div class="line">For details, refer <a class="reference internal" href="#form-login"><em>Setting &lt;sec:form-login&gt; element</em></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&lt;http-basic&gt;</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.www.BasicAuthenticationFilter</span></tt> is enabled.</div>
<div class="line">BasicAuthenticationFilter is the filter that executes Basic authentication process according to RFC1945.</div>
<div class="line">For details, refer <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/apidocs/org/springframework/security/web/authentication/www/BasicAuthenticationFilter.html">BasicAuthenticationFilter JavaDoc</a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">&lt;logout&gt;</span></tt></div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.logout.LogoutFilter</span></tt>,</div>
<div class="line"><tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler</span></tt> is enabled.</div>
<div class="line">LogoutFilter is the Filter called at the time of Logout.</div>
<div class="line"><tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices</span></tt> (deleting Cookie) and,</div>
<div class="line">SecurityContextLogoutHandler(disabling  session) is called.</div>
<div class="line">For details, refer <a class="reference internal" href="#form-logout"><em>Setting &lt;sec:logout&gt; element</em></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="setting-sec-form-login-element">
<span id="form-login"></span><h3><a class="toc-backref" href="#id10">6.3.2.2. Setting <tt class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></tt> element</a><a class="headerlink" href="#setting-sec-form-login-element" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">How to set <tt class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></tt> element is described in this section.</div>
<div class="line"><br /></div>
<div class="line">Attributes of form-login element are as shown below.</div>
</div>
<p>spring-security.xml</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
    <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xmlns:sec=</span><span class="s">&quot;http://www.springframework.org/schema/security&quot;</span>
    <span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/security</span>
<span class="s">        http://www.springframework.org/schema/security/spring-security.xsd</span>
<span class="s">        http://www.springframework.org/schema/beans</span>
<span class="s">        http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="s">        http://www.springframework.org/schema/context</span>
<span class="s">        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span> <span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="na">login-page=</span><span class="s">&quot;/login&quot;</span>
        <span class="na">default-target-url=</span><span class="s">&quot;/&quot;</span>
        <span class="na">login-processing-url=</span><span class="s">&quot;/authentication&quot;</span>
        <span class="na">always-use-default-target=</span><span class="s">&quot;false&quot;</span>
        <span class="na">authentication-failure-url=</span><span class="s">&quot;/login?error=true&quot;</span>
        <span class="na">authentication-failure-handler-ref=</span><span class="s">&quot;authenticationFailureHandler&quot;</span>
        <span class="na">authentication-success-handler-ref=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- Perform steps (1) - (7) in the specified attribute order--&gt;</span>
  <span class="nt">&lt;/sec:http&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the login form screen path in <tt class="docutils literal"><span class="pre">login-page</span></tt> attribute.</div>
<div class="line">An &#8220;unauthenticated user&#8221; is forcefully redirected to this path, when he tries to access the page that can be accessed only by</div>
<div class="line">an &#8220;authenticated user&#8221;.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the destination path in <tt class="docutils literal"><span class="pre">default-target-url</span></tt> attribute when authentication is successful. When it is not specified, &#8220;/&#8221; will be the default path.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the path that performs authentication process in <tt class="docutils literal"><span class="pre">login-processing-url</span></tt> attribute. When not specified,&#8221;j_spring_security_check&#8221; will be the default path.</div>
<div class="line"><strong>This guideline recommends changing to a system specific value rather than using the default value  &#8220;j_spring_security_check&#8221;, mentioned above.</strong>In this example, &#8220;/authentication&#8221; is specified.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">After a successful login, specify whether it should always transit to the path specified in <tt class="docutils literal"><span class="pre">default-target-url</span></tt>, in the <tt class="docutils literal"><span class="pre">always-use-default-target</span></tt> attribute.</div>
<div class="line">By default it is set as <tt class="docutils literal"><span class="pre">false</span></tt>. When set as <tt class="docutils literal"><span class="pre">false</span></tt> and when the base handler class for successful authentication namely, <tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.AbstractAuthenticationTargetUrlRequestHandler</span></tt> is specified as</div>
<div class="line">redirect destination, it transits to the specified destination. If the redirect destination is not specified, it transits to the path specified in <tt class="docutils literal"><span class="pre">default-target-url</span></tt>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In case of failed authentication, specify the destination in <tt class="docutils literal"><span class="pre">authentication-failure-url</span></tt>.</div>
<div class="line">When <tt class="docutils literal"><span class="pre">authentication-failure-handler-ref</span></tt> attribute is not specified, irrespective of the type of authentication error, it uniformly transits to the destination specified for this setting.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the handler class to be called in case of a failed authentication, in <tt class="docutils literal"><span class="pre">default-target-url</span></tt> attribute.</div>
<div class="line">For details, refer <a class="reference internal" href="#authentication-failure-handler-ref"><em>Setting the handler class in case of authentication error</em></a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the handler class to be called in case of a successful authentication, in <tt class="docutils literal"><span class="pre">default-target-url</span></tt> attribute.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>For attributes other than those mentioned above, refer to <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#nsa-form-login">Spring Security manual</a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><strong>Why it is not recommended to use Spring Security default value, &#8220;j_spring_security_check&#8221;.</strong></p>
<p class="last">If default value is used, the fact that the application is using Spring Security is revealed.
As a result, if any Spring Security related vulnerability is detected, there is a higher risk of receiving an attack due to the vulnerability.
In order to prevent these risks, it is recommended to avoid using default value.</p>
</div>
<div class="section" id="creating-login-form">
<span id="form-login-jsp"></span><h4><a class="toc-backref" href="#id11">6.3.2.2.1. Creating login form</a><a class="headerlink" href="#creating-login-form" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">Create the login form to be used at the time of authentication in JSP.</div>
</div>
<ul>
<li><p class="first">src/main/webapp/WEB-INF/views/login.jsp</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/authentication&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;username&quot;</span> <span class="na">name=</span><span class="s">&quot;j_username&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="na">id=</span><span class="s">&quot;password&quot;</span> <span class="na">name=</span><span class="s">&quot;j_password&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Login&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Sr. No.</p>
</th>
<th class="head"><p class="first last">Description</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the destination for performing authentication process, in the action attribute of form.</div>
<div class="line">/authentication specified in the login-processing-url, should be specified as the destination path.</div>
<div class="line">Authentication process is executed by accessing ${pageContext.request.contextPath}/authentication.</div>
<div class="line">&#8220;POST&#8221; should be specified as the HTTP method.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Element handled as &#8220;User ID&#8221; in authentication process.</div>
<div class="line">Spring Security default value namely, &#8220;j_username&#8221;, should be specified in the name attribute.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Element handled as &#8220;Password&#8221; in authentication process.</div>
<div class="line">Spring Security default value namely, &#8220;j_password&#8221;, should be specified in the name attribute.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Following code is added to display the authentication error message.</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${param.error}&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;t:messagesPanel</span>
        <span class="na">messagesAttributeName=</span><span class="s">&quot;SPRING_SECURITY_LAST_EXCEPTION&quot;</span><span class="nt">/&gt;</span><span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/c:if&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Sr. No.</p>
</th>
<th class="head"><p class="first last">Description</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Determine the error message set in request parameter.</div>
<div class="line">Please note that the determination process needs to be changed according to</div>
<div class="line">the value set in the authentication-failure-url attribute of form-login element or the value set in &#8220;defaultFailureUrl&#8221; of authentication error handler.</div>
<div class="line">This example is shown with the setting as authentication-failure-url=&#8221;/login?error=true&#8221;.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Output the exception message that is to be output at the time of authentication error.</div>
<div class="line">It is recommended to output this message by specifying <tt class="docutils literal"><span class="pre">org.terasoluna.gfw.web.message.MessagesPanelTag</span></tt> provided by common library.</div>
<div class="line">For the details of &#8220;<tt class="docutils literal"><span class="pre">&lt;t:messagesPanel&gt;</span></tt>&#8221; tag, refer <a class="reference internal" href="../ArchitectureInDetail/MessageManagement.html"><em>Message Management</em></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">spring-mvc.xml</p>
<p>Define the Controller that displays login form.</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;mvc:view-controller</span> <span class="na">path=</span><span class="s">&quot;/login&quot;</span> <span class="na">view-name=</span><span class="s">&quot;login&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Sr. No.</p>
</th>
<th class="head"><p class="first last">Description</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">If &#8220;/login&#8221; is accessed, define the controller that returns only &#8220;login&#8221; as the view name. src/main/webapp/WEB-INF/views/login.jsp is output by <tt class="docutils literal"><span class="pre">InternalResourceViewResolver</span></tt>.</div>
<div class="line">This simple controller need not be implemented in Java.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Above settings are identical with next controller.</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/login&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginController</span> <span class="o">{</span>

    <span class="nd">@RequestMapping</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">index</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;login&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div></blockquote>
<p>If the Controller with a single method that returns only the view name is necessary, <tt class="docutils literal"><span class="pre">&lt;mvc:view-controller&gt;</span></tt> may be used.</p>
<p>Advantage of displaying login form through a Controller is that, the CSRF token gets automatically embedded by this. When it is not displayed via a Controller,
the CSRF token needs to be embedded directly in jsp, as executed in <a class="reference internal" href="Tutorial.html"><em>Spring Security Tutorial</em></a>.</p>
<p class="last">The details of creating a Controller are omitted in the Tutorial. As a result, login form is not displayed through a Controller. For details on CSRF measures, refer <a class="reference internal" href="CSRF.html"><em>CSRF Countermeasures</em></a>.</p>
</div>
</li>
</ul>
</div>
<div class="section" id="changing-attribute-name-of-login-form">
<h4><a class="toc-backref" href="#id12">6.3.2.2.2. Changing attribute name of login form</a><a class="headerlink" href="#changing-attribute-name-of-login-form" title="Permalink to this headline">Â¶</a></h4>
<p>&#8220;j_username&#8221; and &#8220;j_password&#8221; are the Spring Security default values. They can be changed to any value by using <tt class="docutils literal"><span class="pre">&lt;form-login&gt;</span></tt> element settings.</p>
<ul>
<li><p class="first">spring-security.xml</p>
<p>Attributes of <tt class="docutils literal"><span class="pre">username</span></tt> and <tt class="docutils literal"><span class="pre">password</span></tt></p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span> <span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;sec:form-login</span>
      <span class="na">username-parameter=</span><span class="s">&quot;username&quot;</span>
      <span class="na">password-parameter=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- Perform steps (1) and (2) in the specified attribute order --&gt;</span>
  <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Sr. No.</p>
</th>
<th class="head"><p class="first last">Description</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In <tt class="docutils literal"><span class="pre">username-parameter</span></tt> attribute, <tt class="docutils literal"><span class="pre">name</span></tt> attribute of input field <tt class="docutils literal"><span class="pre">username</span></tt> is changed to &#8220;username&#8221;.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In <tt class="docutils literal"><span class="pre">password-parameter</span></tt> attribute, <tt class="docutils literal"><span class="pre">name</span></tt> attribute of input field  <tt class="docutils literal"><span class="pre">password</span></tt> is changed to &#8220;password&#8221;.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</div>
<div class="section" id="setting-authentication-process">
<h3><a class="toc-backref" href="#id13">6.3.2.3. Setting authentication process</a><a class="headerlink" href="#setting-authentication-process" title="Permalink to this headline">Â¶</a></h3>
<p>In order to set the authentication process in Spring Security, define <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt> and <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt>.</p>
<p><tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt> plays the following roles.</p>
<ul class="simple">
<li>Returning authenticated user information in case of successful authentication</li>
<li>Throwing an exception in case of authentication failure.</li>
</ul>
<p><tt class="docutils literal"><span class="pre">UserDetailsService</span></tt> fetches authenticated user information from the persistence layer.</p>
<p>These classes may each be used as default or may be used by extending individually.
They may also be combined.</p>
<div class="section" id="authenticationprovider-class-settings">
<h4><a class="toc-backref" href="#id14">6.3.2.3.1. <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt> class settings</a><a class="headerlink" href="#authenticationprovider-class-settings" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">As <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt> implementation, how to use the provider, <tt class="docutils literal"><span class="pre">org.springframework.security.authentication.dao.DaoAuthenticationProvider</span></tt> that performs DB authentication, is explained here.</div>
</div>
<ul>
<li><p class="first">spring-security.xml</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sec:authentication-manager&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span> <span class="na">user-service-ref=</span><span class="s">&quot;userDetailsService&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;sec:password-encoder</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Sr. No.</p>
</th>
<th class="head"><p class="first last">Description</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define <tt class="docutils literal"><span class="pre">&lt;sec:authentication-provider&gt;</span></tt> element in <tt class="docutils literal"><span class="pre">&lt;sec:authentication-manager&gt;</span></tt> element. Authentication methods can be combined by specifying multiple elements. However it is not explained here.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt> in <tt class="docutils literal"><span class="pre">&lt;sec:authentication-provider&gt;</span></tt> element. <tt class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></tt> is enabled by default. To specify an <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt> other than this, specify the Bean ID of target AuthenticationProvider, in <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#nsa-authentication-provider">ref attribute</a>.</div>
<div class="line"><br /></div>
<div class="line">Specify the Bean Id of <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt> that fetches authenticated user information, in <tt class="docutils literal"><span class="pre">user-service-ref</span></tt> attribute. This setting is mandatory when using <tt class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></tt>.</div>
<div class="line">For details, refer <a class="reference internal" href="#userdetailsservice"><em>UserDetailsService class settings</em></a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the Bean ID of the class that encodes the password entered from Form, at the time of password verification.</div>
<div class="line">When it is not specified, password is handled in &#8220;Plain Text&#8221;. For details, refer <a class="reference internal" href="PasswordHashing.html"><em>Password Hashing</em></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line">If the requirement is to perform authentication by fetching data from persistence layer using only the &#8220;User ID&#8221; and &#8220;Password&#8221;, this <tt class="docutils literal"><span class="pre">DaoAuthenticationProvider</span></tt> may be used.</div>
<div class="line">Which method is to be used to fetch data from persistence layer, is determined using the <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt> explained below.</div>
</div>
</div>
<div class="section" id="userdetailsservice-class-settings">
<span id="userdetailsservice"></span><h4><a class="toc-backref" href="#id15">6.3.2.3.2. <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt> class settings</a><a class="headerlink" href="#userdetailsservice-class-settings" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">Set the Bean specified in <tt class="docutils literal"><span class="pre">userDetailsService</span></tt> property of <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt>.</div>
</div>
<p><tt class="docutils literal"><span class="pre">UserDetailsService</span></tt> is the interface that includes the next method.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span>
</pre></div>
</div>
<p>By executing this interface, authenticated user information can be fetched from any storage location.</p>
<p>Here, <tt class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl</span></tt> that fetches user information from DB using JDBC, is explained.</p>
<p>In order to use <tt class="docutils literal"><span class="pre">JdbcDaoImpl</span></tt>, it is advisable to perform following Bean definitions in spring-security.xml.</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userDetailsService&quot;</span>
  <span class="na">class=</span><span class="s">&quot;org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">It is assumed that <tt class="docutils literal"><span class="pre">JdbcDaoImpl</span></tt> defines the default SQL for fetching authenticated user information and authorization information and provides tables corresponding to these. For definitions of assumed tables, refer <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#appendix-schema">Spring Security manual</a>.</div>
<div class="line">To fetch user information and authorization information from existing tables, the SQL to be executed should be modified according to existing tables.</div>
<div class="line">Following 3 SQLs are used.</div>
</div>
<ul class="simple">
<li><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/apidocs/constant-values.html#org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl.DEF_USERS_BY_USERNAME_QUERY">User information acquisition query</a></li>
</ul>
<blockquote>
<div><div class="line-block">
<div class="line">By creating a table matching with the query that fetches user information, need of specifying the query to configuration file described later, is eliminated.</div>
<div class="line">Fields namely, &#8220;username&#8221;, &#8220;password&#8221; and &#8220;enabled&#8221; are mandatory</div>
<div class="line">Also, by specifying the query to the configuration file described later and by assigning an alias to the query, there is no issue even if table name and column name do not match.</div>
<div class="line">For example, while setting the following SQL, &#8220;email&#8221; column can be used as &#8220;username&#8221; wherein, &#8220;enabled&#8221; field is always <tt class="docutils literal"><span class="pre">true</span></tt>.</div>
</div>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="n">email</span> <span class="k">AS</span> <span class="n">username</span><span class="p">,</span> <span class="n">pwd</span> <span class="k">AS</span> <span class="n">password</span><span class="p">,</span> <span class="k">true</span> <span class="k">AS</span> <span class="n">enabled</span> <span class="k">FROM</span> <span class="n">customer</span> <span class="k">WHERE</span> <span class="n">email</span> <span class="o">=</span> <span class="o">?</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">&#8220;User ID&#8221; described earlier in <a class="reference internal" href="#form-login-jsp"><em>Creating login form</em></a>, is specified in query parameter.</div>
</div>
</div></blockquote>
<ul>
<li><p class="first"><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/apidocs/constant-values.html#org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl.DEF_AUTHORITIES_BY_USERNAME_QUERY">User authorities acquisition query</a></p>
<div class="line-block">
<div class="line">This query fetches authorization information for a user.</div>
</div>
</li>
<li><p class="first"><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/apidocs/constant-values.html#org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl.DEF_GROUP_AUTHORITIES_BY_USERNAME_QUERY">Group authorities acquisition query</a></p>
<div class="line-block">
<div class="line">This query fetches authorization information of the group, to which the user belongs. &#8216;Group authorities&#8217; is disabled by default and is also out of this guideline&#8217;s scope.</div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line">DB definition example and example of Spring Security configuration file are shown below.</div>
</div>
<div class="line-block">
<div class="line">Table definitions</div>
<div class="line">Define the required table when implementing DB authentication process.</div>
<div class="line">This table matches with the default query that fetches user information, mentioned earlier</div>
<div class="line">Therefore, following are the definitions of the minimum necessary tables. (with tentative physical name)</div>
</div>
<p>Table name: account</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="15%" />
<col width="10%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Logical name</th>
<th class="head">Physical name</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>User ID</td>
<td>username</td>
<td>String</td>
<td>User ID for uniquely identifying the user.</td>
</tr>
<tr class="row-odd"><td>Password</td>
<td>password</td>
<td>String</td>
<td>User password. Stored in hashed status.</td>
</tr>
<tr class="row-even"><td>Enabled flag</td>
<td>enabled</td>
<td>Boolean value</td>
<td>Flag indicating invalid user and valid user. The user set to &#8220;false&#8221; is an invalid user, thus results in throwing an authentication error.</td>
</tr>
<tr class="row-odd"><td>Authority name</td>
<td>authority</td>
<td>String</td>
<td>Not required when authorization functionality is unnecessary.</td>
</tr>
</tbody>
</table>
<p>Following is the example wherein, <tt class="docutils literal"><span class="pre">JdbcDaoImpl</span></tt> is set through customization.</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- omitted --&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userDetailsService&quot;</span>
  <span class="na">class=</span><span class="s">&quot;org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;rolePrefix&quot;</span> <span class="na">value=</span><span class="s">&quot;ROLE_&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dataSource&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;enableGroups&quot;</span> <span class="na">value=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (2) --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;usersByUsernameQuery&quot;</span>
    <span class="na">value=</span><span class="s">&quot;SELECT username, password, enabled FROM account WHERE username = ?&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (3) --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;authoritiesByUsernameQuery&quot;</span>
    <span class="na">value=</span><span class="s">&quot;SELECT username, authority FROM account WHERE username = ?&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the prefix of authorization name. When the authorization name stored on DB is &#8220;USER&#8221;, this authenticated user object has the authorization name as &#8220;ROLE_USER&#8221;.</div>
<div class="line">It is necessary to set the naming conventions and authorization functionality by combining them. For details of authorization functionality, refer <a class="reference internal" href="Authorization.html"><em>Authorization</em></a>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify this when the concept of &#8220;Group authorities&#8221; is to be used in authorization functionality.</div>
<div class="line">Not handled in this guideline.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set the query for fetching user information. Data should be fetched in the order, &#8220;User ID&#8221;, &#8220;Password&#8221; and &#8220;Enabled flag&#8221;.</div>
<div class="line">When authentication is not decided by &#8220;Enabled flag&#8221;, SELECT result of &#8220;Enabled flag&#8221; is fixed to &#8220;true&#8221;.</div>
<div class="line">The query that can uniquely acquire a user, should be described. When multiple records are fetched, the first record is used as user.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set the query that fetches user authority. Data should be acquired in the order, &#8220;User ID&#8221; and &#8220;Authority ID&#8221;.</div>
<div class="line">When authorization functionality is not used, &#8220;Authority ID&#8221; can be any fixed value.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Authentication that cannot be implemented just by changing query, is necessary to be implemented by extending <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt>.
For extension methods, refer <a class="reference internal" href="#extendsuserdetailsservice"><em>Extending UserDetailsService</em></a>.</p>
</div>
</div>
</div>
<div class="section" id="how-to-use-userdetails-class">
<h3><a class="toc-backref" href="#id16">6.3.2.4. How to use <tt class="docutils literal"><span class="pre">UserDetails</span></tt> class</a><a class="headerlink" href="#how-to-use-userdetails-class" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">How to use <tt class="docutils literal"><span class="pre">UserDetails</span></tt> created by <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt> after successful authentication is explained.</div>
</div>
<div class="section" id="using-userdetails-object-in-java-class">
<h4><a class="toc-backref" href="#id17">6.3.2.4.1. Using <tt class="docutils literal"><span class="pre">UserDetails</span></tt> object in Java class</a><a class="headerlink" href="#using-userdetails-object-in-java-class" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">After successful authentication, <tt class="docutils literal"><span class="pre">UserDetails</span></tt> class</div>
<div class="line">is stored in <tt class="docutils literal"><span class="pre">org.springframework.security.core.context.SecurityContextHolder</span></tt>.</div>
</div>
<p>Example of fetching <tt class="docutils literal"><span class="pre">UserDetails</span></tt> from <tt class="docutils literal"><span class="pre">SecurityContextHolder</span></tt> is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getUsername</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">()</span>
            <span class="o">.</span><span class="na">getAuthentication</span><span class="o">();</span> <span class="c1">// (1)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Object</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span> <span class="c1">// (2)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">principal</span> <span class="k">instanceof</span> <span class="n">UserDetails</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">((</span><span class="n">UserDetails</span><span class="o">)</span> <span class="n">principal</span><span class="o">).</span><span class="na">getUsername</span><span class="o">();</span> <span class="c1">// (3)</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">principal</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch <tt class="docutils literal"><span class="pre">org.springframework.security.core.Authentication</span></tt> object from <tt class="docutils literal"><span class="pre">SecurityContextHolder</span></tt>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch <tt class="docutils literal"><span class="pre">UserDetails</span></tt> object from <tt class="docutils literal"><span class="pre">Authentication</span></tt> object.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch user name from <tt class="docutils literal"><span class="pre">UserDetails</span></tt> object.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>While the method for fetching <tt class="docutils literal"><span class="pre">UserDetails</span></tt> object from <tt class="docutils literal"><span class="pre">SecurityContextHolder</span></tt> is convenient as it can be used from anywhere by static method,
it ends up increasing module coupling. Testing is also difficult to execute.</p>
<div class="line-block">
<div class="line"><tt class="docutils literal"><span class="pre">UserDetails</span></tt> object can be fetched by using <tt class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></tt>.</div>
<div class="line">To use <tt class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></tt>, it is necessary to set <tt class="docutils literal"><span class="pre">org.springframework.security.web.bind.support.AuthenticationPrincipalArgumentResolver</span></tt> in <tt class="docutils literal"><span class="pre">&lt;mvc:argument-resolvers&gt;</span></tt>.</div>
</div>
<ul class="simple">
<li><tt class="file docutils literal"><span class="pre">spring-mvc.xml</span></tt></li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre> <span class="nt">&lt;mvc:annotation-driven&gt;</span>
     <span class="nt">&lt;mvc:argument-resolvers&gt;</span>
         <span class="nt">&lt;bean</span>
             <span class="na">class=</span><span class="s">&quot;org.springframework.data.web.PageableHandlerMethodArgumentResolver&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">         <span class="nt">&lt;bean</span>
</span><span class="hll">             <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.bind.support.AuthenticationPrincipalArgumentResolver&quot;</span> <span class="nt">/&gt;</span>
</span>     <span class="nt">&lt;/mvc:argument-resolvers&gt;</span>
 <span class="nt">&lt;/mvc:annotation-driven&gt;</span>
</pre></div>
</div>
<p>As shown below, <tt class="docutils literal"><span class="pre">UserDetails</span></tt> object can be fetched in Spring MVC Controller, without using <tt class="docutils literal"><span class="pre">SecurityContextHolder</span></tt>.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">view</span><span class="o">(</span><span class="nd">@AuthenticationPrincipal</span> <span class="n">SampleUserDetails</span> <span class="n">userDetails</span><span class="o">,</span> <span class="c1">// (1)</span>
        <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// get account object</span>
    <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getAccount</span><span class="o">();</span> <span class="c1">// (2)</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="n">account</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">&quot;account/view&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the information of logged-in user using <tt class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></tt>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch account information from <tt class="docutils literal"><span class="pre">SampleUserDetails</span></tt>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The type of argument attached with <tt class="docutils literal"><span class="pre">&#64;AuthenticationPrincipal</span></tt> annotation, needs to be the class that inherits <tt class="docutils literal"><span class="pre">UserDetails</span></tt> type.
Usually, it is better to use the <tt class="docutils literal"><span class="pre">UserDetails</span></tt> inheritance class that is created by using <a class="reference internal" href="#extendsuserdetailsservice"><em>Extending UserDetailsService</em></a>.</p>
<p class="last"><tt class="docutils literal"><span class="pre">SampleUserDetails</span></tt> class is the class created by using <a class="reference internal" href="Tutorial.html"><em>Spring Security Tutorial</em></a>. For details, refer <em class="xref std std-ref">Tutorial_CreateAuthService</em>.</p>
</div>
<p><strong>This method is recommended when accessing UserDetails object in Controller</strong>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>It is recommended to use the <tt class="docutils literal"><span class="pre">UserDetails</span></tt> object information fetched from Controller in Service class rather than using <tt class="docutils literal"><span class="pre">SecurityContextHolder</span></tt>.</p>
<p class="last"><tt class="docutils literal"><span class="pre">SecurityContextHolder</span></tt> should be used only in those methods where <tt class="docutils literal"><span class="pre">UserDetails</span></tt> object is not passed as argument.</p>
</div>
</div>
<div class="section" id="accessing-userdetails-in-jsp">
<h4><a class="toc-backref" href="#id18">6.3.2.4.2. Accessing <tt class="docutils literal"><span class="pre">UserDetails</span></tt> in JSP</a><a class="headerlink" href="#accessing-userdetails-in-jsp" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">Spring Security provides JSP taglib as a feature that enables using authentication information in JSP. Following declaration is necessary in order to use taglib.</div>
</div>
<div class="highlight-jsp"><div class="highlight"><pre><span class="k">&lt;%@</span> <span class="n">taglib</span> <span class="n">uri</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/security/tags&quot;</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;sec&quot;</span><span class="k">%&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="https://github.com/terasolunaorg/terasoluna-gfw-web-blank">It is already set in WEB-INF/views/common/include.jsp when using TERASOLUNA Global Framework sample</a>.</p>
</div>
<div class="line-block">
<div class="line">An example of using JSP for displaying authentication is as follows:</div>
</div>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;sec:authentication</span> <span class="na">property=</span><span class="s">&quot;principal.username&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">Authentication</span></tt> object can be accessed using <tt class="docutils literal"><span class="pre">&lt;sec:authentication&gt;</span></tt>  tag and the property specified in <tt class="docutils literal"><span class="pre">property</span></tt> attribute can be accessed. In this example, result of <tt class="docutils literal"><span class="pre">getPrincipal().getUsername()</span></tt> is output.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;sec:authentication</span> <span class="na">property=</span><span class="s">&quot;principal&quot;</span> <span class="na">var=</span><span class="s">&quot;userDetails&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>

${f:h(userDetails.username)} <span class="c">&lt;!-- (2) --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Property specified in <tt class="docutils literal"><span class="pre">property</span></tt> attribute can be stored in variable, by changing it to a  <tt class="docutils literal"><span class="pre">var</span></tt> attribute name.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">UserDetails</span></tt> can be accessed in JSP once it is stored in variable by step (1).</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">UserDetails</span></tt> can also be fetched in Controller and added to <tt class="docutils literal"><span class="pre">Model</span></tt>. However, it is advisable to use JSP tag when displaying it in JSP.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><tt class="docutils literal"><span class="pre">UserDetails</span></tt> created by <tt class="docutils literal"><span class="pre">JdbcDaoImpl</span></tt> which is explained in <a class="reference internal" href="#userdetailsservice"><em>UserDetailsService class settings</em></a>, stores only the minimum required information such as &#8220;User ID&#8221; and &#8220;Authority&#8221;.</p>
<p class="last">When other information related to the user such as &#8220;User name&#8221; etc. is required to be displayed as screen fields, it is necessary to extend <tt class="docutils literal"><span class="pre">UserDetails</span></tt> and  <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt>.
For extension methods, please refer, <a class="reference internal" href="#extendsuserdetailsservice"><em>Extending UserDetailsService</em></a>.</p>
</div>
</div>
</div>
<div class="section" id="session-management-in-spring-security">
<span id="authentication-spring-security-how-to-use-sessionmanagement"></span><h3><a class="toc-backref" href="#id19">6.3.2.5. Session management in Spring Security</a><a class="headerlink" href="#session-management-in-spring-security" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">How to create session information at login and how to perform the settings when an exception occurs, is explained here.</div>
<div class="line">By specifying <tt class="docutils literal"><span class="pre">&lt;session-management&gt;</span></tt> tag, <tt class="docutils literal"><span class="pre">org.springframework.security.web.session.SessionManagementFilter</span></tt> is enabled.</div>
<div class="line">Following is the configuration example of spring-security.xml</div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span> <span class="na">create-session=</span><span class="s">&quot;ifRequired&quot;</span> <span class="nt">&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
  <span class="c">&lt;!-- omitted --&gt;</span>
  <span class="nt">&lt;sec:session-management</span>
    <span class="na">invalid-session-url=</span><span class="s">&quot;/&quot;</span>
    <span class="na">session-authentication-error-url=</span><span class="s">&quot;/&quot;</span>
    <span class="na">session-fixation-protection=</span><span class="s">&quot;migrateSession&quot;</span>
    <span class="na">session-authentication-strategy-ref=</span><span class="s">&quot;sessionStrategy&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- Perform steps (2) to (5) in the specified order of attribute --&gt;</span>
  <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the policy of creating session in <tt class="docutils literal"><span class="pre">create-session</span></tt> attribute.</div>
<div class="line">Following values can be specified.</div>
<div class="line"><tt class="docutils literal"><span class="pre">always</span></tt>: Spring Security creates a new session in case there is no existing session and it reuses a session that it already existing.</div>
<div class="line"><tt class="docutils literal"><span class="pre">ifRequired</span></tt>: Spring Security creates a session if required. It is a default setting. If a session already exists, it reuses this session without creating a new one.</div>
<div class="line"><tt class="docutils literal"><span class="pre">never</span></tt>: Spring Security does not create a session but reuses an existing session.</div>
<div class="line"><tt class="docutils literal"><span class="pre">stateless</span></tt>: Spring Security neither creates a session nor uses an existing one. As a result, authentication is required each time.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the transition path when an invalid session ID is requested in <tt class="docutils literal"><span class="pre">invalid-session-url</span></tt> attribute.</div>
<div class="line">When the path is not set, transit to a path which is dependent on <tt class="docutils literal"><span class="pre">org.springframework.security.web.session.SimpleRedirectInvalidSessionStrategy</span></tt></div>
<div class="line">setting.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When an exception occurs in <tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.session.SessionAuthenticationStrategy</span></tt></div>
<div class="line">specify the transition path in <tt class="docutils literal"><span class="pre">session-authentication-error-url</span></tt> attribute.</div>
<div class="line">When not specified, it is dependent on <tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler</span></tt></div>
<div class="line">setting.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the session management system in <tt class="docutils literal"><span class="pre">session-fixation-protection</span></tt> attribute.</div>
<div class="line">Following values can be specified.</div>
<div class="line"><tt class="docutils literal"><span class="pre">migrateSession</span></tt>: It inherits the session information before login (Copy) and only creates a new ID. This is a default setting.</div>
<div class="line"><tt class="docutils literal"><span class="pre">newSession</span></tt>: It creates new session details and new ID without inheriting the session information before login.</div>
<div class="line"><br /></div>
<div class="line">The aim of this functionality is to prevent <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#ns-session-fixation">Session fixation attack</a> by allocating new session ID for each login. Therefore, it is recommended to use this default setting, unless there are other clear reasons for not using it.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the Bean ID of <tt class="docutils literal"><span class="pre">org.springframework.security.core.Authentication.SessionAuthenticationStrategy</span></tt> class that decides the session check behavior in <tt class="docutils literal"><span class="pre">session-authentication-strategy-ref</span></tt> attribute.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="section" id="setting-sessionauthenticationstrategy">
<h4><a class="toc-backref" href="#id20">6.3.2.5.1. Setting <tt class="docutils literal"><span class="pre">SessionAuthenticationStrategy</span></tt></a><a class="headerlink" href="#setting-sessionauthenticationstrategy" title="Permalink to this headline">Â¶</a></h4>
<p>Configuration example of <tt class="docutils literal"><span class="pre">SessionAuthenticationStrategy</span></tt> is shown below.</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sessionStrategy&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.session.CompositeSessionAuthenticationStrategy&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.session.SessionFixationProtectionStrategy&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.csrf.CsrfAuthenticationStrategy&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
                <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;csrfTokenRepository&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify by listing in the constructor arguments of</div>
<div class="line"><tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.session.CompositeSessionAuthenticationStrategy</span></tt>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In this example, <tt class="docutils literal"><span class="pre">org.springframework.security.web.csrf.CsrfAuthenticationStrategy</span></tt></div>
<div class="line">that perform CSRF check is specified. Foe CSRF measures, refer <a class="reference internal" href="CSRF.html"><em>CSRF Countermeasures</em></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="controlling-the-number-of-concurrent-sessions">
<h4><a class="toc-backref" href="#id21">6.3.2.5.2. Controlling the number of concurrent sessions.</a><a class="headerlink" href="#controlling-the-number-of-concurrent-sessions" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">Spring Security provides (<a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#concurrent-sessions">Concurrent Session Control</a>) functionality that enables to arbitrarily change the number of maximum sessions that one user can store.</div>
<div class="line">The user mentioned here is the authentication user object fetched by <tt class="docutils literal"><span class="pre">Authentication.getPrincipal()</span></tt>.</div>
</div>
<div class="line-block">
<div class="line">For the control method, following patterns are available when it exceeds the maximum number of sessions. They should be suitably used as per business requirements.</div>
</div>
<ol class="arabic simple">
<li>When a user exceeds the number of maximum sessions, the user having least usage is disabled. (after win)</li>
<li>When a user exceeds the number of maximum sessions, new login request is not accepted.(first win)</li>
</ol>
<p>In both cases, following settings need to be added to web.xml, to enable this functionality.</p>
<div class="highlight-xml" id="httpsessioneventpublisher-ref"><div class="highlight"><pre><span class="nt">&lt;listener&gt;</span>
  <span class="nt">&lt;listener-class&gt;</span>org.springframework.security.web.session.HttpSessionEventPublisher<span class="nt">&lt;/listener-class&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/listener&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When using Concurrent Session Control, it is necessary to define <tt class="docutils literal"><span class="pre">org.springframework.security.web.session.HttpSessionEventPublisher</span></tt> in listener.</div>
</div>
</td>
</tr>
</tbody>
</table>
<ol class="arabic simple">
<li>When disabling the user with least usage</li>
</ol>
<blockquote>
<div><p>Add following settings to spring-security.xml.</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span> <span class="nt">&gt;</span>
  <span class="c">&lt;!-- omitted --&gt;</span>
  <span class="nt">&lt;sec:custom-filter</span> <span class="na">position=</span><span class="s">&quot;CONCURRENT_SESSION_FILTER&quot;</span> <span class="na">ref=</span><span class="s">&quot;concurrencyFilter&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>

  <span class="nt">&lt;sec:session-management</span>
    <span class="na">session-authentication-strategy-ref=</span><span class="s">&quot;sessionStrategy&quot;</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;concurrencyFilter&quot;</span>
   <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.session.ConcurrentSessionFilter&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>
   <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;sessionRegistry&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
   <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;/&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (4) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sessionAuthenticationStrategy&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.session.CompositeSessionAuthenticationStrategy&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="c">&lt;!-- omitted --&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span>
                <span class="s">&quot;org.springframework.security.web.authentication.session.ConcurrentSessionControlStrategy&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (5) --&gt;</span>
                <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;sessionRegistry&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (6) --&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maximumSessions&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (7) --&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sessionRegistry&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.core.session.SessionRegistryImpl&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (8) --&gt;</span>
<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <tt class="docutils literal"><span class="pre">CONCURRENT_SESSION_FILTER</span></tt> in <tt class="docutils literal"><span class="pre">position</span></tt> attribute of <tt class="docutils literal"><span class="pre">&lt;custom-filter&gt;</span></tt> element.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Perform Bean definition for <tt class="docutils literal"><span class="pre">org.springframework.security.web.session.ConcurrentSessionFilter</span></tt> class.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Reference specify <tt class="docutils literal"><span class="pre">org.springframework.security.core.session.SessionRegistryImpl</span></tt> in the first argument of constructor.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the path to which the expired session transits, in the second argument of constructor.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.session.ConcurrentSessionControlStrategy</span></tt> in</div>
<div class="line">the first argument of CompositeSessionAuthenticationStrategy.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Reference specify <tt class="docutils literal"><span class="pre">org.springframework.security.core.session.SessionRegistryImpl</span></tt> in the first argument of constructor.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Maximum number of sessions allowed for one user can be defined in  <tt class="docutils literal"><span class="pre">maximumSessions</span></tt> attribute.</div>
<div class="line">In the above example, since 1 is specified, the number of allowed sessions for one user is 1.</div>
<div class="line">When the user logs in with multiple browsers, the oldest used session is set as &#8216;expired&#8217;.</div>
<div class="line">When not specified, 1 is set.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify <tt class="docutils literal"><span class="pre">org.springframework.security.core.session.SessionRegistryImpl</span></tt> class that implements</div>
<div class="line"><tt class="docutils literal"><span class="pre">org.springframework.security.core.session.SessionRegistry</span></tt> interface.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>When not accepting new logins</li>
</ol>
<blockquote>
<div><p>Following settings are performed in spring-security.xml.</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;concurrencyFilter&quot;</span>
   <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.session.ConcurrentSessionFilter&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;sessionRegistry&quot;</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">value=</span><span class="s">&quot;/&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;sessionAuthenticationStrategy&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.session.CompositeSessionAuthenticationStrategy&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;</span>
            <span class="c">&lt;!-- omitted --&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span>
                <span class="s">&quot;org.springframework.security.web.authentication.session.ConcurrentSessionControlStrategy&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;sessionRegistry&quot;</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maximumSessions&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
<span class="hll">                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionIfMaximumExceeded&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</span>            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When it exceeds maximum number of sessions by setting the <tt class="docutils literal"><span class="pre">exceptionIfMaximumExceeded</span></tt> attribute to <tt class="docutils literal"><span class="pre">true</span></tt>,</div>
<div class="line"><tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.session.SessionAuthenticationException</span></tt> exception is thrown.</div>
<div class="line">As a result, it does not transit to the path defined in the second argument of <tt class="docutils literal"><span class="pre">ConcurrentSessionFilter</span></tt>. Please take note of same.</div>
<div class="line">When  the setting for <tt class="docutils literal"><span class="pre">exceptionIfMaximumExceeded</span></tt> attribute is omitted, <tt class="docutils literal"><span class="pre">false</span></tt> is set.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last"><a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#nsa-concurrency-control">&lt;sec:concurrency-control&gt;</a> can be used as a child element of <tt class="docutils literal"><span class="pre">&lt;sec:session-management&gt;</span></tt> element, without specifying the <tt class="docutils literal"><span class="pre">session-authentication-strategy-ref</span></tt> attribute of <tt class="docutils literal"><span class="pre">&lt;sec:session-management&gt;</span></tt> element.</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="setting-the-handler-class-in-case-of-authentication-error">
<span id="authentication-failure-handler-ref"></span><h3><a class="toc-backref" href="#id22">6.3.2.6. Setting the handler class in case of authentication error</a><a class="headerlink" href="#setting-the-handler-class-in-case-of-authentication-error" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">By performing the settings for <tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler</span></tt> class in</div>
<div class="line"><tt class="docutils literal"><span class="pre">authentication-failure-handler-ref</span></tt> attribute of <tt class="docutils literal"><span class="pre">&lt;sec:form-login&gt;</span></tt> element,</div>
<div class="line">exception thrown at the time of authentication error and its corresponding destination, can be specified.</div>
<div class="line">The specified destination is accessible to unauthenticated user.</div>
</div>
<p>spring-security.xml</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span> <span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;sec:form-login</span> <span class="na">login-page=</span><span class="s">&quot;/login&quot;</span>
      <span class="na">authentication-failure-handler-ref=</span><span class="s">&quot;authenticationFailureHandler&quot;</span>
      <span class="na">authentication-success-handler-ref=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;authenticationFailureHandler&quot;</span>
<span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultFailureUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;/login/defaultError&quot;</span> <span class="nt">/&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;exceptionMappings&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;props&gt;</span>
      <span class="nt">&lt;prop</span> <span class="na">key=</span>
        <span class="s">&quot;org.springframework.security.authentication.BadCredentialsException&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (3) --&gt;</span>
          /login/badCredentials
      <span class="nt">&lt;/prop&gt;</span>
      <span class="nt">&lt;prop</span> <span class="na">key=</span>
        <span class="s">&quot;org.springframework.security.core.userdetails.UsernameNotFoundException&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (4) --&gt;</span>
          /login/usernameNotFound
      <span class="nt">&lt;/prop&gt;</span>
      <span class="nt">&lt;prop</span> <span class="na">key=</span>
        <span class="s">&quot;org.springframework.security.authentication.DisabledException&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (5) --&gt;</span>
          /login/disabled
      <span class="nt">&lt;/prop&gt;</span>
      <span class="nt">&lt;prop</span> <span class="na">key=</span>
        <span class="s">&quot;org.springframework.security.authentication.ProviderNotFoundException&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (6) --&gt;</span>
          /login/providerNotFound
      <span class="nt">&lt;/prop&gt;</span>
      <span class="nt">&lt;prop</span> <span class="na">key=</span>
        <span class="s">&quot;org.springframework.security.authentication.AuthenticationServiceException&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (7) --&gt;</span>
          /login/authenticationService
      <span class="nt">&lt;/prop&gt;</span>
      <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;/props&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the default destination path in case of an error.</div>
<div class="line">If an exception not defined in the <tt class="docutils literal"><span class="pre">exceptionMappings</span></tt> property that will be described later occurs, it transits to the destination specified by this property.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the exceptions to be caught and their corresponding destinations in a list format.</div>
<div class="line">Set the exception class in key and destination in value.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p id="springsecurity-exception">A typical exception thrown by Spring Security is shown below.</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="25%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Error type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">BadCredentialsException</span></tt></td>
<td>It is thrown when authentication error occurs due to failure in password verification.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">UsernameNotFoundException</span></tt></td>
<td><div class="first last line-block">
<div class="line">It is thrown when authentication error occurs due to an invalid user ID (non-existent user ID).</div>
<div class="line">When specifying the class that inherits <tt class="docutils literal"><span class="pre">org.springframework.security.authentication.dao.AbstractUserDetailsAuthenticationProvider</span></tt> in authentication provider,</div>
<div class="line">if <tt class="docutils literal"><span class="pre">hideUserNotFoundExceptions</span></tt> is not changed to <tt class="docutils literal"><span class="pre">false</span></tt>, the above exception is changed to <tt class="docutils literal"><span class="pre">BadCredentialsException</span></tt>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">DisabledException</span></tt></td>
<td>It is thrown when an authentication error occurs due to invalid user ID.</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">ProviderNotFoundException</span></tt></td>
<td><div class="first last line-block">
<div class="line">It is thrown at the time of undetected error of authentication provider class.</div>
<div class="line">Exception occurs when authentication provider class is invalid due to reasons such as a setting error etc.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><tt class="docutils literal"><span class="pre">AuthenticationServiceException</span></tt></td>
<td><div class="first last line-block">
<div class="line">It is thrown at the time of authentication service error.</div>
<div class="line">It is thrown when certain errors such as DB connection error etc. occur in authentication service.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">In this example, transition is made by handling <tt class="docutils literal"><span class="pre">UsernameNotFoundException</span></tt>.
However, if the user is informed that user ID does not exist, presence and absence of specific IDs may be revealed, which is not desirable from the security perspective.
Therefore, it is recommended that the screen transition and notification message to the user is set such that it does not reveal type of exception.</p>
</div>
</div>
<div class="section" id="setting-sec-logout-element">
<span id="form-logout"></span><h3><a class="toc-backref" href="#id23">6.3.2.7. Setting <tt class="docutils literal"><span class="pre">&lt;sec:logout&gt;</span></tt> element</a><a class="headerlink" href="#setting-sec-logout-element" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">How to set the <tt class="docutils literal"><span class="pre">&lt;sec:logout&gt;</span></tt> element, is explained in this section.</div>
</div>
<p>spring-security.xml</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span> <span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- omitted --&gt;</span>
  <span class="nt">&lt;sec:logout</span>
      <span class="na">logout-url=</span><span class="s">&quot;/logout&quot;</span>
      <span class="na">logout-success-url=</span><span class="s">&quot;/&quot;</span>
      <span class="na">invalidate-session=</span><span class="s">&quot;true&quot;</span>
      <span class="na">delete-cookies=</span><span class="s">&quot;JSESSIONID&quot;</span>
      <span class="na">success-handler-ref=</span><span class="s">&quot;logoutSuccessHandler&quot;</span>
    <span class="nt">/&gt;</span> <span class="c">&lt;!-- Perform steps (1) to (5) in the specified attribute order --&gt;</span>
  <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the path for executing logout process in <tt class="docutils literal"><span class="pre">logout-url</span></tt> attribute.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the destination path after logout in <tt class="docutils literal"><span class="pre">logout-success-url</span></tt> attribute.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">In <tt class="docutils literal"><span class="pre">invalidate-session</span></tt> attribute, set whether to discard the session when logging out. By default, it is set to <tt class="docutils literal"><span class="pre">true</span></tt>. When <tt class="docutils literal"><span class="pre">true</span></tt>, the session gets cleared at the time of logout.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Delete the cookie specified in <tt class="docutils literal"><span class="pre">delete-cookies</span></tt> attribute. When multiple cookies are to be deleted, use &#8221;,&#8221; to separate them.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the handler class that is called after a successful logout, in <tt class="docutils literal"><span class="pre">success-handler-ref</span></tt> attribute.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>CSRF token check is performed when  <tt class="docutils literal"><span class="pre">&lt;sec:csrf&gt;</span></tt> explained in <a class="reference internal" href="CSRF.html"><em>CSRF Countermeasures</em></a> is used. Therefore, <strong>it is necessary to send logout request using POST as well as send the CSRF token.</strong>How to embed CSRF token is explained below.</p>
<ul class="last">
<li><p class="first"><a class="reference internal" href="CSRF.html#csrf-formformtag-use"><em>How to insert CSRF token automatically</em></a></p>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre><span class="hll"> <span class="nt">&lt;form:form</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span>
</span>   <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/logout&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Logout&quot;</span> <span class="nt">/&gt;</span>
<span class="hll"> <span class="nt">&lt;/form:form&gt;</span>
</span></pre></div>
</div>
<p>Following HTML is output in such cases. CSRF token is set as hidden.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&quot;command&quot;</span> <span class="na">action=</span><span class="s">&quot;/your-context-path/logout&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Logout&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">value=</span><span class="s">&quot;5826038f-0a84-495b-a851-c363e501b73b&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first"><a class="reference internal" href="CSRF.html#csrf-formtag-use"><em>How to explicitly insert CSRF token</em></a></p>
<blockquote>
<div><div class="highlight-jsp"><div class="highlight"><pre> <span class="nt">&lt;form</span>  <span class="na">method=</span><span class="s">&quot;POST&quot;</span>
   <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/logout&quot;</span><span class="nt">&gt;</span>
<span class="hll">   <span class="nt">&lt;sec:csrfInput/&gt;</span>
</span>   <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Logout&quot;</span> <span class="nt">/&gt;</span>
 <span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>In this case as well, following HTML is output as before. CSRF token is set as hidden.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span>  <span class="na">method=</span><span class="s">&quot;POST&quot;</span>
  <span class="na">action=</span><span class="s">&quot;/your-context-path/logout&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">value=</span><span class="s">&quot;5826038f-0a84-495b-a851-c363e501b73b&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Logout&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
</div>
<div class="section" id="setting-sec-remember-me-element">
<h3><a class="toc-backref" href="#id24">6.3.2.8. Setting <tt class="docutils literal"><span class="pre">&lt;sec:remember-me&gt;</span></tt> element</a><a class="headerlink" href="#setting-sec-remember-me-element" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">&#8220;<a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#remember-me">Remember Me</a>&#8221; functionality enhances convenience of the frequent users of the website and,</div>
<div class="line">is the functionality that stores the login status.</div>
<div class="line">This functionality stores login information in a cookie, if user has given permission, even after the browser is closed</div>
<div class="line">and enables the user to login without re-entering the user name and password.</div>
</div>
<div class="line-block">
<div class="line">The attributes of <tt class="docutils literal"><span class="pre">&lt;sec:remember-me&gt;</span></tt> element are shown below.</div>
</div>
<p>spring-security.xml</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span> <span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- omitted --&gt;</span>
  <span class="nt">&lt;sec:remember-me</span> <span class="na">key=</span><span class="s">&quot;terasoluna-tourreservation-km/ylnHv&quot;</span>
          <span class="na">token-validity-seconds=</span><span class="s">&quot;#{30 * 24 * 60 * 60}&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- Perform steps (1) to (2) in the specified attribute order--&gt;</span>
  <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the unique key that stores the cookie for Remember Me functionality in <tt class="docutils literal"><span class="pre">key</span></tt> attribute.</div>
<div class="line">When not specified, it is recommended to specify it in cases where improvement in start-up time has been considered as the unique key is generated at the time of start-up.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the validity of the cookie for Remember Me functionality in seconds, in <tt class="docutils literal"><span class="pre">token-validity-seconds</span></tt> attribute. In this example it is set as 30 days.</div>
<div class="line">When not specified, it is valid for 14 days by default.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>For attributes other than the above, refer <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/reference/htmlsingle/#nsa-remember-me">Spring Security manual</a>.</p>
<p>Following flag that enables &#8220;Remember Me&#8221; functionality needs to be provided in login form.</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span>
  <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/authentication&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;_spring_security_remember_me&quot;</span><span class="nt">&gt;</span>Remember Me : <span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;_spring_security_remember_me&quot;</span>
      <span class="na">id=</span><span class="s">&quot;_spring_security_remember_me&quot;</span> <span class="na">type=</span><span class="s">&quot;checkbox&quot;</span>
<span class="hll">      <span class="na">checked=</span><span class="s">&quot;checked&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- (1) --&gt;</span>
</span><span class="hll">    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;LOGIN&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">    <span class="c">&lt;!-- omitted --&gt;</span>
</span><span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When requested as <tt class="docutils literal"><span class="pre">true</span></tt>, next authentication can be avoided</div>
<div class="line">by setting <tt class="docutils literal"><span class="pre">_spring_security_remember_me</span></tt> in HTTP parameter.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="how-to-extend">
<h2><a class="toc-backref" href="#id25">6.3.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="extending-userdetailsservice">
<span id="extendsuserdetailsservice"></span><h3><a class="toc-backref" href="#id26">6.3.3.1. Extending <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt></a><a class="headerlink" href="#extending-userdetailsservice" title="Permalink to this headline">Â¶</a></h3>
<div class="line-block">
<div class="line">When information other than user ID and password needs to be fetched at the time of authentication,</div>
</div>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.UserDetails</span></tt></li>
<li><tt class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.userDetailsService</span></tt></li>
</ul>
<p>need to be implemented.</p>
<p>When attached information such as login user&#8217;s name and division etc. need to be displayed at all times on screen header, fetching it for each request from DB hampers the efficiency.
This extension is necessary to enable its access from <tt class="docutils literal"><span class="pre">SecurityContext</span></tt> or <tt class="docutils literal"><span class="pre">&lt;sec:authentication&gt;</span></tt> tags, by storing it in <tt class="docutils literal"><span class="pre">UserDetails</span></tt> object.</p>
<div class="section" id="extending-userdetails">
<h4><a class="toc-backref" href="#id27">6.3.3.1.1. Extending <tt class="docutils literal"><span class="pre">UserDetails</span></tt></a><a class="headerlink" href="#extending-userdetails" title="Permalink to this headline">Â¶</a></h4>
<p>Creating <tt class="docutils literal"><span class="pre">ReservationUserDetails</span></tt> class that also stores customer information other than authentication information.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReservationUserDetails</span> <span class="kd">extends</span> <span class="n">User</span> <span class="o">{</span> <span class="c1">// (1)</span>
    <span class="c1">// omitted</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Customer</span> <span class="n">customer</span><span class="o">;</span> <span class="c1">// (2)</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">DEFAULT_AUTHORITIES</span> <span class="o">=</span> <span class="n">Collections</span>
            <span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">&quot;ROLE_USER&quot;</span><span class="o">));</span>         <span class="c1">// (3)</span>

    <span class="kd">public</span> <span class="nf">ReservationUserDetails</span><span class="o">(</span><span class="n">Customer</span> <span class="n">customer</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">customer</span><span class="o">.</span><span class="na">getCustomerCode</span><span class="o">(),</span>
                <span class="n">customer</span><span class="o">.</span><span class="na">getCustomerPassword</span><span class="o">(),</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">DEFAULT_AUTHORITIES</span><span class="o">);</span> <span class="c1">// (4)</span>
        <span class="k">this</span><span class="o">.</span><span class="na">customer</span> <span class="o">=</span> <span class="n">customer</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Customer</span> <span class="nf">getCustomer</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// (5)</span>
        <span class="k">return</span> <span class="n">customer</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Inherit <tt class="docutils literal"><span class="pre">org.springframework.security.core.userdetails.User</span></tt> class which is the default class of <tt class="docutils literal"><span class="pre">UserDetails</span></tt>.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Store the DomainObject class containing authentication information and customer information.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create authorization information using constructor of <tt class="docutils literal"><span class="pre">org.springframework.security.core.authority.SimpleGrantedAuthority</span></tt>. Here the authority named &#8220;ROLE_USER&#8221; is provided.</div>
<div class="line"><br /></div>
<div class="line">This is a simple implementation wherein the authorization information should essentially be fetched from another table in the DB.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set the user ID and password contained in DomainObject, in the constructor of super class.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Method to access customer information via <tt class="docutils literal"><span class="pre">UserDetails</span></tt>.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When the business requirement cannot be implemented just by inheriting <tt class="docutils literal"><span class="pre">User</span></tt> class, <tt class="docutils literal"><span class="pre">UserDetails</span></tt> interface may be implemented.</p>
</div>
</div>
<div class="section" id="implementing-an-independent-userdetailsservice">
<h4><a class="toc-backref" href="#id28">6.3.3.1.2. Implementing an independent <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt></a><a class="headerlink" href="#implementing-an-independent-userdetailsservice" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">Create ReservationUserDetailsService class that implements <tt class="docutils literal"><span class="pre">UserDetailsService</span></tt>.</div>
<div class="line">In this example, customer information is fetched from DB by injecting  <tt class="docutils literal"><span class="pre">CustomerSharedService</span></tt> class that implements the process to fetch <tt class="docutils literal"><span class="pre">Customer</span></tt> object.</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReservationUserDetailsService</span> <span class="kd">implements</span> <span class="n">UserDetailsService</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="n">CustomerSharedService</span> <span class="n">customerSharedService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="n">Customer</span> <span class="n">customer</span> <span class="o">=</span> <span class="n">customerSharedService</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="c1">// omitted</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ReservationUserDetails</span><span class="o">(</span><span class="n">customer</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id29">6.3.3.1.3. How to use</a><a class="headerlink" href="#id3" title="Permalink to this headline">Â¶</a></h4>
<p>How to use the created <tt class="docutils literal"><span class="pre">ReservationUserDetailsService</span></tt> and <tt class="docutils literal"><span class="pre">ReservationUserDetails</span></tt>, is explained here.</p>
<ul>
<li><p class="first">spring-security.xml</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sec:authentication-manager&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span> <span class="na">user-service-ref=</span><span class="s">&quot;userDetailsService&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;sec:password-encoder</span> <span class="na">ref=</span><span class="s">&quot;passwordEncoder&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/sec:authentication-provider&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;userDetailsService&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.example.domain.service.userdetails.ReservationUserDetailsService&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Sr. No.</p>
</th>
<th class="head"><p class="first last">Description</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define the Bean ID of <tt class="docutils literal"><span class="pre">ReservationUserDetailsService</span></tt> in ref attribute.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Perform Bean definition for <tt class="docutils literal"><span class="pre">ReservationUserDetailsService</span></tt>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">JSP</p>
<blockquote>
<div><p>Access <tt class="docutils literal"><span class="pre">Customer</span></tt> object by using <tt class="docutils literal"><span class="pre">&lt;sec:authentication&gt;</span></tt> tag.</p>
</div></blockquote>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;sec:authentication</span> <span class="na">property=</span><span class="s">&quot;principal.customer&quot;</span> <span class="na">var=</span><span class="s">&quot;customer&quot;</span><span class="nt">/&gt;</span><span class="c">&lt;!-- (1) --&gt;</span>
${f:h(customer.customerName)}<span class="c">&lt;!-- (1) --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Sr. No.</p>
</th>
<th class="head"><p class="first last">Description</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">Customer</span></tt> object contained in <tt class="docutils literal"><span class="pre">ReservationUserDetails</span></tt> is stored in variable.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Display the optional property of <tt class="docutils literal"><span class="pre">Customer</span></tt> object stored in variable.</div>
<div class="line">For <tt class="docutils literal"><span class="pre">f:h()</span></tt>, refer <a class="reference internal" href="XSS.html"><em>XSS Countermeasures</em></a>.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Controller</p>
<div class="highlight-java"><div class="highlight"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">view</span><span class="o">(</span><span class="n">Principal</span> <span class="n">principal</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// get Authentication</span>
    <span class="n">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="o">(</span><span class="n">Authentication</span><span class="o">)</span> <span class="n">principal</span><span class="o">;</span>
    <span class="c1">// get UserDetails</span>
    <span class="n">ReservationUserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="o">(</span><span class="n">ReservationUserDetails</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
    <span class="c1">// get Customer</span>
    <span class="n">Customer</span> <span class="n">customer</span> <span class="o">=</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getCustomer</span><span class="o">();</span> <span class="c1">// (1)</span>
    <span class="c1">// omitted ...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Sr. No.</p>
</th>
<th class="head"><p class="first last">Description</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Fetch the logged-in <tt class="docutils literal"><span class="pre">Customer</span></tt> object from <tt class="docutils literal"><span class="pre">ReservationUserDetails</span></tt>.</div>
<div class="line">Perform business process by passing this object to Service class.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>When customer information is changed, <tt class="docutils literal"><span class="pre">Customer</span></tt> object contained in <tt class="docutils literal"><span class="pre">ReservationUserDetails</span></tt> is not changed unless logout is carried out once.</p>
<p class="last">It is recommended not to store the information that may undergo frequent changes or the information which is changed by a user other than the login user (administrator etc.).</p>
</div>
</div>
</div>
<div class="section" id="extending-authenticationprovider">
<h3><a class="toc-backref" href="#id30">6.3.3.2. Extending <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt></a><a class="headerlink" href="#extending-authenticationprovider" title="Permalink to this headline">Â¶</a></h3>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Review the details.</p>
</div>
<div class="line-block">
<div class="line">In case of business requirements that cannot be supported by Spring Security&#8217;s <a class="reference external" href="http://docs.spring.io/spring-security/site/docs/3.2.5.RELEASE/apidocs/org/springframework/security/authentication/AuthenticationProvider.html">default authentication provider</a>,</div>
<div class="line">it is necessary to create the class that implements <tt class="docutils literal"><span class="pre">org.springframework.security.authentication.AuthenticationProvider</span></tt>.</div>
</div>
<div class="line-block">
<div class="line">It is necessary to return the class that implements <tt class="docutils literal"><span class="pre">org.springframework.security.core.Authentication</span></tt> as return value, in <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt>.</div>
<div class="line">It is necessary to set <tt class="docutils literal"><span class="pre">getPrincipal</span></tt> method (to fetch authentication information)</div>
<div class="line">and <tt class="docutils literal"><span class="pre">getCredentials</span></tt> method (to fetch information that guarantees validity of principal) in the class that implements  <tt class="docutils literal"><span class="pre">Authentication</span></tt>.</div>
</div>
<div class="line-block">
<div class="line">Here, the case that requires authentication information other than user name and password for authentication, is considered. To access these values in <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt>,
it is necessary to create a class that inherits.</div>
</div>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">org.springframework.security.authentication.UsernamePasswordAuthenticationToken</span></tt></li>
<li><tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter</span></tt></li>
</ul>
<div class="line-block">
<div class="line">An example with user name, <strong>Company identifier</strong> and password as the authentication information is shown below.</div>
</div>
<div class="figure">
<a class="reference internal image-reference" href="../_images/Authentication_HowToExtends_LoginForm.png"><img alt="Authentication_HowToExtends_LoginForm" src="../_images/Authentication_HowToExtends_LoginForm.png" style="width: 40%;" /></a>
</div>
<div class="section" id="extending-usernamepasswordauthenticationtoken">
<h4><a class="toc-backref" href="#id31">6.3.3.2.1. Extending <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationToken</span></tt></a><a class="headerlink" href="#extending-usernamepasswordauthenticationtoken" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">Create an independent <tt class="docutils literal"><span class="pre">AuthenticationToken</span></tt> that inherits <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationToken</span></tt>.</div>
<div class="line">By extending <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationToken</span></tt>, company identifier can be included in authentication information.</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// import omitted</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompanyIdUsernamePasswordAuthenticationToken</span> <span class="kd">extends</span>
                                                                 <span class="n">UsernamePasswordAuthenticationToken</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">SpringSecurityCoreVersion</span><span class="o">.</span><span class="na">SERIAL_VERSION_UID</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">companyId</span><span class="o">;</span>  <span class="c1">// (1)</span>

    <span class="kd">public</span> <span class="nf">CompanyIdUsernamePasswordAuthenticationToken</span><span class="o">(</span>
            <span class="n">Object</span> <span class="n">principal</span><span class="o">,</span> <span class="n">Object</span> <span class="n">credentials</span><span class="o">,</span> <span class="n">String</span> <span class="n">companyId</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// (2)</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span> <span class="n">credentials</span><span class="o">);</span>

        <span class="k">this</span><span class="o">.</span><span class="na">companyId</span> <span class="o">=</span> <span class="n">companyId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">CompanyIdUsernamePasswordAuthenticationToken</span><span class="o">(</span>
            <span class="n">Object</span> <span class="n">principal</span><span class="o">,</span> <span class="n">Object</span> <span class="n">credentials</span><span class="o">,</span> <span class="n">String</span> <span class="n">companyId</span><span class="o">,</span>
            <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="n">authorities</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// (3)</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span> <span class="n">credentials</span><span class="o">,</span> <span class="n">authorities</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">companyId</span> <span class="o">=</span> <span class="n">companyId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCompanyId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">companyId</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create a field for company identifier.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Constructor used while creating instance of <tt class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></tt>, before authentication.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Constructor used while creating instance of <tt class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></tt>, after successful authentication.</div>
<div class="line">Authentication completion status is reached by passing authorization information collectively, to the constructor argument of parent class.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="implementing-an-independent-authenticationprovider">
<h4><a class="toc-backref" href="#id32">6.3.3.2.2. Implementing an independent <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt></a><a class="headerlink" href="#implementing-an-independent-authenticationprovider" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">Using <tt class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></tt> in an independent <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt>.</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// import omitted</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompanyIdUsernamePasswordAuthenticationProvider</span> <span class="kd">implements</span>
                                                                    <span class="n">AuthenticationProvider</span> <span class="o">{</span>
    <span class="c1">// omitted</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Authentication</span> <span class="nf">authenticate</span><span class="o">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>

        <span class="n">CompanyIdUsernamePasswordAuthenticationToken</span> <span class="n">authenticationToken</span> <span class="o">=</span>
            <span class="o">(</span><span class="n">CompanyIdUsernamePasswordAuthenticationToken</span><span class="o">)</span> <span class="n">authentication</span><span class="o">;</span> <span class="c1">// (1)</span>

        <span class="c1">// Obtain userName, password, companyId</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">authenticationToken</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">authenticationToken</span><span class="o">.</span><span class="na">getCredentials</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">companyId</span> <span class="o">=</span> <span class="n">authenticationToken</span><span class="o">.</span><span class="na">getCompanyId</span><span class="o">();</span>

        <span class="c1">// Obtain user (and grants if needed) from database or other system</span>
        <span class="c1">// UserDetails userDetails = ...</span>

        <span class="c1">// Business logic</span>
        <span class="c1">// ...</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">userDetails</span><span class="o">,</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getCredentials</span><span class="o">(),</span>
                <span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="k">new</span> <span class="n">SimpleGrantedAuthority</span><span class="o">(</span><span class="s">&quot;ROLE_USER&quot;</span><span class="o">)));</span> <span class="c1">// (2)</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">CompanyIdUsernamePasswordAuthenticationToken</span><span class="o">.</span><span class="na">class</span>
                <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span> <span class="c1">// (3)</span>
    <span class="o">}</span>

    <span class="c1">// omitted</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Cast the <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></tt> in the independent <tt class="docutils literal"><span class="pre">AuthenticationToken</span></tt> which is set in extended class.</div>
<div class="line">For details, refer extension &lt;authentication_custom_usernamepasswordauthenticationfilter&gt; of <em class="xref std std-ref">UsernamePasswordAuthenticationFilter</em> which will be described later.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">After executing the authentication process (fetching user information, password check, company identifier check etc.),</div>
<div class="line">create and return <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationToken</span></tt>. By setting authorization information collectively in parameter,</div>
<div class="line">authenticated instance namely, <tt class="docutils literal"><span class="pre">AuthenticationToken</span></tt> is created. <tt class="docutils literal"><span class="pre">UserDetails</span></tt> is passed to constructor parameter as well.</div>
<div class="line"><br /></div>
<div class="line">In this example, only a single role is used as it is a simple implementation.</div>
<div class="line">For details on authority, refer <a class="reference internal" href="#userdetailsservice"><em>User information management class settings</em></a>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><tt class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></tt> class, which is an independent <tt class="docutils literal"><span class="pre">AuthenticationToken</span></tt></div>
<div class="line">should be supported.</div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="extending-usernamepasswordauthenticationfilter">
<span id="authentication-custom-usernamepasswordauthenticationfilter"></span><h4><a class="toc-backref" href="#id33">6.3.3.2.3. Extending <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></tt></a><a class="headerlink" href="#extending-usernamepasswordauthenticationfilter" title="Permalink to this headline">Â¶</a></h4>
<div class="line-block">
<div class="line">Create an independent <tt class="docutils literal"><span class="pre">AuthenticationFilter</span></tt> that inherits <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></tt>.</div>
<div class="line">By extending <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></tt>, <tt class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></tt> can be passed to</div>
<div class="line"><tt class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationProvider</span></tt>.</div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// import omitted</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompanyIdUsernamePasswordAuthenticationFilter</span> <span class="kd">extends</span>
                                                                  <span class="n">UsernamePasswordAuthenticationFilter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Authentication</span> <span class="nf">attemptAuthentication</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
            <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;POST&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">AuthenticationServiceException</span><span class="o">(</span><span class="s">&quot;Authentication method not supported: &quot;</span>
                    <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="c1">// Obtain UserName, Password, CompanyId</span>
        <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">obtainUsername</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">obtainPassword</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">companyId</span> <span class="o">=</span> <span class="n">obtainCompanyId</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

        <span class="c1">// username required</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">username</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">AuthenticationServiceException</span><span class="o">(</span><span class="s">&quot;UserName is required&quot;</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// validate password, companyId</span>

        <span class="c1">// omitted other process</span>

        <span class="n">CompanyIdUsernamePasswordAuthenticationToken</span> <span class="n">authRequest</span> <span class="o">=</span>
                <span class="k">new</span> <span class="nf">CompanyIdUsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">companyId</span><span class="o">);</span>  <span class="c1">// (1)</span>

        <span class="c1">// Allow subclasses to set the &quot;details&quot; property</span>
        <span class="n">setDetails</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">authRequest</span><span class="o">);</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">getAuthenticationManager</span><span class="o">().</span><span class="na">authenticate</span><span class="o">(</span><span class="n">authRequest</span><span class="o">);</span>  <span class="c1">// (2)</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="n">String</span> <span class="nf">obtainCompanyId</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&quot;j_companyid&quot;</span><span class="o">);</span>  <span class="c1">// (3)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Create an instance of <tt class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></tt></div>
<div class="line">in which the user name, password and company identifier fetched from <tt class="docutils literal"><span class="pre">HttpServletRequest</span></tt>, have been set.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set the unauthenticated  instance of <tt class="docutils literal"><span class="pre">CompanyIdUsernamePasswordAuthenticationToken</span></tt></div>
<div class="line">as the parameter of <tt class="docutils literal"><span class="pre">org.springframework.security.authentication.AuthenticationManager.authenticate</span></tt>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Company identifier is fetched from the request parameter.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Login information input check</strong></p>
<p class="last">Sometimes, a check needs to be performed in advance for the obvious input errors that occur when load reduction to DB server etc.is carried out.
In such cases, the input check process can be performed by extending <tt class="docutils literal"><span class="pre">UsernamePasswordAuthenticationFilter</span></tt>, similar to
<a class="reference internal" href="#authentication-custom-usernamepasswordauthenticationfilter"><em>Extending UsernamePasswordAuthenticationFilter</em></a>.</p>
</div>
</div>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id34">6.3.3.2.4. How to use</a><a class="headerlink" href="#id4" title="Permalink to this headline">Â¶</a></h4>
<ul>
<li><p class="first">Login form page (JSP)</p>
<p>Adding company identifier to <a class="reference internal" href="#form-login-jsp"><em>Creating login form</em></a> example.</p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/authentication&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;span&gt;</span>User Id<span class="nt">&lt;/span&gt;&lt;br&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span>
        <span class="na">id=</span><span class="s">&quot;username&quot;</span> <span class="na">name=</span><span class="s">&quot;j_username&quot;</span><span class="nt">&gt;&lt;br&gt;</span>
    <span class="nt">&lt;span&gt;</span>Company Id<span class="nt">&lt;/span&gt;&lt;br&gt;</span>
<span class="hll">    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span>
</span><span class="hll">        <span class="na">id=</span><span class="s">&quot;companyid&quot;</span> <span class="na">name=</span><span class="s">&quot;j_companyid&quot;</span><span class="nt">&gt;&lt;br&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
</span>    <span class="nt">&lt;span&gt;</span>Password<span class="nt">&lt;/span&gt;&lt;br&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span>
        <span class="na">id=</span><span class="s">&quot;password&quot;</span> <span class="na">name=</span><span class="s">&quot;j_password&quot;</span><span class="nt">&gt;&lt;br&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Sr. No.</p>
</th>
<th class="head"><p class="first last">Description</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify j_companyid for the input field &#8216;name&#8217; of company identifier.</div>
</div>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">spring-security.xml</p>
<div class="line-block">
<div class="line">Set the independent <tt class="docutils literal"><span class="pre">AuthenticationProvider</span></tt> and <tt class="docutils literal"><span class="pre">AuthenticationFilter</span></tt>.</div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;false&quot;</span> <span class="na">use-expressions=</span><span class="s">&quot;true&quot;</span> <span class="na">entry-point-ref=</span><span class="s">&quot;loginUrlAuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;sec:custom-filter</span> <span class="na">position=</span><span class="s">&quot;FORM_LOGIN_FILTER&quot;</span> <span class="na">ref=</span><span class="s">&quot;companyIdUsernamePasswordAuthenticationFilter&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (2) --&gt;</span>

    <span class="c">&lt;!-- omitted --&gt;</span>

    <span class="nt">&lt;sec:logout</span> <span class="na">logout-url=</span><span class="s">&quot;/logout&quot;</span> <span class="na">logout-success-url=</span><span class="s">&quot;/&quot;</span>
        <span class="na">delete-cookies=</span><span class="s">&quot;JSESSIONID&quot;</span> <span class="na">invalidate-session=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;companyIdUsernamePasswordAuthenticationFilter&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.example.app.common.security.CompanyIdUsernamePasswordAuthenticationFilter&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;authenticationManager&quot;</span> <span class="na">ref=</span><span class="s">&quot;authenticationManager&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;authenticationFailureHandler&quot;</span> <span class="na">ref=</span><span class="s">&quot;authenticationFailureHandler&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span> <span class="na">ref=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (6) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;filterProcessesUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;/authentication&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (7) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;loginUrlAuthenticationEntryPoint&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint&quot;</span><span class="nt">&gt;</span>  <span class="c">&lt;!-- (8) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">&quot;/login&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (9) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;sec:authentication-manager</span> <span class="na">alias=</span><span class="s">&quot;authenticationManager&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;sec:authentication-provider</span> <span class="na">ref=</span><span class="s">&quot;companyIdUsernamePasswordAuthenticationProvider&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (10) --&gt;</span>
<span class="nt">&lt;/sec:authentication-manager&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;companyIdUsernamePasswordAuthenticationProvider&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.example.app.common.security.CompanyIdUsernamePasswordAuthenticationProvider&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (11) --&gt;</span>

<span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Sr. No.</p>
</th>
<th class="head"><p class="first last">Description</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It is not possible to specify auto-config=&#8221;true&#8221; when &#8220;FORM_LOGIN_FILTER&#8221; is replaced in custom-filter element.</div>
<div class="line">Therefore, it is necessary either to delete the specified auto-config or specify auto-config=&#8221;false&#8221;.</div>
<div class="line">Further, entry-point-ref attribute needs to be specified clearly as the form-login element also cannot be specified.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">By specifying &#8220;FORM_LOGIN_FILTER&#8221; in the position attribute of custom-filter element,</div>
<div class="line">it can be replaced from UsernamePasswordAuthenticationFilter to CompanyIdUsernamePasswordAuthenticationFilter.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Perform bean definition for CompanyIdUsernamePasswordAuthenticationFilter.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the value for alias attribute of authentication-manager, in authenticationManager property.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the handler class to be called in case of authentication failure, in authenticationFailureHandler property.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the handler class to be called in case of successful authentication, in authenticationSuccessHandler property.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the path of authentication process in filterProcessesUrl property.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Define AuthenticationEntryPoint to be specified in the entry-point-ref attribute of http element.</div>
<div class="line">It is the default AuthenticationEntryPoint when form-login element was specified.</div>
<div class="line">Perform bean definition of <tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint</span></tt>.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify the login screen path in constructor argument.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Perform reference configuration CompanyIdUsernamePasswordAuthenticationProvider in authentication-provider element.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Perform bean definition of CompanyIdUsernamePasswordAuthenticationProvider.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">To use <tt class="docutils literal"><span class="pre">&lt;sec:http-basic&gt;</span></tt> and <tt class="docutils literal"><span class="pre">&lt;sec:logout&gt;</span></tt> elements wherein auto-config=&#8221;false&#8221; has been specified, they need to be clearly defined.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="appendix">
<h2><a class="toc-backref" href="#id35">6.3.4. Appendix</a><a class="headerlink" href="#appendix" title="Permalink to this headline">Â¶</a></h2>
<div class="line-block">
<div class="line">When performing authentication using Spring Security, transit to the path described in configuration file when authentication is successful.</div>
<div class="line">When there is a business requirement such as &#8220;login to read more&#8221;,</div>
<div class="line">sometimes the transition destination after login needs to be changed dynamically.</div>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/Authentication_Appendix_ScreenFlow.png"><img alt="Authentication_Appendix_Screen_Flow" src="../_images/Authentication_Appendix_ScreenFlow.png" style="width: 60%;" /></a>
<p class="caption"><strong>Picture - Screen_Flow</strong></p>
</div>
<div class="line-block">
<div class="line">In such cases, use <tt class="docutils literal"><span class="pre">org.terasoluna.gfw.web.security.RedirectAuthenticationHandler</span></tt></div>
<div class="line">provided by common library.</div>
</div>
<div class="line-block">
<div class="line">Setting example using RedirectAuthenticationHandler is shown below.</div>
</div>
<p><strong>Description example of source screen JSP</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/login&quot;</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- omitted --&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;redirectTo&quot;</span>
    <span class="na">value=</span><span class="s">&quot;${pageContext.request.contextPath}/reservetour/read?</span>
<span class="s">    ${f:query(reserveTourForm)}&amp;page.page=${f:h(param[&#39;page.page&#39;])}</span>
<span class="s">    &amp;page.size=${f:h(param[&#39;page.size&#39;])}&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Setting redirect URL</div>
<div class="line">Set the transition destination URL in the hidden &#8220;redirectTo&#8221; field.</div>
<div class="line">The value specified in name should be matched with targetUrlParameter</div>
<div class="line">described in configuration file explained later.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>Description example of login screen JSP</strong></p>
<div class="highlight-jsp"><div class="highlight"><pre><span class="nt">&lt;form:form</span> <span class="na">action=</span><span class="s">&quot;${pageContext.request.contextPath}/authentication&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
     <span class="c">&lt;!-- omitted --&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span>
       <span class="na">value=</span><span class="s">&quot;Login&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;redirectTo&quot;</span> <span class="na">value=</span><span class="s">&quot;${f:h(param.redirectTo)}&quot;</span> <span class="nt">/&gt;</span>  <span class="c">&lt;!-- (1) --&gt;</span>
     <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/form:form&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set redirect URL</div>
<div class="line">Set the redirect URL passed from source screen using request parameter,</div>
<div class="line">to hidden field.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p><strong>Spring Security configuration file</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;sec:http</span> <span class="na">auto-config=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
                <span class="c">&lt;!-- omitted --&gt;</span>
    <span class="nt">&lt;sec:form-login</span> <span class="na">login-page=</span><span class="s">&quot;/login&quot;</span> <span class="na">default-target-url=</span><span class="s">&quot;/&quot;</span>
        <span class="na">always-use-default-target=</span><span class="s">&quot;false&quot;</span>
        <span class="na">authentication-failure-handler-ref=</span><span class="s">&quot;authenticationFailureHandler&quot;</span>
        <span class="na">authentication-success-handler-ref=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span> <span class="nt">/&gt;</span>
                                                                    <span class="c">&lt;!-- (1) --&gt;</span>
                <span class="c">&lt;!-- omitted --&gt;</span>
<span class="nt">&lt;/sec:http&gt;</span>

 <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;authenticationSuccessHandler&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.terasoluna.gfw.web.security.RedirectAuthenticationHandler&quot;</span><span class="nt">&gt;</span>
                                                                    <span class="c">&lt;!-- (2) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;targetUrlParameter&quot;</span> <span class="na">value=</span><span class="s">&quot;redirectTo&quot;</span><span class="nt">/&gt;</span>        <span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;authenticationFailureHandler&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler&quot;</span><span class="nt">&gt;</span>
                                                                    <span class="c">&lt;!-- (4) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultFailureUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;/login?error=true&quot;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- (5) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;useForward&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>                     <span class="c">&lt;!-- (6) --&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
                <span class="c">&lt;!-- omitted --&gt;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Sr. No.</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Specify BeanId of authentication-failure-handler-ref (handler setting at the time of authentication error) and</div>
<div class="line">authentication-success-handler-ref (handler setting in case of successful authentication).</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set <tt class="docutils literal"><span class="pre">org.terasoluna.gfw.web.security.RedirectAuthenticationHandler</span></tt></div>
<div class="line">as the reference class of authentication-success-handler-ref.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">It should be matched with the value described in hidden field of JSP.</div>
<div class="line">In this example, it is set as &#8220;redirectTo&#8221;. When omitted, &#8220;redirectTo&#8221; is set.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set <tt class="docutils literal"><span class="pre">org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler</span></tt></div>
<div class="line">as reference class of authentication-failure-handler-ref.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Set the query indicating error and path of login screen, in the transition destination path of failed authentication.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">When using this function, true should be specified in useForward.</div>
<div class="line">By specifying true, it becomes a forward transition from a redirect transition.</div>
<div class="line">Since URL of redirect destination is stored in request parameter,</div>
<div class="line">it is necessary to ensure that request parameter is stored as it is by setting it to &#8220;forward&#8221;.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Measures against Open Redirector vulnerability are provided in the RedirectAuthenticationHandler.
Therefore, it cannot transit to external sites such as &#8220;<a class="reference external" href="http://google.com">http://google.com</a>&#8221;, without extending.
In order to move to other domain, it is necessary to create the class implementing <tt class="docutils literal"><span class="pre">org.springframework.security.web.RedirectStrategy</span></tt>.
The class implementing RedirectStrategy in targetUrlParameterRedirectStrategy of RedirectAuthenticationHandler, is set using setter injection.
As a precaution while extending, it is necessary to have a structure that does not pose any problems even if the redirectTo value is tampered with.
For example, any one of the measures such as checking redirect destination domain or specifying redirect destination URL by number (specifying the page number)
instead of specifying it directly, need to be taken.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="PasswordHashing.html" title="6.4. Password Hashing"
             >next</a> |</li>
        <li class="right" >
          <a href="Tutorial.html" title="6.2. Spring Security Tutorial"
             >previous</a> |</li>
        <li><a href="../index.html">TERASOLUNA Global Framework Development Guideline 1.1.0-SNAPSHOT documentation</a> &raquo;</li>
          <li><a href="index.html" >6. Security for TERASOLUNA Global Framework</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2014, NTT DATA.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46550814-1', 'terasolunaorg.github.io');
    ga('send', 'pageview');
    </script>
  </body>
</html>